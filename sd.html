<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿å²›æµ·Â·ä¸‰é˜¶æ ¡å‡†æ³•Â·åˆé˜¶é—ªç”µç®— - V18.1</title>
    <style>
        /* =========================================================================
         * A. é¢œè‰²å˜é‡ä¸ä¸“ä¸šç¾å­¦åŸºç¡€
         * ========================================================================= */
        :root {
            --color-dark: #2c3e50; /* æ·±è“ç° - ä¸»è¦æ–‡æœ¬/å®¹å™¨ */
            --color-light-bg: #f9fbfd; /* ææµ…èƒŒæ™¯ */
            --color-card-bg: #ffffff; /* å¡ç‰‡èƒŒæ™¯ */
            --color-border: #e0e6ed; /* æµ…è¾¹æ¡† */
            --color-accent-base: #3498db; /* åŸºç¡€ä¸“ä¸šè“ */
            --color-accent-r1: #2980b9; /* é˜¶æ®µ1ï¼šæ·±è“ */
            --color-accent-r2: #16a085; /* é˜¶æ®µ2ï¼šå¢¨ç»¿ */
            --color-accent-r3: #e67e22; /* é˜¶æ®µ3ï¼šç¨³å®šæ©™ */
            --color-warning: #e74c3c; /* è­¦ç¤ºçº¢ - æœ€ç»ˆé¢œè‰² */
            --color-highlight: #f1c40f; /* é»„é‡‘è‰² - è¯„ä»· */
            --border-radius: 6px;
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.05);
            --current-accent: var(--color-accent-r1); /* åŠ¨æ€é˜¶æ®µè‰² */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', 'Arial', sans-serif, 'Microsoft YaHei', 'SimHei';
        }
        
        body {
            background-color: var(--color-light-bg);
            color: var(--color-dark);
            line-height: 1.6;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        
        /* --- æ ¸å¿ƒç»“æ„ï¼šåŒé¢æ¿å¸ƒå±€ --- */
        .main-container {
            display: flex;
            max-width: 1400px; 
            width: 100%;
            gap: 20px;
        }
        
        .panel {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--color-border);
            padding: 25px;
        }
        
        .controls-panel {
            flex: 2; 
        }
        
        .results-panel {
            flex: 1; 
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        /* --- æ ‡é¢˜ä¸ä¿¡æ¯å¡ --- */
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--color-dark);
            font-size: 2.2em;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-border);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 18px;
            color: var(--current-accent);
            padding-bottom: 5px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-card {
            background-color: #f7f9fc; 
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-bottom: 25px;
            border-left: 4px solid var(--current-accent);
            line-height: 1.8;
            font-size: 0.95em;
        }
        
        /* --- é˜¶æ®µè¾“å…¥åŒº --- */
        .phase-section {
            padding: 20px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            background-color: var(--color-card-bg);
        }
        
        /* --- è¿œè¿‘çº¬åº¦ (å‚ç›´å †å ) - ç§»é™¤æ•°å­—ï¼Œèšç„¦æ ‡ç­¾ --- */
        .distance-buttons {
            display: flex; 
            flex-direction: column;
            gap: 10px; 
            margin-top: 15px;
        }
        
        .distance-btn {
            width: 100%; 
            padding: 15px 15px; 
            border: 2px solid var(--color-border);
            background-color: #ffffff;
            font-size: 1.0em; 
            transition: all 0.3s ease;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: left; 
            display: flex;
            align-items: center;
            justify-content: center; /* æŒ‰é’®å†…å®¹å±…ä¸­ */
            line-height: 1.3;
        }

        .distance-btn:hover:not(:disabled) {
            border-color: var(--color-accent-base);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        .distance-btn.active {
            border-color: var(--current-accent);
            background-color: #eaf1f7; 
            color: var(--color-dark);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        /* éšè—åº¦æ•°æ ‡ç­¾ */
        .btn-degree {
            display: none;
        }

        /* æå‡ä¸­æ–‡æ ‡ç­¾çš„è§†è§‰æƒé‡ */
        .btn-label {
            font-size: 1.2em; /* å¢å¤§å­—ä½“ï¼Œä½¿å…¶æˆä¸ºä¸»è¦å†…å®¹ */
            font-weight: 700; /* ç²—ä½“ */
            color: var(--color-dark); /* ä½¿ç”¨æ·±è‰² */
            margin: 0; /* ç§»é™¤è¾¹è· */
            flex-grow: unset; 
            text-align: center; /* æ–‡æœ¬å±…ä¸­ */
        }
        
        .distance-btn.active .btn-label {
            color: var(--current-accent); /* é€‰ä¸­æ—¶ä½¿ç”¨å¼ºè°ƒè‰² */
        }
        
        /* å¿«æ…¢çº¬åº¦ æ»‘å—å’Œæ˜Ÿçº§ä¿æŒ v15.3 ä¼˜åŒ– */
        .dimension-value {
             font-size: 1.8em;
             font-weight: 700;
             color: var(--current-accent);
        }
        
        .slider-container {
            padding: 15px 0; 
        }
        
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px; 
            background: #ddd;
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px; 
            height: 24px; 
            background: var(--current-accent);
            border-radius: 50%;
            cursor: grab;
            border: 4px solid var(--color-card-bg); 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-moz-range-thumb {
             width: 24px;
             height: 24px;
             background: var(--current-accent);
             border-radius: 50%;
             cursor: grab;
             border: 4px solid var(--color-card-bg);
             box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        .stars-container {
            display: flex; 
            justify-content: center;
            gap: 15px; 
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .star {
            font-size: 3em; 
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .star.active {
            color: var(--color-highlight); 
            text-shadow: 0 0 8px rgba(241, 196, 15, 0.6); 
        }
        
        /* --- åŠ¨ä½œæŒ‰é’® (ä¿æŒ v15.3 ä¼˜åŒ–) --- */
        .action-buttons {
            display: flex;
            gap: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
            justify-content: center;
            margin-top: 10px;
        }
        
        .action-btn {
            padding: 12px 30px; 
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .apply-btn {
            background-color: var(--current-accent); 
            color: var(--color-card-bg); 
        }
        
        .apply-btn:hover:not(:disabled) {
            background-color: var(--color-accent-base); 
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .apply-btn:disabled {
            background-color: #bdc3c7; 
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .reset-btn {
            background-color: transparent;
            border: 2px solid #ccc;
            color: var(--color-dark);
        }
        
        .reset-btn:hover {
            border-color: var(--color-warning);
            color: var(--color-warning);
        }

        /* --- å•ä½åˆ‡æ¢æŒ‰é’® (ä¿æŒ v15.3 ä¼˜åŒ–) --- */
        .unit-toggle {
            display: flex;
            background-color: #eef3f7; 
            border-radius: var(--border-radius);
            padding: 3px;
            border: 1px solid #dcdcdc; 
            margin-left: 20px; 
        }
        
        .unit-toggle button {
            flex: 1;
            padding: 10px 15px; 
            border: none;
            background: transparent;
            border-radius: calc(var(--border-radius) - 2px);
            cursor: pointer;
            font-size: 0.95em; 
            transition: all 0.2s ease;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .unit-toggle button.active {
            background-color: var(--color-card-bg);
            color: var(--color-dark);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
            font-weight: 700;
        }
        
        /* --- DPI è¾“å…¥ (ä¿æŒ v15.3 ä¼˜åŒ–) --- */
        .dpi-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            margin-bottom: 20px;
            gap: 15px;
        }
        .dpi-input-group input {
            padding: 10px 12px; 
            border: 2px solid var(--color-border); 
            border-radius: var(--border-radius);
            width: 120px; 
            text-align: center;
            font-size: 1.2em; 
            transition: border-color 0.3s;
        }

        .dpi-input-group input:focus {
            outline: none;
            border-color: var(--color-accent-base);
        }
        
        /* --- ä¸»çµæ•åº¦å¡ç‰‡ (Result Panel) - é¢œè‰²éšé˜¶æ®µå˜åŒ– --- */
        .main-sens-card {
            background-color: #f7f9fc; 
            border-radius: var(--border-radius);
            padding: 20px 10px;
            margin: 15px 0 25px 0; 
            border-left: 5px solid var(--current-accent); /* åŠ¨æ€é¢œè‰²è¾¹æ¡† */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        /* æµç¨‹ç»ˆç»“æ—¶å¼ºåˆ¶ä½¿ç”¨çº¢è‰² */
        .main-sens-card.finalized {
            border-left-color: var(--color-warning) !important;
        }
        
        .sensitivity-value {
            font-size: 3.8em; 
            font-weight: 800;
            text-align: center;
            margin: 5px 0;
            transition: color 0.3s;
            color: var(--color-dark); /* é»˜è®¤æ·±è‰² */
        }
        
        /* æœ€ç»ˆç»“æœæ—¶é¢œè‰²ä¸ºçº¢è‰² */
        .sensitivity-value.final-result {
            color: var(--color-warning); 
            animation: none; 
        }

        .sensitivity-range {
            text-align: center;
            color: #666;
            font-size: 1.0em;
            margin-bottom: 5px;
        }
        
        /* --- æ¸¸æˆçµæ•åº¦å¡ç‰‡ --- */
        .game-sens-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px; 
            margin-top: 20px;
        }
        .game-sens-card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
            transition: border-color 0.2s;
        }
        .game-sens-card:hover {
            border-color: #bdc3c7;
        }
        .game-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #95a5a6;
            margin-bottom: 5px;
        }
        .game-sens-value {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--color-dark);
            line-height: 1.2;
        }
        .game-sens-hint {
            font-size: 0.8em;
            color: #bdc3c7;
            margin-top: 5px;
        }

        /* =========================================================================
         * æ–°å¢ï¼šæ‚¬æµ®çª—æ ·å¼ (æ”¹ä¸º Fixed å®šä½)
         * ========================================================================= */
        .floating-help-btn {
            /* å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ fixed å®šä½ï¼Œä½¿å…¶ç‹¬ç«‹äºæ–‡æ¡£æµ */
            position: fixed; 
            right: 20px; /* è·ç¦»è§†å£å³ä¾§ 20px */
            bottom: 20px; /* è·ç¦»è§†å£åº•éƒ¨ 20px */
            
            z-index: 1000; /* ç¡®ä¿æ‚¬æµ®åœ¨å…¶ä»–å†…å®¹ä¹‹ä¸Š */
            
            /* ä¿æŒåŸæœ‰é£æ ¼å’Œå°ºå¯¸ */
            padding: 12px 18px; /* ç•¥å¾®è°ƒæ•´å®½åº¦ */
            width: auto; /* å®½åº¦è‡ªé€‚åº”å†…å®¹ */
            white-space: nowrap; 
            
            text-align: center;
            background-color: var(--color-accent-base); /* ä½¿ç”¨åŸºç¡€è“ */
            color: var(--color-card-bg); /* ç™½è‰²æ–‡å­— */
            text-decoration: none; /* ç§»é™¤ä¸‹åˆ’çº¿ */
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1.0em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* æå‡æµ®åŠ¨æ„Ÿå’Œé˜´å½±æ·±åº¦ */
            transition: all 0.3s ease;
            border: 1px solid var(--color-accent-base);
        }

        .floating-help-btn:hover {
            background-color: var(--color-accent-r1); /* æ‚¬åœæ—¶ä½¿ç”¨æ·±è“ */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px); /* è½»å¾®ä¸Šæµ® */
        }
        
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="panel controls-panel" id="main-container">
            <h1>è¥¿å²›æµ· Â· FPSæ¸¸æˆ çµæ•åº¦é—ªç”µç®—</h1>
            
            <div class="info-card">
                <p><strong>å…¨å±€è®¾å®šèŒƒå›´:</strong> 5cm/25.3125&deg; (æœ€æ…¢) åˆ° 5cm/50.625&deg; (æœ€å¿«)</p>
                <p class="step-info"><strong>PerCM æ­¥é•¿ (Adjustment Â°/1cm):</strong> <span id="current-base-d-step">0.0000</span></p> 
                <p class="step-info"><strong>ç²¾å¯†è°ƒæ•´åŒºé—´ (ç¡¬æ€§é”å®š S<sub>-2</sub> åˆ° S<sub>+1</sub>):</strong> <span id="precision-range-display">è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦</span></p>
            </div>
            
            <div id="adjustment-controls">
                <div id="distance-phase" class="phase-section">
                    <div class="section-title">é˜¶æ®µ 1/3: è¿œè¿‘çº¬åº¦é€‰æ‹© (åŸºç¡€è®¾å®š)</div>
                    <div class="distance-buttons">
                        <button class="distance-btn" data-value="25.3125">
                            <span class="btn-degree">25.3125&deg;</span>
                            <span class="btn-label">æœ€è¿œï¼ˆæˆ–ç›®æ ‡æœ€å°ï¼‰</span>
                        </button>
                        
                        <button class="distance-btn" data-value="28.125">
                            <span class="btn-degree">28.125&deg;</span>
                            <span class="btn-label">è¿œ</span>
                        </button>
                        
                        <button class="distance-btn" data-value="30.9375">
                            <span class="btn-degree">30.9375&deg;</span>
                            <span class="btn-label">ä¸­è¿œ</span>
                        </button>
                        
                        <button class="distance-btn" data-value="33.75">
                            <span class="btn-degree">33.75&deg;</span>
                            <span class="btn-label">ä¸­</span>
                        </button>
                        
                        <button class="distance-btn" data-value="39.375">
                            <span class="btn-degree">39.375&deg;</span>
                            <span class="btn-label">ä¸­è¿‘</span>
                        </button>
                        
                        <button class="distance-btn" data-value="45">
                            <span class="btn-degree">45&deg;</span>
                            <span class="btn-label">è¿‘</span>
                        </button>
                        
                        <button class="distance-btn" data-value="50.625">
                            <span class="btn-degree">50.625&deg;</span>
                            <span class="btn-label">è´´è„¸ï¼ˆæˆ–ç›®æ ‡æœ€å¤§ï¼‰</span>
                        </button>
                    </div>
                </div>

                <div id="adjustment-input-area">
                    <div id="speed-phase" class="phase-section" style="display: none;">
                        <div class="section-title">é˜¶æ®µ 2/3: å¿«æ…¢çº¬åº¦è°ƒèŠ‚ (å½“å‰è½®æ¬¡: <span id="adjustment-count-display">0</span>)</div>
                        <div class="dimension">
                            <div class="dimension-header">
                                <span class="dimension-name">è°ƒæ•´å¹…åº¦ [-7 è‡³ +7]</span>
                                <span class="dimension-value" id="speed-value">0</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" min="-7" max="7" value="0" class="slider" id="speed-slider">
                            </div>
                            <div class="slider-labels" style="display:flex; justify-content:space-between; font-size:0.9em; color:#999;">
                                <span>æƒ³å¿«ç‚¹</span>
                                <span>æƒ³æ…¢ç‚¹</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="usability-phase" class="phase-section" style="display: none;">
                        <div class="section-title">é˜¶æ®µ 3/3: å¥½ç”¨çº¬åº¦è¯„ä»· (è¯·å¯¹ç»“æœåšå‡ºå†³ç­–)</div>
                        <div class="dimension-header" style="justify-content: center;">
                            <span class="dimension-name">è¯·å¯¹å½“å‰çµæ•åº¦è¿›è¡Œè¯„ä»· (æ»¡åˆ† 3 æ˜Ÿ)</span>
                        </div>
                        <div class="stars-container" id="stars-container">
                            <div class="star" data-rating="1">â˜…</div>
                            <div class="star active" data-rating="2">â˜…</div>
                            <div class="star" data-rating="3">â˜…</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" id="action-buttons" style="display: none;">
                <button class="action-btn apply-btn" id="apply-btn" disabled>åº”ç”¨è°ƒæ•´</button>
                <button class="action-btn reset-btn" id="reset-btn">é‡ç½®ç³»ç»Ÿ</button>
            </div>
        </div>

        <div class="panel results-panel">
             <div class="result-section">
                <div class="dimension-header" style="align-items: center;">
                    <h2 style="font-size:1.5em; color:var(--color-dark);">å®æ—¶çµæ•åº¦ç›‘æµ‹</h2>
                    <div class="unit-toggle">
                        <button class="unit-btn" id="cm5-unit">5cm/å¤šå°‘&deg;</button>
                        <button class="unit-btn active" id="cm360-unit">cm/360&deg;</button>
                    </div>
                </div>
                
                <div class="main-sens-card">
                    <div class="sensitivity-value" id="sensitivity-result">è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦</div> 
                    <div class="sensitivity-range" id="sensitivity-range"></div>
                </div>
            </div>

            <div class="dpi-input-group">
                <label for="dpi-input">å½“å‰ DPI:</label>
                <input type="number" id="dpi-input" value="400" min="100" step="100" oninput="updateDisplay()">
            </div>

            <div class="game-sensitivity-display">
                <div class="section-title" style="text-align: center; margin-bottom: 10px;">ğŸ® æ¸¸æˆçµæ•åº¦å®æ—¶æ¢ç®— (DPI: <span id="current-dpi-display">400</span>)</div>
                <div class="game-sens-grid">
                    <div class="game-sens-card">
                        <div class="game-name">CS / Apex</div>
                        <div class="game-sens-value" id="sens-cs">N/A</div>
                        <div class="game-sens-hint">çµæ•åº¦ (m_yaw=0.022)</div>
                    </div>
                    <div class="game-sens-card">
                        <div class="game-name">Valorant</div>
                        <div class="game-sens-value" id="sens-val">N/A</div>
                        <div class="game-sens-hint">çµæ•åº¦ (m_yaw=0.07)</div>
                    </div>
                    <div class="game-sens-card">
                        <div class="game-name">Overwatch</div>
                        <div class="game-sens-value" id="sens-ow">N/A</div>
                        <div class="game-sens-hint">çµæ•åº¦ (m_yaw=0.0066)</div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <a href="https://space.bilibili.com/1534330" class="floating-help-btn" target="_blank">
        ä½œè€…ï¼šè¥¿å²›æµ·_xlm
    </a>

    <script>
        // =========================================================================
        // A. å¸¸é‡ä¸çŠ¶æ€å˜é‡ (æ ¸å¿ƒæ•°æ®)
        // =========================================================================

        const MAX_ADJUSTMENTS = 2; // å¿«æ…¢è°ƒæ•´ä¸Šé™ä¸º 2 æ¬¡ 
        // ä¿®æ­£æ³¨é‡Šï¼š25.3125Â° å¯¹åº” cm/360Â° è¶Šå¤§ï¼Œè¶Šæ…¢
        const MIN_DEGREES = 25.3125;  // æœ€è¿œ / ææ…¢ - å…¨å±€ç¡¬æ€§ä¸‹é™
        const MAX_DEGREES = 50.625; // è´´è„¸ / æå¿« - å…¨å±€ç¡¬æ€§ä¸Šé™
        const TOLERANCE = 0.0001; 
        
        const ALL_STEPS = [
            25.3125, 28.125, 30.9375, 
            33.75, 
            39.375, 45, 50.625
        ];
        
        // ç”¨æˆ·æä¾›çš„æ¢ç®—å¸¸æ•° (360 * 2.54 / m_yaw)
        const CONST_CS = 41563.636; 
        const CONST_VAL = 13062.857;
        const CONST_OW = 138545.455;
        
        const PHASE_COLORS = {
            0: 'var(--color-accent-r1)', // AC=1 çš„é¢œè‰²
            1: 'var(--color-accent-r2)', // AC=2 çš„é¢œè‰²
            2: 'var(--color-accent-r3)'
        };
        
        let currentPhase = 'distance'; 
        let currentDegreesFor5cm = 0; 
        let adjustmentCounter = 0; // å½“å‰å·²å®Œæˆçš„è°ƒæ•´è½®æ¬¡è®¡æ•° (ä¸Šé™ä¸º 2)
        let currentStarRating = 2; // é»˜è®¤ 2 æ˜Ÿ
        let isFinalized = false;
        let lastSpeedPhaseResult = null; 
        let initialDegrees = 0; // è®°å½•æœ€åˆé€‰æ‹©çš„è¿œè¿‘çº¬åº¦å€¼
        
        let PRECISION_MIN = MIN_DEGREES; 
        let PRECISION_MAX = MAX_DEGREES; 
        
        const rootElement = document.documentElement;
        const distanceButtons = document.querySelectorAll('.distance-btn');
        const usabilityStars = document.querySelectorAll('#stars-container .star');
        const speedSlider = document.getElementById('speed-slider');
        const applyBtn = document.getElementById('apply-btn');
        const sensitivityResult = document.getElementById('sensitivity-result');
        const precisionRangeDisplay = document.getElementById('precision-range-display');
        const dpiInput = document.getElementById('dpi-input');
        const sensCS = document.getElementById('sens-cs');
        const sensVal = document.getElementById('sens-val');
        const sensOW = document.getElementById('sens-ow');
        const currentDpiDisplay = document.getElementById('current-dpi-display');
        const cm5UnitBtn = document.getElementById('cm5-unit');
        const cm360UnitBtn = document.getElementById('cm360-unit');


        // =========================================================================
        // B. æ ¸å¿ƒè®¡ç®—å‡½æ•°
        // =========================================================================
        
        /** æŸ¥æ‰¾å¹¶è®¾ç½®ç¡¬æ€§ç²¾å¯†è°ƒæ•´åŒºé—´è¾¹ç•Œ (V18.0: é‡æ–°æ¤å…¥æå€¼éš”ç¦»é€»è¾‘) */
        function setHardPrecisionBounds(S0) {
            
            const index = ALL_STEPS.findIndex(step => Math.abs(step - S0) < TOLERANCE);
            
            // æ‰¾ä¸åˆ° S0ï¼Œä½¿ç”¨å…¨å±€ç¡¬æ€§è¾¹ç•Œï¼Œå¹¶è¿”å›
            if (index === -1) {
                PRECISION_MIN = MIN_DEGREES;
                PRECISION_MAX = MAX_DEGREES;
                return;
            }
            
            // 1. æœ€è¿œè·ç¦» (25.3125, Index 0) - éš”ç¦»å¤„ç† (åªèƒ½å‘å¿«/å¤§åº¦æ•°è°ƒæ•´ S+1)
            if (Math.abs(S0 - MIN_DEGREES) < TOLERANCE) {
                PRECISION_MIN = S0; // æ…¢ç«¯ï¼ˆå·¦ä¾§ï¼‰é”å®šåœ¨è‡ªå·±
                PRECISION_MAX = ALL_STEPS[Math.min(ALL_STEPS.length - 1, index + 1)]; // å¿«ç«¯ï¼ˆå³ä¾§ï¼‰é”å®šåœ¨ S+1
                return;
            }

            // 2. è´´è„¸è·ç¦» (50.625, Index 6) - éš”ç¦»å¤„ç† (åªèƒ½å‘æ…¢/å°åº¦æ•°è°ƒæ•´ S-2)
            if (Math.abs(S0 - MAX_DEGREES) < TOLERANCE) {
                PRECISION_MIN = ALL_STEPS[Math.max(0, index - 2)]; // æ…¢ç«¯ï¼ˆå·¦ä¾§ï¼‰é”å®šåœ¨ S-2
                PRECISION_MAX = S0; // å¿«ç«¯ï¼ˆå³ä¾§ï¼‰é”å®šåœ¨è‡ªå·±
                return;
            }

            // 3. å…¶ä»–è·ç¦» - æ ‡å‡†å¤„ç† (S-2 åˆ° S+1)
            // å¾€æ…¢ (Degreeså‡å°ï¼ŒPerCMå‡å°) - é™åˆ¶åˆ° I - 2 (S-2)
            PRECISION_MIN = ALL_STEPS[Math.max(0, index - 2)]; 

            // å¾€å¿« (Degreeså¢å¤§ï¼ŒPerCMå¢å¤§) - é™åˆ¶åˆ° I + 1 (S+1)
            PRECISION_MAX = ALL_STEPS[Math.min(ALL_STEPS.length - 1, index + 1)]; 
        }

        /** è½¬æ¢ä¸º cm/360Â° */
        function toCM360(degrees) {
            // cm/360Â° = (5cm * 360Â°) / XÂ°
            return degrees === 0 ? Infinity : (5 * 360) / degrees;
        }

        /** è½¬æ¢ä¸º 5cm/å¤šå°‘Â° */
        function toDegreesFor5cm(cm360) {
            // 5cm/å¤šå°‘Â° = (5 * 360) / cm360
            return cm360 === Infinity ? 0 : (5 * 360) / cm360;
        }

        /** è®¡ç®—æ¯å˜ç±³åº¦æ•°å˜åŒ–åŠæ­¥é•¿ (åŸºäºPerCMå‡åˆ†) */
        function calculatePerCMChange() {
            if (currentDegreesFor5cm === 0) {
                return { 
                    currentPerCM: 0, 
                    P_MIN_PerCM: 0, 
                    P_MAX_PerCM: 0,
                    leftStepChange: 0, 
                    rightStepChange: 0
                };
            }
            
            const currentCM360 = toCM360(currentDegreesFor5cm);
            
            // PerCM (Degrees/1cm) = 360 / cm360
            const currentPerCM = 360 / currentCM360; 
            
            // P_MIN_PerCM (æ…¢æé™): å¯¹åº” PRECISION_MIN (åº¦æ•°æœ€å°ï¼ŒPerCMæœ€å°)
            const P_MIN_PerCM = (360 / toCM360(PRECISION_MIN)); 
            
            // P_MAX_PerCM (å¿«æé™): å¯¹åº” PRECISION_MAX (åº¦æ•°æœ€å¤§ï¼ŒPerCMæœ€å¤§)
            const P_MAX_PerCM = (360 / toCM360(PRECISION_MAX)); 
            
            // leftStepChange: è°ƒæ•´åˆ°æ…¢æé™ P_MIN æ‰€éœ€è¦çš„ PerCM æ­¥é•¿ (åº”ä¸ºè´Ÿå€¼)
            const leftStepChange = (P_MIN_PerCM - currentPerCM) / 7; 

            // rightStepChange: è°ƒæ•´åˆ°å¿«æé™ P_MAX æ‰€éœ€è¦çš„ PerCM æ­¥é•¿ (åº”ä¸ºæ­£å€¼)
            const rightStepChange = (P_MAX_PerCM - currentPerCM) / 7; 
            
            return { currentPerCM, P_MIN_PerCM, P_MAX_PerCM, leftStepChange, rightStepChange };
        }

        /** è®¡ç®—çµæ•åº¦è°ƒæ•´åçš„æ–°å€¼ (åŸºäºPerCMå‡åˆ†) */
        function calculateSensitivityAdjustment() {
            if (currentDegreesFor5cm === 0) return { newDegreesFor5cm: 0, actualAdjustment: 0, forcedJump: false, adjustmentMessage: "æœªé€‰æ‹©è¿œè¿‘çº¬åº¦ã€‚", appliedMultiplier: 1.0 };

            const oldDegreesFor5cm = currentDegreesFor5cm;
            const speed = parseInt(speedSlider.value); 
            
            let newDegreesFor5cm;
            let forcedJump = false;
            let adjustmentMessage = "";

            // --- åŸºäºPerCMå‡åˆ†çš„è°ƒæ•´è·¯å¾„ ---
            const { currentPerCM, P_MIN_PerCM, P_MAX_PerCM, leftStepChange, rightStepChange } = calculatePerCMChange();
            
            let newPerCM = currentPerCM;
            
            if (speed < 0) {
                // æƒ³å¿«ç‚¹ (Move towards P_MAX/S+1), éœ€è¦ PerCM å¢åŠ 
                // rightStepChange ä¸ºæ­£å€¼
                newPerCM = currentPerCM + (Math.abs(speed) * rightStepChange); 

            } else if (speed > 0) {
                // æƒ³æ…¢ç‚¹ (Move towards P_MIN/S-2), éœ€è¦ PerCM å‡å°‘
                // leftStepChange ä¸ºè´Ÿå€¼
                newPerCM = currentPerCM + (speed * leftStepChange); 
            }
            
            // ç¡®ä¿æ–°çš„æ¯å˜ç±³åº¦æ•°åœ¨ç¡¬æ€§ç²¾å¯†åŒºé—´å†…
            newPerCM = Math.max(P_MIN_PerCM, Math.min(P_MAX_PerCM, newPerCM));
            
            // å°†æ–°çš„æ¯å˜ç±³åº¦æ•°è½¬æ¢å›5cm/å¤šå°‘Â°
            const newCM360 = 360 / newPerCM;
            newDegreesFor5cm = toDegreesFor5cm(newCM360);

            // ç¡¬æ€§ç²¾å¯†åŒºé—´é”å®šæ£€æŸ¥
            if (newDegreesFor5cm < PRECISION_MIN - TOLERANCE) {
                adjustmentMessage = `è°ƒæ•´è¶…å‡ºç¡¬æ€§ç²¾å¯†åŒºé—´ä¸‹é™ (${PRECISION_MIN.toFixed(3)}Â°)ï¼Œå·²æˆªæ–­å¹¶é”å®šã€‚`;
                newDegreesFor5cm = PRECISION_MIN;
                forcedJump = true; 
            } else if (newDegreesFor5cm > PRECISION_MAX + TOLERANCE) {
                adjustmentMessage = `è°ƒæ•´è¶…å‡ºç¡¬æ€§ç²¾å¯†åŒºé—´ä¸Šé™ (${PRECISION_MAX.toFixed(3)}Â°)ï¼Œå·²æˆªæ–­å¹¶é”å®šã€‚`;
                newDegreesFor5cm = PRECISION_MAX;
                forcedJump = true; 
            }

            // ç¡®ä¿ç»“æœä¸ä¼šè¶…å‡ºå…¨å±€æå€¼
            newDegreesFor5cm = Math.max(MIN_DEGREES, Math.min(MAX_DEGREES, newDegreesFor5cm)); 

            const actualAdjustment = newDegreesFor5cm - oldDegreesFor5cm;

            return {
                newDegreesFor5cm,
                actualAdjustment, 
                forcedJump,
                adjustmentMessage,
                appliedMultiplier: 1.0
            };
        }

        /** è®¡ç®—æ¸¸æˆçµæ•åº¦å¹¶æ›´æ–°æ˜¾ç¤º */
        function calculateGameSensitivities() {
            const dpi = parseInt(dpiInput.value) || 400; // é»˜è®¤ä½¿ç”¨ 400
            currentDpiDisplay.textContent = dpi;
            
            if (currentDegreesFor5cm === 0) {
                sensCS.textContent = 'N/A';
                sensVal.textContent = 'N/A';
                sensOW.textContent = 'N/A';
                return;
            }

            const cm360 = toCM360(currentDegreesFor5cm);
            
            if (cm360 === Infinity) {
                sensCS.textContent = 'N/A';
                sensVal.textContent = 'N/A';
                sensOW.textContent = 'N/A';
                return;
            }

            // Sensitivity = Constant / (cm360 * DPI)
            const sensCSVal = CONST_CS / (cm360 * dpi);
            const sensValVal = CONST_VAL / (cm360 * dpi);
            const sensOWVal = CONST_OW / (cm360 * dpi);
            
            // å®æ—¶æ˜¾ç¤º
            sensCS.textContent = sensCSVal.toFixed(4);
            sensVal.textContent = sensValVal.toFixed(4);
            sensOW.textContent = sensOWVal.toFixed(4);
        }

        // =========================================================================
        // C. çŠ¶æ€æ›´æ–°ä¸äº‹ä»¶å¤„ç† (æ ¸å¿ƒæ§åˆ¶)
        // =========================================================================
        
        /** æ›´æ–°åŠ¨æ€å¼ºè°ƒè‰² */
        function updateColors() {
            if (isFinalized) {
                // æµç¨‹ç»ˆç»“æ—¶ï¼Œå¼ºè°ƒè‰²å¼ºåˆ¶ä¸ºçº¢è‰²
                rootElement.style.setProperty('--current-accent', 'var(--color-warning)');
                return;
            }

            // ä½¿ç”¨ adjustmentCounter æ¥ç¡®å®šå½“å‰é¢œè‰²é˜¶æ®µ
            const colorIndex = adjustmentCounter > 0 ? (adjustmentCounter - 1) % MAX_ADJUSTMENTS : 0;
            const colorVar = PHASE_COLORS[colorIndex] || PHASE_COLORS[0];
            rootElement.style.setProperty('--current-accent', colorVar);
        }

        /** ç»ˆç»“æµç¨‹å¹¶æ˜¾ç¤ºç»“æœ (é¢œè‰²å›ºå®šä¸ºçº¢è‰²) */
        function finalizeAdjustment(finalStatusMessage) {
            if (isFinalized) return;
            isFinalized = true;
            currentPhase = 'final';
            
            // ç¡®ä¿å¼ºè°ƒè‰²æ›´æ–°ä¸ºçº¢è‰²
            updateColors(); 

            updatePhaseDisplay();
            
            // æ·»åŠ ç±»ï¼Œä½¿çµæ•åº¦æ•°å€¼å’Œå¡ç‰‡è¾¹æ¡†æœ€ç»ˆæ˜¾ç¤ºä¸ºçº¢è‰²
            sensitivityResult.classList.add('final-result');
            document.querySelector('.main-sens-card').classList.add('finalized'); 
            
            console.log("æµç¨‹ç»“æŸ:", finalStatusMessage);
            
            updateDisplay(); 
        }

        /** æ›´æ–°é˜¶æ®µæ˜¾ç¤º (æ§åˆ¶ actionButtons çš„æ˜¾ç¤º) */
        function updatePhaseDisplay() {
            const distancePhase = document.getElementById('distance-phase');
            const speedPhase = document.getElementById('speed-phase');
            const usabilityPhase = document.getElementById('usability-phase');
            const adjustmentControls = document.getElementById('adjustment-controls');
            const actionButtons = document.getElementById('action-buttons');
            
            distancePhase.style.display = 'none';
            speedPhase.style.display = 'none';
            usabilityPhase.style.display = 'none';
            
            if (isFinalized) {
                adjustmentControls.style.display = 'none';
                actionButtons.style.display = 'none';
                return; 
            }
            
            adjustmentControls.style.display = 'block';
            actionButtons.style.display = 'none'; // é»˜è®¤éšè—æ“ä½œæŒ‰é’®

            applyBtn.textContent = 'åº”ç”¨è°ƒæ•´';

            if (currentPhase === 'distance') {
                distancePhase.style.display = 'block'; 
                applyBtn.disabled = true; 
            } else if (currentPhase === 'speed') {
                speedPhase.style.display = 'block'; 
                actionButtons.style.display = 'flex'; // ç¬¬äºŒæ­¥ï¼ˆspeedï¼‰å¼€å§‹æ˜¾ç¤º
                applyBtn.disabled = false;
                // é‡ç½®æ»‘å—å’Œæ•°å€¼æ˜¾ç¤º
                speedSlider.value = 0; 
                document.getElementById('speed-value').textContent = 0;
                document.getElementById('adjustment-count-display').textContent = `${adjustmentCounter + 1}`; 
            } else if (currentPhase === 'usability') {
                usabilityPhase.style.display = 'block'; 
                actionButtons.style.display = 'flex'; // è¯„ä»·é˜¶æ®µä¹Ÿæ˜¾ç¤º
                applyBtn.disabled = false;
                applyBtn.textContent = 'ç¡®è®¤è¯„ä»·å¹¶åšå‡ºå†³ç­–';
                document.getElementById('adjustment-count-display').textContent = `${adjustmentCounter}`;
                
                // é‡ç½®è¯„ä»·æ˜Ÿçº§æ˜¾ç¤ºä¸ºé»˜è®¤ 2 æ˜Ÿ
                usabilityStars.forEach(star => {
                    star.classList.remove('active');
                    if (parseInt(star.dataset.rating) <= currentStarRating) {
                        star.classList.add('active');
                    }
                });
            }
        }


        /** æ›´æ–°å½“å‰ç•Œé¢æ‰€æœ‰æ˜¾ç¤ºæ•°å€¼ */
        function updateDisplay() {
            if (currentDegreesFor5cm === 0) {
                 document.getElementById('current-base-d-step').textContent = "0.0000";
                 precisionRangeDisplay.textContent = "è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦";
                 sensitivityResult.textContent = "è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦";
                 document.getElementById('sensitivity-range').textContent = "";
                 calculateGameSensitivities();
                 return;
            }

            const cm360 = toCM360(currentDegreesFor5cm);

            // æ ¹æ®æ¿€æ´»çš„æŒ‰é’®å†³å®šæ˜¾ç¤ºæ ¼å¼
            const sensitivityRange = document.getElementById('sensitivity-range');

            if (cm360UnitBtn.classList.contains('active')) {
                sensitivityResult.textContent = cm360.toFixed(2) + 'cm';
                // æ˜¾ç¤ºå½“å‰å€¼
                let rangeHint = `[360Â°] å¯¹åº”: ${currentDegreesFor5cm.toFixed(3)}Â°/5cm`;
                if (currentDegreesFor5cm < MIN_DEGREES - TOLERANCE) {
                    rangeHint += " (ä½äºç†è®ºä¸‹é™)";
                } else if (currentDegreesFor5cm > MAX_DEGREES + TOLERANCE) {
                    rangeHint += " (é«˜äºç†è®ºä¸Šé™)";
                }
                sensitivityRange.textContent = rangeHint;
            } else { // cm5UnitBtn is active
                sensitivityResult.textContent = currentDegreesFor5cm.toFixed(3) + 'Â°';
                let rangeHint = `[5cm] å¯¹åº”: ${cm360.toFixed(2)}cm/360Â°`;
                 if (currentDegreesFor5cm < MIN_DEGREES - TOLERANCE) {
                    rangeHint += " (ä½äºç†è®ºä¸‹é™)";
                } else if (currentDegreesFor5cm > MAX_DEGREES + TOLERANCE) {
                    rangeHint += " (é«˜äºç†è®ºä¸Šé™)";
                }
                sensitivityRange.textContent = rangeHint;
            }

            // è®¡ç®—å¹¶æ˜¾ç¤ºæ­¥é•¿ (PerCM Step Magnitude)
            const { P_MIN_PerCM, P_MAX_PerCM } = calculatePerCMChange();
            
            // ä¿®æ­£æ˜¾ç¤ºï¼šå±•ç¤ºå®é™…çš„ PerCM è°ƒæ•´æ­¥é•¿ |P_MAX - P_MIN| / 14 (åªéœ€è®¡ç®—ä¸€ä¾§çš„ 7 æ­¥)
            const stepMagnitude = Math.abs(P_MAX_PerCM - P_MIN_PerCM) / 14; 
            
            document.getElementById('current-base-d-step').textContent = stepMagnitude.toFixed(4); 
            
            precisionRangeDisplay.textContent = `[${PRECISION_MIN.toFixed(3)}Â° åˆ° ${PRECISION_MAX.toFixed(3)}Â°]`;

            calculateGameSensitivities();
        }
        
        /** åº”ç”¨çµæ•åº¦è°ƒæ•´ (ä¸­å¤®çŠ¶æ€æœº) */
        function applySensitivityAdjustment() {
            if (isFinalized) {
                finalizeAdjustment('æµç¨‹å·²é”å®š');
                return;
            }
            
            if (currentPhase === 'speed') {
                
                const currentSpeedValue = parseInt(speedSlider.value);

                // --- é›¶å¹…åº¦å³é”å®š ---
                if (currentSpeedValue === 0) {
                    adjustmentCounter++; 
                    finalizeAdjustment(`æ‚¨åœ¨ç¬¬ ${adjustmentCounter} è½®é€‰æ‹©äº† 0 è°ƒæ•´å¹…åº¦ã€‚ç³»ç»Ÿåˆ¤å®šå½“å‰çµæ•åº¦ (${currentDegreesFor5cm.toFixed(3)}Â°/5cm) ä¸ºæœ€ç»ˆç»“æœã€‚`);
                    return;
                }
                
                // --- æå€¼è¾¹ç•Œå†³ç­– (ä¸åˆç†æ–¹å‘ç«‹å³é”å®š) ---
                const isExtremeMin = Math.abs(initialDegrees - MIN_DEGREES) < TOLERANCE; // æœ€æ…¢/æœ€è¿œ
                const isExtremeMax = Math.abs(initialDegrees - MAX_DEGREES) < TOLERANCE; // æœ€å¿«/è´´è„¸

                let shouldFinalizeExtreme = false;
                let extremeMessage = "";

                if (isExtremeMin && currentSpeedValue > 0) {
                    // æœ€è¿œ(æ…¢) -> å°è¯•å˜æ›´æ…¢ (+1åˆ°+7) -> ç«‹å³é”å®š
                    currentDegreesFor5cm = MIN_DEGREES; // é”å®šåœ¨åŸå€¼
                    extremeMessage = `æ“ä½œä¸åˆç†ï¼šæ‚¨åœ¨"æœ€è¿œ"ç‚¹ï¼ˆææ…¢ï¼‰é€‰æ‹©å¾€"æ›´æ…¢"è°ƒæ•´ã€‚æµç¨‹é”å®šåœ¨ ${MIN_DEGREES.toFixed(3)}Â°/5cmã€‚`;
                    shouldFinalizeExtreme = true;
                } else if (isExtremeMax && currentSpeedValue < 0) {
                    // è´´è„¸(å¿«) -> å°è¯•å˜æ›´å¿« (-1åˆ°-7) -> ç«‹å³é”å®š
                    currentDegreesFor5cm = MAX_DEGREES; // é”å®šåœ¨åŸå€¼
                    extremeMessage = `æ“ä½œä¸åˆç†ï¼šæ‚¨åœ¨"è´´è„¸"ç‚¹ï¼ˆæå¿«ï¼‰é€‰æ‹©å¾€"æ›´å¿«"è°ƒæ•´ã€‚æµç¨‹é”å®šåœ¨ ${MAX_DEGREES.toFixed(3)}Â°/5cmã€‚`;
                    shouldFinalizeExtreme = true;
                }
                
                if (shouldFinalizeExtreme) {
                    adjustmentCounter++; // è®¡å…¥ä¸€æ¬¡æ“ä½œ
                    finalizeAdjustment(extremeMessage);
                    return;
                }
                // --- END æå€¼è¾¹ç•Œé”å®š ---

                // --- æ­£å¸¸è°ƒæ•´è·¯å¾„ ---
                const result = calculateSensitivityAdjustment();
                let newDegreesFor5cm = result.newDegreesFor5cm; 
                // å¿…é¡»æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆè°ƒæ•´ï¼Œå¦åˆ™å¯èƒ½å› ä¸ºæµ®ç‚¹å¯¼è‡´æ— å˜åŒ–è€Œè®¡æ•°å™¨å¢åŠ 
                const adjustmentOccurred = Math.abs(result.actualAdjustment) > TOLERANCE;
                
                // ç»Ÿä¸€æ›´æ–°çŠ¶æ€
                currentDegreesFor5cm = newDegreesFor5cm; 
                
                // --- æœ€å¤§å¹…åº¦è§¦è¾¹å³åˆ»é”å®š ---
                const isMaxAdjustment = Math.abs(currentSpeedValue) === 7;
                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç¡¬æ€§è¾¹ç•Œ
                const resultIsOnBoundary = (
                    (currentSpeedValue < 0 && Math.abs(newDegreesFor5cm - PRECISION_MAX) < TOLERANCE) || // å˜å¿«(-7) åˆ°è¾¾å¿«ç«¯ç•Œé™ (PRECISION_MAX)
                    (currentSpeedValue > 0 && Math.abs(newDegreesFor5cm - PRECISION_MIN) < TOLERANCE)    // å˜æ…¢(+7) åˆ°è¾¾æ…¢ç«¯ç•Œé™ (PRECISION_MIN)
                );
                
                if (isMaxAdjustment && resultIsOnBoundary && adjustmentOccurred) {
                    adjustmentCounter++; 
                    finalizeAdjustment(`ç³»ç»Ÿè§¦å‘æœ€å¤§å¹…åº¦è§¦è¾¹é”å®šã€‚æœ€ç»ˆçµæ•åº¦ä¸º ${currentDegreesFor5cm.toFixed(3)}Â°/5cmã€‚`);
                    return; 
                }
                
                // --- å¼ºåˆ¶é”å®šé€»è¾‘ (è°ƒæ•´ç»“æœå†²è¿‡å¤´äº†) ---
                if (result.forcedJump) {
                    adjustmentCounter++; 
                    finalizeAdjustment(`è°ƒæ•´è§¦å‘äº†ç¡¬æ€§é™åˆ¶ï¼Œå·²å¼ºåˆ¶é”å®šæœ€ç»ˆçµæ•åº¦ä¸º ${currentDegreesFor5cm.toFixed(3)}Â°/5cmã€‚`);
                    return;
                } 
                
                // è°ƒæ•´è®¡æ•°å™¨å¢åŠ ï¼Œè¡¨ç¤ºæœ¬è½®è°ƒæ•´å·²æ‰§è¡Œ (éé”å®šçŠ¶æ€ä¸‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ)
                adjustmentCounter++; 

                // --- ç»ˆç»“åˆ¤å®šï¼šå¦‚æœæ˜¯ç¬¬äºŒæ¬¡è°ƒæ•´ (AC=2)ï¼Œåˆ™ç›´æ¥é”å®šå¹¶ç»“æŸ ---
                if (adjustmentCounter >= MAX_ADJUSTMENTS) {
                    // å¼ºåˆ¶é”å®š
                    finalizeAdjustment(`äºŒæ¬¡å¿«æ…¢è°ƒæ•´ï¼ˆç¬¬ ${MAX_ADJUSTMENTS} è½®ï¼‰å·²å®Œæˆã€‚ç³»ç»Ÿåˆ¤å®šè°ƒèŠ‚æµç¨‹ç»“æŸï¼Œå¹¶å¼ºåˆ¶é”å®šæœ€ç»ˆçµæ•åº¦ (${currentDegreesFor5cm.toFixed(3)}Â°/5cm)ã€‚`);
                    return;
                }
                
                // --- ç¬¬ä¸€æ¬¡è°ƒæ•´åçš„å¤„ç† (AC=1) ---
                if (adjustmentCounter === 1) { 
                    if (!adjustmentOccurred) { 
                        // æ— å˜åŒ–ï¼šè‡ªåŠ¨è·³è¿‡è¯„ä»·ï¼Œè¿›å…¥ç¬¬äºŒè½®å¿«æ…¢è°ƒèŠ‚
                        currentPhase = 'speed'; 
                    } else {
                        // æœ‰å˜åŒ–ï¼šè¿›å…¥è¯„ä»·/å†³ç­–ç‚¹
                        currentPhase = 'usability';
                    }
                } 

            } else if (currentPhase === 'usability') {
                
                // æ­¤å¤„ä»…å¤„ç†ç¬¬ä¸€æ¬¡è°ƒæ•´åçš„è¯„ä»· (AC æ­¤æ—¶ä¸º 1)
                const rating = currentStarRating;
                
                if (rating === 3) {
                    // 3æ˜Ÿ: é”å®šç»“æœå¹¶ç»“æŸ
                    finalizeAdjustment(`æ‚¨é€‰æ‹©äº† 3 æ˜Ÿè¯„ä»·ï¼Œç³»ç»Ÿå·²é”å®šå½“å‰çµæ•åº¦ (${currentDegreesFor5cm.toFixed(3)}Â°/5cm) ä¸ºæœ€ç»ˆç»“æœã€‚`);
                    return; 
                    
                } else if (rating === 1) {
                    // 1æ˜Ÿ: é‡ç½®ç³»ç»Ÿ
                    console.log("æ‚¨é€‰æ‹©äº† 1 æ˜Ÿè¯„ä»·ï¼Œç³»ç»Ÿå°†åˆå§‹åŒ–æ‰€æœ‰å‚æ•°ã€‚");
                    setTimeout(resetAll, 50); // ç«‹å³é‡ç½®
                    return;
                    
                } else if (rating === 2) {
                    // 2æ˜Ÿ: ç»§ç»­è¿›è¡Œä¸‹ä¸€è½®å¿«æ…¢çš„é€‰æ‹© (è¿›å…¥ç¬¬ 2 è½®ï¼Œå³æœ€ç»ˆè½®)
                    currentPhase = 'speed'; 
                    currentStarRating = 2; // é‡ç½®æ˜Ÿçº§æ˜¾ç¤º
                }
            }
            
            updateDisplay(); 
            updatePhaseDisplay();
            updateColors(); 
        }
        
        function resetAll() {
            currentDegreesFor5cm = 0; 
            adjustmentCounter = 0;
            currentStarRating = 2; 
            isFinalized = false;
            currentPhase = 'distance';
            lastSpeedPhaseResult = null;
            PRECISION_MIN = MIN_DEGREES; 
            PRECISION_MAX = MAX_DEGREES;
            initialDegrees = 0;

            // DOMé‡ç½® 
            applyBtn.disabled = true;
            sensitivityResult.classList.remove('final-result');
            document.querySelector('.main-sens-card').classList.remove('finalized'); // ç§»é™¤ finalized ç±»

            distanceButtons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('active');
            });
            usabilityStars.forEach(star => {
                star.classList.remove('active');
                if (parseInt(star.dataset.rating) === 2) {
                    star.classList.add('active');
                }
            });
            
            // é»˜è®¤æ˜¾ç¤º cm/360Â°
            cm5UnitBtn.classList.remove('active');
            cm360UnitBtn.classList.add('active'); 
            
            dpiInput.value = 400; // é‡ç½® DPI ä¸º 400

            updateDisplay();
            updatePhaseDisplay();
            updateColors(); 
        }
        
        // =========================================================================
        // D. äº‹ä»¶ç»‘å®š
        // =========================================================================

        distanceButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                if (currentPhase !== 'distance' || isFinalized) return;
                
                const value = parseFloat(this.dataset.value);
                currentDegreesFor5cm = value;
                initialDegrees = value; // è®°å½•åˆå§‹å€¼
                
                setHardPrecisionBounds(value);

                distanceButtons.forEach(b => {
                    b.classList.remove('active');
                    b.disabled = true; 
                });
                this.classList.add('active');

                currentPhase = 'speed';
                
                updateDisplay();
                updatePhaseDisplay();
                updateColors(); /* é¦–æ¬¡è¿›å…¥ speed é˜¶æ®µï¼Œé¢œè‰²æ›´æ–° */
            });
        });
        
        // æ˜Ÿçº§ç‚¹å‡»äº‹ä»¶ (3æ˜Ÿå†³ç­– - ä»…åœ¨ç¬¬ä¸€æ¬¡è°ƒæ•´åå¯ç”¨)
        usabilityStars.forEach(star => {
            star.addEventListener('click', function() {
                if (currentPhase !== 'usability' || isFinalized) return;

                const rating = parseInt(this.dataset.rating);
                currentStarRating = rating;
                
                usabilityStars.forEach(s => {
                    s.classList.remove('active');
                    if (parseInt(s.dataset.rating) <= rating) {
                        s.classList.add('active');
                    }
                });
            });
        });
        
        // V18.1 ä¿®æ­£: ç§»é™¤å®æ—¶æ›´æ–°é€»è¾‘ï¼Œä»…æ›´æ–°æ»‘å—æ˜¾ç¤ºå’ŒæŒ‰é’®çŠ¶æ€
        speedSlider.addEventListener('input', function() {
            document.getElementById('speed-value').textContent = this.value;
            // ä»…ç¡®ä¿åº”ç”¨æŒ‰é’®å¯ç”¨ï¼Œçµæ•åº¦ç›‘æµ‹å€¼å°†åœ¨åº”ç”¨è°ƒæ•´åæ›´æ–°
            applyBtn.disabled = false;
        });

        // V18.1 ä¿®æ­£: ç§»é™¤æ»‘å—æ¾å¼€äº‹ä»¶ï¼Œä¸å†éœ€è¦æ¢å¤æ˜¾ç¤º
        // speedSlider.addEventListener('mouseup', updateDisplay); 
        // speedSlider.addEventListener('touchend', updateDisplay);
        
        // å•ä½åˆ‡æ¢äº‹ä»¶
        cm360UnitBtn.addEventListener('click', function() {
            if (!this.classList.contains('active')) {
                this.classList.add('active');
                cm5UnitBtn.classList.remove('active');
                updateDisplay();
            }
        });
        
        cm5UnitBtn.addEventListener('click', function() {
            if (!this.classList.contains('active')) {
                this.classList.add('active');
                cm360UnitBtn.classList.remove('active');
                updateDisplay();
            }
        });
        
        // DPIè¾“å…¥å˜åŒ–æ—¶ï¼Œé‡æ–°è®¡ç®—æ¸¸æˆçµæ•åº¦
        dpiInput.addEventListener('input', updateDisplay);

        applyBtn.addEventListener('click', applySensitivityAdjustment);
        document.getElementById('reset-btn').addEventListener('click', resetAll);
        
        // åˆå§‹åŒ–è°ƒç”¨
        updateDisplay();
        updatePhaseDisplay();
        updateColors();
    </script>
</body>
</html>