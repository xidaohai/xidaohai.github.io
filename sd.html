<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿å²›æµ·Â·ä¸‰é˜¶æ ¡å‡†æ³•Â·åˆé˜¶é—ªç”µç®— - V18.5 (Mobile Compatible)</title>
    <style>
        /* =========================================================================
         * A. é¢œè‰²å˜é‡ä¸ä¸“ä¸šç¾å­¦åŸºç¡€
         * ========================================================================= */
        :root {
            --color-dark: #2c3e50; /* æ·±è“ç° - ä¸»è¦æ–‡æœ¬/å®¹å™¨ */
            --color-light-bg: #f9fbfd; /* ææµ…èƒŒæ™¯ */
            --color-card-bg: #ffffff; /* å¡ç‰‡èƒŒæ™¯ */
            --color-border: #e0e6ed; /* æµ…è¾¹æ¡† */
            --color-accent-base: #3498db; /* åŸºç¡€ä¸“ä¸šè“ */
            --color-accent-r1: #2980b9; /* é˜¶æ®µ1ï¼šæ·±è“ */
            --color-accent-r2: #16a085; /* é˜¶æ®µ2ï¼šå¢¨ç»¿ */
            --color-accent-r3: #e67e22; /* é˜¶æ®µ3ï¼šç¨³å®šæ©™ */
            --color-warning: #e74c3c; /* è­¦ç¤ºçº¢ - æœ€ç»ˆé¢œè‰² */
            --color-highlight: #f1c40f; /* é»„é‡‘è‰² - è¯„ä»· */
            --border-radius: 6px;
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.05);
            --current-accent: var(--color-accent-r1); /* åŠ¨æ€é˜¶æ®µè‰² */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', 'Arial', sans-serif, 'Microsoft YaHei', 'SimHei';
        }
        
        body {
            background-color: var(--color-light-bg);
            color: var(--color-dark);
            line-height: 1.6;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        
        /* --- æ ¸å¿ƒç»“æ„ï¼šåŒé¢æ¿å¸ƒå±€ --- */
        .main-container {
            display: flex;
            max-width: 1400px; 
            width: 100%;
            gap: 20px;
        }
        
        .panel {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--color-border);
            padding: 25px;
        }
        
        .controls-panel {
            flex: 2; 
        }
        
        .results-panel {
            flex: 1; 
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        /* --- æ ‡é¢˜ä¸ä¿¡æ¯å¡ --- */
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--color-dark);
            font-size: 2.2em;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-border);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 18px;
            color: var(--current-accent);
            padding-bottom: 5px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-card {
            background-color: #f7f9fc; 
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-bottom: 25px;
            border-left: 4px solid var(--current-accent);
            line-height: 1.8;
            font-size: 0.95em;
        }
        
        /* --- é˜¶æ®µè¾“å…¥åŒº --- */
        .phase-section {
            padding: 20px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            background-color: var(--color-card-bg);
        }
        
        /* --- è¿œè¿‘çº¬åº¦ (å‚ç›´å †å ) - ç§»é™¤æ•°å­—ï¼Œèšç„¦æ ‡ç­¾ --- */
        .distance-buttons {
            display: flex; 
            flex-direction: column;
            gap: 10px; 
            margin-top: 15px;
        }
        
        .distance-btn {
            width: 100%; 
            padding: 15px 15px; 
            border: 2px solid var(--color-border);
            background-color: #ffffff;
            font-size: 1.0em; 
            transition: all 0.3s ease;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: left; 
            display: flex;
            align-items: center;
            justify-content: center; /* æŒ‰é’®å†…å®¹å±…ä¸­ */
            line-height: 1.3;
        }

        .distance-btn:hover:not(:disabled) {
            border-color: var(--color-accent-base);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        .distance-btn.active {
            border-color: var(--current-accent);
            background-color: #eaf1f7; 
            color: var(--color-dark);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        /* éšè—åº¦æ•°æ ‡ç­¾ */
        .btn-degree {
            display: none;
        }

        /* æå‡ä¸­æ–‡æ ‡ç­¾çš„è§†è§‰æƒé‡ */
        .btn-label {
            font-size: 1.2em; /* å¢å¤§å­—ä½“ï¼Œä½¿å…¶æˆä¸ºä¸»è¦å†…å®¹ */
            font-weight: 700; /* ç²—ä½“ */
            color: var(--color-dark); /* ä½¿ç”¨æ·±è‰² */
            margin: 0; /* ç§»é™¤è¾¹è· */
            flex-grow: unset; 
            text-align: center; /* æ–‡æœ¬å±…ä¸­ */
        }
        
        .distance-btn.active .btn-label {
            color: var(--current-accent); /* é€‰ä¸­æ—¶ä½¿ç”¨å¼ºè°ƒè‰² */
        }
        
        /* å¿«æ…¢çº¬åº¦ æ»‘å—å’Œæ˜Ÿçº§ä¿æŒ v15.3 ä¼˜åŒ– */
        .dimension-value {
             font-size: 1.8em;
             font-weight: 700;
             color: var(--current-accent);
        }
        
        .slider-container {
            padding: 15px 0; 
        }
        
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px; 
            background: #ddd;
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px; 
            height: 24px; 
            background: var(--current-accent);
            border-radius: 50%;
            cursor: grab;
            border: 4px solid var(--color-card-bg); 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-moz-range-thumb {
             width: 24px;
             height: 24px;
             background: var(--current-accent);
             border-radius: 50%;
             cursor: grab;
             border: 4px solid var(--color-card-bg);
             box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        .stars-container {
            display: flex; 
            justify-content: center;
            gap: 15px; 
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .star {
            font-size: 3em; 
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .star.active {
            color: var(--color-highlight); 
            text-shadow: 0 0 8px rgba(241, 196, 15, 0.6); 
        }
        
        /* --- åŠ¨ä½œæŒ‰é’® (ä¿æŒ v15.3 ä¼˜åŒ–) --- */
        .action-buttons {
            display: flex;
            gap: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
            justify-content: center;
            margin-top: 10px;
        }
        
        .action-btn {
            padding: 12px 30px; 
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .apply-btn {
            background-color: var(--current-accent); 
            color: var(--color-card-bg); 
        }
        
        .apply-btn:hover:not(:disabled) {
            background-color: var(--color-accent-base); 
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .apply-btn:disabled {
            background-color: #bdc3c7; 
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .reset-btn {
            background-color: transparent;
            border: 2px solid #ccc;
            color: var(--color-dark);
        }
        
        .reset-btn:hover {
            border-color: var(--color-warning);
            color: var(--color-warning);
        }

        /* --- å•ä½åˆ‡æ¢æŒ‰é’® (ä¿æŒ v15.3 ä¼˜åŒ–) --- */
        .unit-toggle {
            display: flex;
            background-color: #eef3f7; 
            border-radius: var(--border-radius);
            padding: 3px;
            border: 1px solid #dcdcdc; 
            margin-left: 20px; 
        }
        
        .unit-toggle button {
            flex: 1;
            padding: 10px 15px; 
            border: none;
            background: transparent;
            border-radius: calc(var(--border-radius) - 2px);
            cursor: pointer;
            font-size: 0.95em; 
            transition: all 0.2s ease;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .unit-toggle button.active {
            background-color: var(--color-card-bg);
            color: var(--color-dark);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
            font-weight: 700;
        }
        
        /* --- DPI è¾“å…¥ (ä¿æŒ v15.3 ä¼˜åŒ–) --- */
        .dpi-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            margin-bottom: 20px;
            gap: 15px;
        }
        .dpi-input-group input {
            padding: 10px 12px; 
            border: 2px solid var(--color-border); 
            border-radius: var(--border-radius);
            width: 120px; 
            text-align: center;
            font-size: 1.2em; 
            transition: border-color 0.3s;
        }

        .dpi-input-group input:focus {
            outline: none;
            border-color: var(--color-accent-base);
        }
        
        /* --- ä¸»çµæ•åº¦å¡ç‰‡ (Result Panel) - é¢œè‰²éšé˜¶æ®µå˜åŒ– --- */
        .main-sens-card {
            background-color: #f7f9fc; 
            border-radius: var(--border-radius);
            padding: 20px 10px;
            margin: 15px 0 25px 0; 
            border-left: 5px solid var(--current-accent); /* åŠ¨æ€é¢œè‰²è¾¹æ¡† */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        /* æµç¨‹ç»ˆç»“æ—¶å¼ºåˆ¶ä½¿ç”¨çº¢è‰² */
        .main-sens-card.finalized {
            border-left-color: var(--color-warning) !important;
        }
        
        .sensitivity-value {
            font-size: 3.8em; 
            font-weight: 800;
            text-align: center;
            margin: 5px 0;
            transition: color 0.3s;
            color: var(--color-dark); /* é»˜è®¤æ·±è‰² */
        }
        
        /* æœ€ç»ˆç»“æœæ—¶é¢œè‰²ä¸ºçº¢è‰² */
        .sensitivity-value.final-result {
            color: var(--color-warning); 
            animation: none; 
        }

        .sensitivity-range {
            text-align: center;
            color: #666;
            font-size: 1.0em;
            margin-bottom: 5px;
        }
        
        /* --- æ¸¸æˆçµæ•åº¦å¡ç‰‡ --- */
        .game-sens-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px; 
            margin-top: 20px;
        }
        .game-sens-card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
            transition: border-color 0.2s;
        }
        .game-sens-card:hover {
            border-color: #bdc3c7;
        }
        .game-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #95a5a6;
            margin-bottom: 5px;
        }
        .game-sens-value {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--color-dark);
            line-height: 1.2;
        }
        .game-sens-hint {
            font-size: 0.8em;
            color: #bdc3c7;
            margin-top: 5px;
        }

        /* =========================================================================
         * æ–°å¢ï¼šæ‚¬æµ®çª—æ ·å¼ 
         * ========================================================================= */
        .floating-help-btn {
            position: fixed; 
            right: 20px; 
            bottom: 20px; 
            z-index: 1000; 
            padding: 12px 18px; 
            width: auto; 
            white-space: nowrap; 
            text-align: center;
            background-color: var(--color-accent-base); 
            color: var(--color-card-bg); 
            text-decoration: none; 
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1.0em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
            transition: all 0.3s ease;
            border: 1px solid var(--color-accent-base);
        }

        .floating-help-btn:hover {
            background-color: var(--color-accent-r1); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px); 
        }

        /* =========================================================================
         * Mobile Compatibility Fixes (æ‰‹æœºç«¯å…¼å®¹æ€§ä¿®å¤)
         * ========================================================================= */
        @media screen and (max-width: 900px) {
            body {
                padding: 10px;
            }
            
            .main-container {
                flex-direction: column;
                gap: 15px;
            }

            /* å…³é”®é€»è¾‘ï¼šåœ¨æ‰‹æœºä¸Šï¼ŒæŠŠç»“æœé¢æ¿(Results Panel)æ”¾åˆ°æ§åˆ¶é¢æ¿(Controls Panel)ä¸Šæ–¹ã€‚
               è¿™æ ·ç”¨æˆ·åœ¨ä¸‹æ–¹æ»‘åŠ¨æ»‘å—æ—¶ï¼Œèƒ½ç›´æ¥çœ‹åˆ°ä¸Šæ–¹çš„å¤§æ•°å­—å˜åŒ–ã€‚
            */
            .results-panel {
                order: -1; 
                position: static; /* ç§»é™¤ stickyï¼Œé˜²æ­¢åœ¨æ‰‹æœºä¸Šå æ»¡é¦–å± */
                width: 100%;
                margin-bottom: 5px;
            }

            .controls-panel {
                width: 100%;
            }

            .panel {
                padding: 15px;
            }

            h1 {
                font-size: 1.6em; /* å‡å°æ ‡é¢˜å­—å· */
            }
            
            .sensitivity-value {
                font-size: 2.8em; /* é˜²æ­¢æ•°å­—è¿‡å¤§æ’‘ç ´å±å¹• */
            }

            /* æ¸¸æˆçµæ•åº¦å¡ç‰‡åœ¨æ‰‹æœºä¸Šæ”¹ä¸ºå•åˆ—æ˜¾ç¤ºï¼Œé¿å…æŒ¤å‹ */
            .game-sens-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column; /* æŒ‰é’®å‚ç›´æ’åˆ— */
            }
            
            .action-btn {
                width: 100%;
            }
            
            .floating-help-btn {
                padding: 8px 12px;
                font-size: 0.9em;
                bottom: 15px;
                right: 15px;
                opacity: 0.8; /* ç¨å¾®é€æ˜ä¸€ç‚¹ä»¥å…é®æŒ¡å†…å®¹ */
            }
        }
        
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="panel controls-panel" id="main-container">
            <h1>è¥¿å²›æµ· Â· FPSæ¸¸æˆ çµæ•åº¦é—ªç”µç®—</h1>
            
            <div class="info-card">
                <p><strong>å…¨å±€è®¾å®šèŒƒå›´:</strong> 5cm/25.3125&deg; (æœ€æ…¢) åˆ° 5cm/50.625&deg; (æœ€å¿«)</p>
                <p class="step-info"><strong>PerCM æ­¥é•¿ (Adjustment Â°/1cm):</strong> <span id="current-base-d-step">0.0000</span></p> 
                <p class="step-info"><strong>ç²¾å¯†è°ƒæ•´åŒºé—´ (ç¡¬æ€§é”å®š S<sub>-2</sub> åˆ° S<sub>+1</sub>):</strong> <span id="precision-range-display">è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦</span></p>
            </div>
            
            <div id="adjustment-controls">
                <div id="distance-phase" class="phase-section">
                    <div class="section-title">é˜¶æ®µ 1/3: è¿œè¿‘çº¬åº¦é€‰æ‹© (åŸºç¡€è®¾å®š)</div>
                    <div class="distance-buttons">
                        <button class="distance-btn" data-value="25.3125">
                            <span class="btn-degree">25.3125&deg;</span>
                            <span class="btn-label">æœ€è¿œï¼ˆæˆ–ç›®æ ‡æœ€å°ï¼‰</span>
                        </button>
                        
                        <button class="distance-btn" data-value="28.125">
                            <span class="btn-degree">28.125&deg;</span>
                            <span class="btn-label">è¿œ</span>
                        </button>
                        
                        <button class="distance-btn" data-value="30.9375">
                            <span class="btn-degree">30.9375&deg;</span>
                            <span class="btn-label">ä¸­è¿œ</span>
                        </button>
                        
                        <button class="distance-btn" data-value="33.75">
                            <span class="btn-degree">33.75&deg;</span>
                            <span class="btn-label">ä¸­</span>
                        </button>
                        
                        <button class="distance-btn" data-value="39.375">
                            <span class="btn-degree">39.375&deg;</span>
                            <span class="btn-label">ä¸­è¿‘</span>
                        </button>
                        
                        <button class="distance-btn" data-value="45">
                            <span class="btn-degree">45&deg;</span>
                            <span class="btn-label">è¿‘</span>
                        </button>
                        
                        <button class="distance-btn" data-value="50.625">
                            <span class="btn-degree">50.625&deg;</span>
                            <span class="btn-label">è´´è„¸ï¼ˆæˆ–ç›®æ ‡æœ€å¤§ï¼‰</span>
                        </button>
                    </div>
                </div>

                <div id="adjustment-input-area">
                    <div id="speed-phase" class="phase-section" style="display: none;">
                        <div class="section-title">é˜¶æ®µ 2/3: å¿«æ…¢çº¬åº¦è°ƒèŠ‚ (å½“å‰è½®æ¬¡: <span id="adjustment-count-display">0</span>)</div>
                        <div class="dimension">
                            <div class="dimension-header">
                                <span class="dimension-name">è°ƒæ•´å¹…åº¦ [-7 è‡³ +7] (ç»å¯¹ä½ç½®)</span>
                                <span class="dimension-value" id="speed-value">0</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" min="-7" max="7" value="0" class="slider" id="speed-slider">
                            </div>
                            <div class="slider-labels" style="display:flex; justify-content:space-between; font-size:0.9em; color:#999;">
                                <span>ã€æƒ³å›æ…¢ã€‘</span>
                                <span>ã€æƒ³åŠ å¿«ã€‘</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="usability-phase" class="phase-section" style="display: none;">
                        <div class="section-title">é˜¶æ®µ 3/3: å¥½ç”¨çº¬åº¦è¯„ä»· (è¯·å¯¹ç»“æœåšå‡ºå†³ç­–)</div>
                        <div class="dimension-header" style="justify-content: center;">
                            <span class="dimension-name">è¯·å¯¹å½“å‰çµæ•åº¦è¿›è¡Œè¯„ä»· (æ»¡åˆ† 3 æ˜Ÿ)</span>
                        </div>
                        <div class="stars-container" id="stars-container">
                            <div class="star" data-rating="1">â˜…</div>
                            <div class="star active" data-rating="2">â˜…</div>
                            <div class="star" data-rating="3">â˜…</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" id="action-buttons" style="display: none;">
                <button class="action-btn apply-btn" id="apply-btn" disabled>åº”ç”¨è°ƒæ•´</button>
                <button class="action-btn reset-btn" id="reset-btn">é‡ç½®ç³»ç»Ÿ</button>
            </div>
        </div>

        <div class="panel results-panel">
             <div class="result-section">
                <div class="dimension-header" style="align-items: center;">
                    <h2 style="font-size:1.5em; color:var(--color-dark);">å®æ—¶çµæ•åº¦ç›‘æµ‹</h2>
                    <div class="unit-toggle">
                        <button class="unit-btn" id="cm5-unit">5cm/å¤šå°‘&deg;</button>
                        <button class="unit-btn active" id="cm360-unit">cm/360&deg;</button>
                    </div>
                </div>
                
                <div class="main-sens-card">
                    <div class="sensitivity-value" id="sensitivity-result">è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦</div> 
                    <div class="sensitivity-range" id="sensitivity-range"></div>
                </div>
            </div>

            <div class="dpi-input-group">
                <label for="dpi-input">å½“å‰ DPI:</label>
                <input type="number" id="dpi-input" value="400" min="100" step="100" oninput="updateDisplay()">
            </div>

            <div class="game-sensitivity-display">
                <div class="section-title" style="text-align: center; margin-bottom: 10px;">ğŸ® æ¸¸æˆçµæ•åº¦å®æ—¶æ¢ç®— (DPI: <span id="current-dpi-display">400</span>)</div>
                <div class="game-sens-grid">
                    <div class="game-sens-card">
                        <div class="game-name">CS / Apex</div>
                        <div class="game-sens-value" id="sens-cs">N/A</div>
                        <div class="game-sens-hint">çµæ•åº¦ (m_yaw=0.022)</div>
                    </div>
                    <div class="game-sens-card">
                        <div class="game-name">Valorant</div>
                        <div class="game-sens-value" id="sens-val">N/A</div>
                        <div class="game-sens-hint">çµæ•åº¦ (m_yaw=0.07)</div>
                    </div>
                    <div class="game-sens-card">
                        <div class="game-name">Overwatch</div>
                        <div class="game-sens-value" id="sens-ow">N/A</div>
                        <div class="game-sens-hint">çµæ•åº¦ (m_yaw=0.0066)</div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <a href="https://space.bilibili.com/1534330" class="floating-help-btn" target="_blank">
        ä½œè€…ï¼šè¥¿å²›æµ·_xlm
    </a>

    <script>
        // =========================================================================
        // A. å¸¸é‡ä¸çŠ¶æ€å˜é‡ (æ ¸å¿ƒæ•°æ®)
        // =========================================================================

        const MAX_ADJUSTMENTS = 2; 
        const MIN_DEGREES = 25.3125; 
        const MAX_DEGREES = 50.625; 
        const TOLERANCE = 0.0001; 
        
        const ALL_STEPS = [
            25.3125, 28.125, 30.9375, 
            33.75, 
            39.375, 45, 50.625
        ];
        
        const CONST_CS = 41563.636; 
        const CONST_VAL = 13062.857;
        const CONST_OW = 138545.455;
        
        const PHASE_COLORS = {
            0: 'var(--color-accent-r1)', 
            1: 'var(--color-accent-r2)', 
            2: 'var(--color-accent-r3)'
        };
        
        let currentPhase = 'distance'; 
        let currentDegreesFor5cm = 0; 
        let adjustmentCounter = 0; 
        let currentStarRating = 2; 
        let isFinalized = false;
        let initialDegrees = 0; 
        
        let PRECISION_MIN = MIN_DEGREES; 
        let PRECISION_MAX = MAX_DEGREES; 
        
        // ç»å¯¹ä½ç½®æ¨¡å¼æ ¸å¿ƒå˜é‡
        let FIXED_STEP_PER_CM = 0; 
        let PRECISION_MIN_PerCM = 0; 
        let currentStepPosition = 0; // è®°å½•å½“å‰â€œå·²ç¡®è®¤â€çš„æ»‘å—ä½ç½® (-7 åˆ° +7)
        
        // =========================================================================
        // B. æ ¸å¿ƒè®¡ç®—å‡½æ•° (ç»å¯¹ä½ç½®æ¨¡å¼) - è¿™äº›å‡½æ•°ä¸éœ€è¦DOMï¼Œä¿æŒåœ¨å¤–éƒ¨
        // =========================================================================
        
        function toCM360(degrees) {
            return degrees === 0 ? Infinity : (5 * 360) / degrees;
        }

        function toDegreesFor5cm(cm360) {
            return cm360 === Infinity ? 0 : (5 * 360) / cm360;
        }

        function setHardPrecisionBounds(S0) {
            const index = ALL_STEPS.findIndex(step => Math.abs(step - S0) < TOLERANCE);
            
            if (index === -1) {
                PRECISION_MIN = MIN_DEGREES;
                PRECISION_MAX = MAX_DEGREES;
                PRECISION_MIN_PerCM = (360 / ((5 * 360) / PRECISION_MIN)); 
                FIXED_STEP_PER_CM = 0; 
                currentStepPosition = 0;
                return;
            }
            
            if (Math.abs(S0 - MIN_DEGREES) < TOLERANCE) {
                PRECISION_MIN = S0; 
                PRECISION_MAX = ALL_STEPS[Math.min(ALL_STEPS.length - 1, index + 1)];
            } else if (Math.abs(S0 - MAX_DEGREES) < TOLERANCE) {
                PRECISION_MIN = ALL_STEPS[Math.max(0, index - 2)]; 
                PRECISION_MAX = S0;
            } else {
                PRECISION_MIN = ALL_STEPS[Math.max(0, index - 2)]; 
                PRECISION_MAX = ALL_STEPS[Math.min(ALL_STEPS.length - 1, index + 1)]; 
            }

            const P_MAX_PerCM = (360 / ((5 * 360) / PRECISION_MAX)); 
            PRECISION_MIN_PerCM = (360 / ((5 * 360) / PRECISION_MIN)); 

            FIXED_STEP_PER_CM = (P_MAX_PerCM - PRECISION_MIN_PerCM) / 14; 
            
            // è®¡ç®— S0 çš„ç»å¯¹ä½ç½®å¹¶å¼ºåˆ¶å¯¹é½
            const P_S0_PerCM = (360 / ((5 * 360) / S0));
            const absoluteStepsFromMin = (P_S0_PerCM - PRECISION_MIN_PerCM) / FIXED_STEP_PER_CM;
            currentStepPosition = Math.round(absoluteStepsFromMin - 7);
            
            // ç«‹å³æ›´æ–° currentDegreesFor5cm ä¸ºå¯¹é½åçš„å€¼
            let newPerCM_at_grid = PRECISION_MIN_PerCM + (currentStepPosition + 7) * FIXED_STEP_PER_CM;
            currentDegreesFor5cm = toDegreesFor5cm(360 / newPerCM_at_grid);
        }

        /** æ ¹æ® sliderValue è®¡ç®—çµæ•åº¦ */
        function getDegreesFromSlider(sliderVal) {
            let newPerCM = PRECISION_MIN_PerCM + (sliderVal + 7) * FIXED_STEP_PER_CM;
            
            // å¼ºåˆ¶æˆªæ–­ (ä¿é™©æªæ–½)
            newPerCM = Math.max(PRECISION_MIN_PerCM, Math.min(
                PRECISION_MIN_PerCM + 14 * FIXED_STEP_PER_CM, 
                newPerCM 
            ));
            
            const newCM360 = 360 / newPerCM;
            return toDegreesFor5cm(newCM360);
        }

        // =========================================================================
        // C. çŠ¶æ€æ›´æ–°ä¸äº‹ä»¶å¤„ç† (åŒ…è£¹åœ¨DOMContentLoadedä¸­)
        // =========================================================================

        window.onload = function() { // ä½¿ç”¨ window.onload ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åŠ è½½

            // 1. DOM å˜é‡å®šä¹‰ (å¿…é¡»åœ¨è¿™é‡Œå®šä¹‰ï¼Œä»¥é¿å… null é”™è¯¯)
            const rootElement = document.documentElement;
            const distanceButtons = document.querySelectorAll('.distance-btn');
            const usabilityStars = document.querySelectorAll('#stars-container .star');
            const speedSlider = document.getElementById('speed-slider');
            const applyBtn = document.getElementById('apply-btn');
            const sensitivityResult = document.getElementById('sensitivity-result');
            const precisionRangeDisplay = document.getElementById('precision-range-display');
            const dpiInput = document.getElementById('dpi-input');
            const sensCS = document.getElementById('sens-cs');
            const sensVal = document.getElementById('sens-val');
            const sensOW = document.getElementById('sens-ow');
            const currentDpiDisplay = document.getElementById('current-dpi-display');
            const cm5UnitBtn = document.getElementById('cm5-unit');
            const cm360UnitBtn = document.getElementById('cm360-unit');


            /** è®¡ç®—æ¸¸æˆçµæ•åº¦å¹¶æ›´æ–°æ˜¾ç¤º */
            function calculateGameSensitivities() {
                const dpi = parseInt(dpiInput.value) || 400;
                currentDpiDisplay.textContent = dpi;
                
                if (currentDegreesFor5cm === 0) {
                    sensCS.textContent = 'N/A';
                    sensVal.textContent = 'N/A';
                    sensOW.textContent = 'N/A';
                    return;
                }

                const cm360 = toCM360(currentDegreesFor5cm);
                if (cm360 === Infinity) {
                    sensCS.textContent = 'N/A';
                    sensVal.textContent = 'N/A';
                    sensOW.textContent = 'N/A';
                    return;
                }

                const sensCSVal = CONST_CS / (cm360 * dpi);
                const sensValVal = CONST_VAL / (cm360 * dpi);
                const sensOWVal = CONST_OW / (cm360 * dpi);
                
                sensCS.textContent = sensCSVal.toFixed(4);
                sensVal.textContent = sensValVal.toFixed(4);
                sensOW.textContent = sensOWVal.toFixed(4);
            }

            function updateColors() {
                if (isFinalized) {
                    rootElement.style.setProperty('--current-accent', 'var(--color-warning)');
                    return;
                }
                const colorIndex = adjustmentCounter > 0 ? (adjustmentCounter - 1) % MAX_ADJUSTMENTS : 0;
                const colorVar = PHASE_COLORS[colorIndex] || PHASE_COLORS[0];
                rootElement.style.setProperty('--current-accent', colorVar);
            }

            function finalizeAdjustment(finalStatusMessage) {
                if (isFinalized) return;
                isFinalized = true;
                currentPhase = 'final';
                updateColors(); 
                updatePhaseDisplay();
                sensitivityResult.classList.add('final-result');
                document.querySelector('.main-sens-card').classList.add('finalized'); 
                console.log("æµç¨‹ç»“æŸ:", finalStatusMessage);
                updateDisplay(); 
            }

            function updatePhaseDisplay() {
                const distancePhase = document.getElementById('distance-phase');
                const speedPhase = document.getElementById('speed-phase');
                const usabilityPhase = document.getElementById('usability-phase');
                const adjustmentControls = document.getElementById('adjustment-controls');
                const actionButtons = document.getElementById('action-buttons');
                
                distancePhase.style.display = 'none';
                speedPhase.style.display = 'none';
                usabilityPhase.style.display = 'none';
                
                if (isFinalized) {
                    adjustmentControls.style.display = 'none';
                    actionButtons.style.display = 'none';
                    return; 
                }
                
                adjustmentControls.style.display = 'block';
                actionButtons.style.display = 'none'; 

                applyBtn.textContent = 'åº”ç”¨è°ƒæ•´';

                if (currentPhase === 'distance') {
                    distancePhase.style.display = 'block'; 
                    applyBtn.disabled = true; 
                } else if (currentPhase === 'speed') {
                    speedPhase.style.display = 'block'; 
                    actionButtons.style.display = 'flex'; 
                    applyBtn.disabled = false;
                    
                    // å…³é”®é€»è¾‘ï¼šæ— è®ºç¬¬å‡ è½®ï¼Œæ»‘å—éƒ½å¿…é¡»å¯¹é½åˆ°å½“å‰å·²ç¡®è®¤çš„ä½ç½®
                    speedSlider.value = currentStepPosition; 
                    document.getElementById('speed-value').textContent = currentStepPosition;
                    
                    document.getElementById('adjustment-count-display').textContent = `${adjustmentCounter + 1}`; 
                } else if (currentPhase === 'usability') {
                    usabilityPhase.style.display = 'block'; 
                    actionButtons.style.display = 'flex'; 
                    applyBtn.disabled = false;
                    applyBtn.textContent = 'ç¡®è®¤è¯„ä»·å¹¶åšå‡ºå†³ç­–';
                    document.getElementById('adjustment-count-display').textContent = `${adjustmentCounter}`;
                    
                    usabilityStars.forEach(star => {
                        star.classList.remove('active');
                        if (parseInt(star.dataset.rating) <= currentStarRating) {
                            star.classList.add('active');
                        }
                    });
                }
            }

            function updateDisplay() {
                if (currentDegreesFor5cm === 0) {
                     document.getElementById('current-base-d-step').textContent = "0.0000";
                     precisionRangeDisplay.textContent = "è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦";
                     sensitivityResult.textContent = "è¯·å…ˆé€‰æ‹©è¿œè¿‘çº¬åº¦";
                     document.getElementById('sensitivity-range').textContent = "";
                     calculateGameSensitivities();
                     return;
                }

                const cm360 = toCM360(currentDegreesFor5cm);
                const sensitivityRange = document.getElementById('sensitivity-range');

                if (cm360UnitBtn.classList.contains('active')) {
                    sensitivityResult.textContent = cm360.toFixed(2) + 'cm';
                    let rangeHint = `[360Â°] å¯¹åº”: ${currentDegreesFor5cm.toFixed(3)}Â°/5cm`;
                    sensitivityRange.textContent = rangeHint;
                } else { 
                    sensitivityResult.textContent = currentDegreesFor5cm.toFixed(3) + 'Â°';
                    let rangeHint = `[5cm] å¯¹åº”: ${cm360.toFixed(2)}cm/360Â°`;
                    sensitivityRange.textContent = rangeHint;
                }

                document.getElementById('current-base-d-step').textContent = FIXED_STEP_PER_CM.toFixed(4); 
                precisionRangeDisplay.textContent = `[${PRECISION_MIN.toFixed(3)}Â° åˆ° ${PRECISION_MAX.toFixed(3)}Â°]`;

                calculateGameSensitivities();
            }
            
            // --- æ ¸å¿ƒé€»è¾‘ï¼šåº”ç”¨è°ƒæ•´æŒ‰é’® ---
            function applySensitivityAdjustment() {
                if (isFinalized) {
                    finalizeAdjustment('æµç¨‹å·²é”å®š');
                    return;
                }
                
                if (currentPhase === 'speed') {
                    
                    const currentSliderVal = parseInt(speedSlider.value); // ç”¨æˆ·æ‹–åŠ¨åˆ°çš„ä½ç½®
                    const lockedPosition = currentStepPosition; // ç”¨æˆ·è¿›å…¥æ­¤è½®å‰çš„çŠ¶æ€
                    
                    // 1. è®¡ç®—å¹¶æ›´æ–°å½“å‰çµæ•åº¦ (åº”ç”¨è¯¥å€¼)
                    const newDegrees = getDegreesFromSlider(currentSliderVal);
                    currentDegreesFor5cm = newDegrees;
                    
                    // 2. é€»è¾‘ä¿®æ­£ï¼šè§¦é¡¶å³åœ
                    if (Math.abs(currentSliderVal) === 7) {
                        currentStepPosition = currentSliderVal; // æ›´æ–°ä½ç½®
                        adjustmentCounter++;
                        finalizeAdjustment(`å·²è§¦åŠè¾¹ç•Œ (${currentSliderVal})ï¼Œæµç¨‹è‡ªåŠ¨é”å®šã€‚æœ€ç»ˆçµæ•åº¦: ${currentDegreesFor5cm.toFixed(3)}Â°/5cm`);
                        return;
                    }

                    // 3. é€»è¾‘ä¿®æ­£ï¼šæ— å˜åŒ–å³åœ
                    if (currentSliderVal === lockedPosition) {
                        adjustmentCounter++; 
                        finalizeAdjustment(`æ‚¨é€‰æ‹©äº†ä¿æŒå½“å‰ä½ç½® (${currentSliderVal})ï¼Œç³»ç»Ÿåˆ¤å®šå½“å‰çµæ•åº¦ä¸ºæœ€ä½³ç»“æœã€‚`);
                        return;
                    }
                    
                    // 4. æ­£å¸¸æµç¨‹ï¼šä½ç½®æœ‰å˜åŒ–ï¼Œä¸”æœªè§¦é¡¶ -> è¿›å…¥è¯„ä»·é˜¶æ®µ
                    currentStepPosition = currentSliderVal; // ç¡®è®¤æ–°ä½ç½®
                    adjustmentCounter++; 

                    // ç»ˆç»“åˆ¤å®š (2è½®ä¸Šé™)
                    if (adjustmentCounter >= MAX_ADJUSTMENTS) {
                        finalizeAdjustment(`äºŒæ¬¡å¿«æ…¢è°ƒæ•´ï¼ˆç¬¬ ${MAX_ADJUSTMENTS} è½®ï¼‰å·²å®Œæˆã€‚æµç¨‹å¼ºåˆ¶ç»“æŸã€‚`);
                        return;
                    }
                    
                    // è¿›å…¥è¯„ä»·
                    currentPhase = 'usability';

                } else if (currentPhase === 'usability') {
                    
                    const rating = currentStarRating;
                    
                    if (rating === 3) {
                        finalizeAdjustment(`æ‚¨é€‰æ‹©äº† 3 æ˜Ÿè¯„ä»·ï¼Œç³»ç»Ÿå·²é”å®šå½“å‰çµæ•åº¦ (${currentDegreesFor5cm.toFixed(3)}Â°/5cm) ä¸ºæœ€ç»ˆç»“æœã€‚`);
                        return; 
                        
                    } else if (rating === 1) {
                        console.log("1æ˜Ÿé‡ç½®");
                        setTimeout(resetAll, 50); 
                        return;
                        
                    } else if (rating === 2) {
                        // 2æ˜Ÿ: ç»§ç»­ä¸‹ä¸€è½®
                        currentPhase = 'speed'; 
                        currentStarRating = 2;
                    }
                }
                
                updateDisplay(); 
                updatePhaseDisplay();
                updateColors(); 
            }
            
            function resetAll() {
                currentDegreesFor5cm = 0; 
                adjustmentCounter = 0;
                currentStarRating = 2; 
                isFinalized = false;
                currentPhase = 'distance';
                lastSpeedPhaseResult = null;
                PRECISION_MIN = MIN_DEGREES; 
                PRECISION_MAX = MAX_DEGREES;
                initialDegrees = 0;
                FIXED_STEP_PER_CM = 0; 
                currentStepPosition = 0; 

                applyBtn.disabled = true;
                sensitivityResult.classList.remove('final-result');
                document.querySelector('.main-sens-card').classList.remove('finalized'); 

                distanceButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('active');
                });
                usabilityStars.forEach(star => {
                    star.classList.remove('active');
                    if (parseInt(star.dataset.rating) === 2) {
                        star.classList.add('active');
                    }
                });
                
                cm5UnitBtn.classList.remove('active');
                cm360UnitBtn.classList.add('active'); 
                
                dpiInput.value = 400; 

                updateDisplay();
                updatePhaseDisplay();
                updateColors(); 
            }
            
            // =========================================================================
            // D. äº‹ä»¶ç»‘å®š
            // =========================================================================

            distanceButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (currentPhase !== 'distance' || isFinalized) return;
                    
                    const value = parseFloat(this.dataset.value);
                    initialDegrees = value; 
                    
                    setHardPrecisionBounds(value); 

                    distanceButtons.forEach(b => {
                        b.classList.remove('active');
                        b.disabled = true; 
                    });
                    this.classList.add('active');

                    currentPhase = 'speed';
                    
                    updateDisplay();
                    updatePhaseDisplay();
                    updateColors(); 
                });
            });
            
            usabilityStars.forEach(star => {
                star.addEventListener('click', function() {
                    if (currentPhase !== 'usability' || isFinalized) return;

                    const rating = parseInt(this.dataset.rating);
                    currentStarRating = rating;
                    
                    usabilityStars.forEach(s => {
                        s.classList.remove('active');
                        if (parseInt(s.dataset.rating) <= rating) {
                            s.classList.add('active');
                        }
                    });
                });
            });
            
            speedSlider.addEventListener('input', function() {
                const val = parseInt(this.value);
                document.getElementById('speed-value').textContent = val;
                applyBtn.disabled = false;
            });

            cm360UnitBtn.addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    this.classList.add('active');
                    cm5UnitBtn.classList.remove('active');
                    updateDisplay();
                }
            });
            
            cm5UnitBtn.addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    this.classList.add('active');
                    cm360UnitBtn.classList.remove('active');
                    updateDisplay();
                }
            });
            
            dpiInput.addEventListener('input', updateDisplay);

            applyBtn.addEventListener('click', applySensitivityAdjustment);
            document.getElementById('reset-btn').addEventListener('click', resetAll);
            
            // ç¡®ä¿åœ¨åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„é‡ç½®ï¼Œä¿è¯æ‰€æœ‰å…ƒç´ æ­£ç¡®å¯ç”¨
            resetAll();
        };
    </script>
</body>
</html>