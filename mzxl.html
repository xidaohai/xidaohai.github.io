<!DOCTYPE html>
<html lang="zh-CN" class="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„å‡†è®­ç»ƒåˆ†æ•°è®¡ç®—å™¨ (XDH)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                        darkinput: '#334155',
                    }
                }
            }
        }
    </script>
    <style>
        body, div, input, button, table, tr, td, th, span { transition: all 0.3s ease; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center bg-gray-100 text-gray-800 dark:bg-darkbg dark:text-gray-200">

    <div class="w-full max-w-6xl bg-white dark:bg-darkcard rounded-xl shadow-2xl p-6 border border-gray-200 dark:border-gray-700 relative">

        <button onclick="App.toggleTheme()" class="absolute top-6 right-6 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none transition z-10" title="åˆ‡æ¢é…è‰²">
            <svg class="w-6 h-6 text-yellow-500 dark:hidden block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg class="w-6 h-6 text-blue-300 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>

        <header class="text-center mb-8 mt-2">
            <h1 class="text-3xl font-extrabold text-blue-800 dark:text-blue-400 tracking-tight">ç„å‡†è®­ç»ƒåˆ†æ•°è®¡ç®—å™¨<span class="text-sm font-normal text-white align-middle bg-gradient-to-r from-blue-500 to-purple-600 px-2 py-0.5 rounded ml-2 shadow-sm">XDH</span></h1>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">åŸºäº [æ ‡å‡†åˆ†] ä¸ [éš¾åº¦å€¼ (L)/ç»éªŒå€¼ (E)] æ ¸å¿ƒç®—æ³•</p>
        </header>

        <div class="mb-8 p-5 bg-gray-50 dark:bg-[#151e2e] rounded-lg border border-gray-200 dark:border-gray-600 text-center text-sm">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <div class="bg-white dark:bg-darkinput p-3 rounded shadow-sm border-l-4 border-blue-500">
                    <span class="block text-gray-500 dark:text-gray-300 mb-1">æ ‡å‡†åˆ† (S)</span>
                    <span class="font-mono font-bold text-blue-700 dark:text-blue-300 text-lg">S = (åŸå§‹åˆ†æ•° Ã· åŠæ ¼çº¿) Ã— 100</span>
                    <div class="text-xs text-gray-400 mt-1">ä½œä¸ºè®¡ç®—éš¾åº¦å€¼çš„åŸºç¡€ã€‚åŠæ ¼ä¸º 100 åˆ†ã€‚</div>
                </div>
                
                <div class="bg-white dark:bg-darkinput p-3 rounded shadow-sm border-l-4 border-orange-500">
                    <span class="block text-gray-500 dark:text-gray-300 mb-1">éš¾åº¦å€¼ (L) (æ ¸å¿ƒå¼ºåº¦)</span>
                    <span class="font-mono font-bold text-orange-700 dark:text-orange-300 text-lg">L = 1 + [Î£(k+1) from k=1 to n] / 100</span>
                    <div class="text-xs text-gray-400 mt-1">
                        å…¶ä¸­ n = |æ ‡å‡†åˆ† - 100| å‘ä¸‹å–æ•´ã€‚<br>
                        <span class="font-mono">ç®€åŒ–å…¬å¼: L = 1 + [n Ã— (n + 3)] / 200</span>
                    </div>
                </div>

                <div class="bg-white dark:bg-darkinput p-3 rounded shadow-sm border-l-4 border-purple-500">
                    <span class="block text-gray-500 dark:text-gray-300 mb-1">ç»éªŒå€¼ (E)</span>
                    <span class="font-mono font-bold text-purple-700 dark:text-purple-300 text-lg">E = âˆšL</span>
                    <div class="text-xs text-gray-400 mt-1">
                        å…¶ä¸­çš„ L æŒ‡ä»£**éš¾åº¦å€¼** (éçº¿æ€§å…¬å¼)ã€‚<br>
                        <span class="text-red-400">ä»…å¯¹ L > 1 æœ‰æ•ˆ (éœ€è¶…åŠæ ¼çº¿)ã€‚</span>
                    </div>
                </div>
            </div>
        </div>

        <section class="mb-8 border-b border-gray-200 dark:border-gray-700 pb-8">
            <h3 class="text-lg font-bold text-indigo-700 dark:text-indigo-400 mb-4 flex items-center">
                <span class="w-1 h-6 bg-indigo-500 mr-2 rounded"></span> 1. å•é¡¹å¿«é€Ÿè®¡ç®—
            </h3>
            <div class="flex flex-col md:flex-row gap-4 items-end bg-indigo-50 dark:bg-[#1e2533] p-4 rounded-lg border border-indigo-100 dark:border-indigo-900/30">
                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase ml-1">é¡¹ç›®åŠæ ¼çº¿</label>
                    <input type="number" id="manualPass" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-darkinput text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚: 1400 (æ‚¨çš„ç¤ºä¾‹)">
                </div>
                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase ml-1">æ‚¨çš„å¾—åˆ†</label>
                    <input type="number" id="manualRaw" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-darkinput text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚: 1600 (æ‚¨çš„ç¤ºä¾‹)">
                </div>
                <button onclick="App.calcManual()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded shadow-lg transition w-full md:w-auto h-[50px]">
                    è®¡ç®—
                </button>
            </div>
            <div id="manualOutput" class="mt-3 ml-1 text-sm text-indigo-800 dark:text-indigo-300 font-mono font-semibold hidden bg-white dark:bg-darkinput p-3 rounded border border-indigo-100 dark:border-indigo-900 inline-block"></div>
        </section>

        <section>
            <h3 class="text-lg font-bold text-blue-700 dark:text-blue-400 mb-4 flex items-center">
                <span class="w-1 h-6 bg-blue-500 mr-2 rounded"></span> 2. æ‰¹é‡é¡¹ç›®å½•å…¥
            </h3>

            <div id="projectInputs" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
            </div>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8 p-6 bg-gray-50 dark:bg-[#151e2e] rounded-xl border border-gray-200 dark:border-gray-600">
                <button onclick="App.calcBatch()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg py-3 px-10 rounded-lg shadow-lg shadow-blue-500/30 transition transform hover:scale-105 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    æ‰¹é‡è®¡ç®—å¹¶ç”ŸæˆæŠ¥è¡¨
                </button>
                <div class="hidden md:block w-px h-10 bg-gray-300 dark:bg-gray-600 mx-2"></div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button onclick="App.exportData()" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        å¯¼å‡ºæ•°æ®
                    </button>
                    <button onclick="document.getElementById('fileInput').click()" class="flex-1 md:flex-none bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        å¯¼å…¥æ•°æ®
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".txt" onchange="App.importData(event)" class="hidden">
            </div>

            <div class="overflow-hidden rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                <table class="min-w-full bg-white dark:bg-darkcard text-sm text-left">
                    <thead class="bg-gray-800 dark:bg-black text-gray-200">
                        <tr>
                            <th class="py-4 px-4 font-medium tracking-wider">é¡¹ç›®åç§°</th>
                            <th class="py-4 px-4 font-medium tracking-wider">åŠæ ¼åˆ†</th>
                            <th class="py-4 px-4 font-medium tracking-wider">æ‚¨çš„å¾—åˆ†</th>
                            <th class="py-4 px-4 font-medium tracking-wider">æ ‡å‡†åˆ† (S)</th>
                            <th class="py-4 px-4 font-medium tracking-wider">å¼ºåº¦ (I)</th>
                            <th class="py-4 px-4 font-medium tracking-wider text-orange-400">éš¾åº¦å€¼ (L)</th>
                            <th class="py-4 px-4 font-medium tracking-wider text-purple-400">ç»éªŒå€¼ (E)</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody" class="divide-y divide-gray-100 dark:divide-gray-700 text-gray-700 dark:text-gray-300">
                        <tr><td colspan="7" class="p-8 text-center text-gray-400 dark:text-gray-500 italic">æš‚æ— æ•°æ®...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="summaryBox" class="mt-6 p-6 bg-gray-100 dark:bg-[#151e2e] rounded-xl text-center border border-gray-200 dark:border-gray-700 hidden transition-all">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white dark:bg-darkcard p-4 rounded-lg shadow-sm">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">å¹³å‡æ ‡å‡†åˆ†</div>
                        <div id="avgS" class="text-2xl font-extrabold text-gray-800 dark:text-white mt-1">0</div>
                    </div>
                    <div class="bg-white dark:bg-darkcard p-4 rounded-lg shadow-sm border-t-4 border-blue-500">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">å¹³å‡å¼ºåº¦</div>
                        <div id="avgI" class="text-2xl font-extrabold text-blue-700 dark:text-blue-400 mt-1">0</div>
                    </div>
                    <div class="bg-white dark:bg-darkcard p-4 rounded-lg shadow-sm border-t-4 border-orange-500">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">å¹³å‡éš¾åº¦å€¼</div>
                        <div id="avgL" class="text-2xl font-extrabold text-orange-700 dark:text-orange-400 mt-1">0</div>
                    </div>
                    <div class="bg-white dark:bg-darkcard p-4 rounded-lg shadow-sm border-t-4 border-purple-500">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">å¹³å‡ç»éªŒå€¼</div>
                        <div id="avgE" class="text-2xl font-extrabold text-purple-700 dark:text-purple-400 mt-1">0</div>
                    </div>
                </div>
                <div id="msgBox" class="text-sm text-gray-500 dark:text-gray-400 mt-4 font-medium"></div>
            </div>
        </section>
    </div>

    <script>
        // ============================================================
        // ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ ã€é…ç½®åŒºåŸŸã€‘ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢
        // ============================================================
        const PROJECT_CONFIG = [
            { name: "1wall 6targets TE",software: "Kovaak", passScore: 220 },

            { name: "1wall 6targets small",software: "Kovaak", passScore: 1400 },
            { name: "1w6ts_trustechain Raspberry",software: "Kovaak", passScore: 160 },

            { name: "VT 1w2ts Advanced S5", software: "Kovaak", passScore: 1300 },
            { name: "1w2ts Vertical Flicks V2", software: "Kovaak", passScore: 100 },
            { name: "Raw mouse control clicking3",software: "Kovaak", passScore: 2800 },

            { name: "1wall5targets Pasu Reload", software: "Kovaak", passScore: 115 },
            { name: "Valorant Fireworks Flick Horizontal EXsmall", software: "Kovaak", passScore: 600 },
            { name: "eth FarSkeet", software: "Kovaak", passScore: 700 },
            { name: "Plaza Pure Revosect Int", software: "Kovaak", passScore: 870 },
            { name: "ReactiveStrafe SuperbAim", software: "Kovaak", passScore: 2600 },
            { name: "Controlsphere", software: "Kovaak", passScore: 10000 },

            { name: "Gridshot Ultimate",software: "AimLab", passScore: 114000 },
            { name: "Sixshot Ultimate",software: "AimLab", passScore: 140000 },

            { name: "å¾…æ›´æ–°",software: "å¾…æ›´æ–°",   passScore: 0 }
        ];
        // ============================================================

        const App = {
            toggleTheme: () => document.documentElement.classList.toggle('dark'),

            // ğŸ†• æ–°å¢: ä»é¡¹ç›®åç§°ç”Ÿæˆé¡¹ç›®ID
            getProjectId: (name) => {
                // è½¬æ¢ä¸ºå°å†™ï¼Œå¹¶ç§»é™¤æ‰€æœ‰éå­—æ¯æ•°å­—å­—ç¬¦ã€‚
                // ä¾‹å¦‚: "Tile Frenzy" -> "tilefrenzy"
                // è­¦å‘Š: æ­¤å‡½æ•°ç”Ÿæˆçš„æ–°IDä¸æ—§é…ç½®æ–‡ä»¶ä¸­ç¡¬ç¼–ç çš„IDå¯èƒ½ä¸ä¸€è‡´ï¼Œè¯·ä½¿ç”¨æ–°ç‰ˆæœ¬å¯¼å‡ºæ•°æ®ã€‚
                return name.toLowerCase().replace(/[^a-z0-9]+/g, ''); 
            },

            algo: {
                calc: (raw, pass) => {
                    // 1. æ ‡å‡†åˆ† S (100-base)
                    const S = (raw / pass) * 100;
                    
                    // 2. å¼ºåº¦ I (çº¿æ€§æ¯”ä¾‹ï¼ŒI = raw / pass)
                    const I_new = raw / pass;
                    
                    // 3. éš¾åº¦å€¼ L (éçº¿æ€§ä¿®æ­£ï¼Œç”¨äºè®¡ç®—E) 
                    const n_diff = S - 100;
                    // næ˜¯ |æ ‡å‡†åˆ†-100| çš„å‘ä¸‹å–æ•´å€¼
                    const n_int = Math.floor(Math.abs(n_diff)); 

                    let R_new = 0;
                    if (n_int > 0) {
                        // R_new = Î£(k+1), k=1 to n_int
                        // Sum(k=1 to n) of (k+1) = [ (n+1)(n+2)/2 ] - 1
                        const sum_j_plus_1 = ((n_int + 1) * (n_int + 2)) / 2;
                        // å¥–åŠ±ç‚¹æ•°ï¼Œä¾‹å¦‚ n=5 æ—¶ä¸º 20
                        R_new = (sum_j_plus_1 - 1); 
                    }
                    
                    // 5. éš¾åº¦å€¼åŸå§‹å€¼ I_raw (åœ¨ 100 é™„è¿‘)
                    // I_raw = 100 + sign * R_new
                    const I_raw = 100 + Math.sign(n_diff) * R_new; 
                    
                    // 6. éš¾åº¦å€¼ L (I_star) - L = I_raw / 100 (å³ L = 1 + sign * R_new / 100)
                    const L = I_raw * 0.01; 
                    
                    // 4. ç»éªŒå€¼ E = âˆšL
                    let E = null; 
                    
                    if (L > 1) { // ä»…åœ¨ L > 1 (å³å¾—åˆ†è¶…è¿‡åŠæ ¼çº¿) æ—¶è®¡ç®— E
                        E = Math.sqrt(L);
                    }
                    
                    return { 
                        S: parseFloat(S.toFixed(3)), // æ ‡å‡†åˆ†
                        I: parseFloat(I_new.toFixed(3)), // çº¿æ€§å¼ºåº¦
                        I_star: parseFloat(L.toFixed(4)), // L (éš¾åº¦å€¼, ç²¾åº¦æé«˜åˆ°4ä½æ–¹ä¾¿è§‚å¯Ÿé˜¶æ¢¯å˜åŒ–)
                        E: E !== null ? parseFloat(E.toFixed(3)) : null // ç»éªŒå€¼
                    };
                }
            },

            getThemeProps: (software) => {
                const s = software.toLowerCase();
                if (s.includes('kovaak')) {
                    return { border: 'border-orange-200 dark:border-orange-800', text: 'text-orange-600 dark:text-orange-400', badge: 'bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300', ring: 'focus:ring-orange-500' };
                } else if (s.includes('aimlab')) {
                    return { border: 'border-blue-200 dark:border-blue-800', text: 'text-blue-600 dark:text-blue-400', badge: 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300', ring: 'focus:ring-blue-500' };
                } else {
                    return { border: 'border-gray-300 dark:border-gray-600', text: 'text-gray-800 dark:text-gray-200', badge: 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300', ring: 'focus:ring-gray-500' };
                }
            },

            // å¤åˆ¶é¡¹ç›®åç§°åˆ°å‰ªè´´æ¿
            copyProjectName: (name) => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(name).then(() => {
                        // å¤åˆ¶æˆåŠŸï¼Œç»™äºˆç”¨æˆ·åé¦ˆ
                        alert(`é¡¹ç›®åç§°ã€${name}ã€‘å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼`);
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ document.execCommand
                        App.fallbackCopyTextToClipboard(name);
                    });
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒ navigator.clipboardï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                    App.fallbackCopyTextToClipboard(name);
                }
            },
            
            // å¤‡ç”¨å¤åˆ¶å‡½æ•°ï¼ˆå…¼å®¹æ€§ï¼‰
            fallbackCopyTextToClipboard: (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; // é¿å…æ»šåŠ¨åˆ°è§†å›¾å¤–
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? 'æˆåŠŸ' : 'å¤±è´¥';
                    alert(`ã€${text}ã€‘å¤åˆ¶${msg}ï¼(ä½¿ç”¨å¤‡ç”¨å¤åˆ¶)`);
                } catch (err) {
                    console.error('å¤‡ç”¨å¤åˆ¶å¤±è´¥', err);
                    alert(`æ— æ³•å¤åˆ¶ã€${text}ã€‘åˆ°å‰ªè´´æ¿ã€‚è¯·æ‰‹åŠ¨å¤åˆ¶ã€‚`);
                }
                document.body.removeChild(textArea);
            },


            // ğŸ› ï¸ æ ¼å¼åŒ–ç»éªŒå€¼æ˜¾ç¤º
            formatEffort: (E_val, I_new) => {
                // E_val (ç»éªŒå€¼) æ˜¯æœ‰æ•ˆæ•°å­—æ—¶
                if (E_val !== null) {
                    return {
                        text: E_val.toFixed(3), // Just the number (e.g., "1.480")
                        color: 'text-purple-700 dark:text-purple-400'
                    };
                } else {
                    // E_val æ— æ•ˆæ—¶ (L <= 1)ï¼Œå›é€€åˆ°çº¿æ€§å¼ºåº¦ç™¾åˆ†æ¯”æ˜¾ç¤º
                    const percent = (I_new * 100).toFixed(0); 
                    return { 
                        text: percent + '%', // Appends "%" (e.g., "95%")
                        color: 'text-red-500 dark:text-red-400' 
                    };
                }
            },

            init: () => {
                const container = document.getElementById('projectInputs');
                container.innerHTML = PROJECT_CONFIG.map(p => {
                    const theme = App.getThemeProps(p.software);
                    // ä½¿ç”¨ getProjectId(p.name) ä»£æ›¿ p.id
                    const projectId = App.getProjectId(p.name);
                    return `
                    <div class="bg-gray-50 dark:bg-darkinput p-4 rounded-lg border ${theme.border} flex flex-col transition hover:shadow-md cursor-pointer" onclick="App.copyProjectName('${p.name}')">
                        
                        <div class="flex items-start justify-between mb-1">
                            <div class="text-xs font-bold ${theme.text} uppercase tracking-wider">${p.software}</div>
                            <span class="text-xs font-mono px-1.5 py-0.5 rounded ${theme.badge} self-start">åŠæ ¼:${p.passScore}</span>
                        </div>
                        
                        <div class="text-sm font-bold text-gray-800 dark:text-gray-200 mb-2" title="${p.name}">
                            ${p.name}
                        </div>
                        <input type="number" id="in_${projectId}" placeholder="è¾“å…¥å¾—åˆ†" class="w-full p-2 border border-gray-300 dark:border-gray-500 rounded text-sm bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white focus:ring-2 ${theme.ring} outline-none transition" onclick="event.stopPropagation()">
                    </div>
                `}).join('');
            },

            calcManual: () => {
                const pass = parseFloat(document.getElementById('manualPass').value);
                const raw = parseFloat(document.getElementById('manualRaw').value);
                const out = document.getElementById('manualOutput');
                if (!pass || !raw || raw < 0) {
                    out.innerText = "è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼";
                    out.classList.remove('hidden', 'text-indigo-800', 'dark:text-indigo-300', 'text-red-600');
                    out.classList.add('text-red-600');
                    return;
                }
                const res = App.algo.calc(raw, pass);
                const effDisplay = App.formatEffort(res.E, res.I);
                
                // I å¼ºåº¦å³ I_new (raw/pass)
                out.innerHTML = `æ ‡å‡†åˆ†: <span class="font-bold">${res.S.toFixed(3)}</span> | å¼ºåº¦(I): <span class="font-bold">${res.I.toFixed(3)}å€</span> | éš¾åº¦å€¼(L): <span class="font-bold text-orange-700 dark:text-orange-400">${res.I_star.toFixed(4)}å€</span> | ç»éªŒå€¼(E): <span class="font-bold ${effDisplay.color}">${effDisplay.text}${res.E !== null ? 'å€' : ''}</span>`;
                out.classList.remove('hidden', 'text-red-600');
                out.classList.add('text-indigo-800', 'dark:text-indigo-300');
            },

            calcBatch: () => {
                const tbody = document.getElementById('resultBody');
                tbody.innerHTML = '';
                // ADDED I_star accumulator
                let sums = { S: 0, I: 0, I_star: 0, E: 0, count: 0, eCount: 0 }; 

                PROJECT_CONFIG.forEach(p => {
                    // ä½¿ç”¨ getProjectId(p.name) ä»£æ›¿ p.id
                    const projectId = App.getProjectId(p.name);
                    const input = document.getElementById(`in_${projectId}`);
                    const val = parseFloat(input.value);
                    if (isNaN(val) || val <= 0) return;

                    const res = App.algo.calc(val, p.passScore);
                    sums.S += res.S; 
                    sums.I += res.I; 
                    sums.I_star += res.I_star; // ACCUMULATE L
                    if (res.E !== null) {
                        sums.E += res.E; 
                        sums.eCount++; // ä»…ç»Ÿè®¡æœ‰æ•ˆç»éªŒå€¼ç”¨äºå¹³å‡
                    }
                    sums.count++;

                    const effDisplay = App.formatEffort(res.E, res.I);

                    const row = `
                        <tr class="hover:bg-blue-50 dark:hover:bg-blue-900/20 transition">
                            <td class="p-4 font-medium text-gray-800 dark:text-gray-200">${p.software} - ${p.name}</td>
                            <td class="p-4 text-blue-600 dark:text-blue-400 font-mono">${p.passScore}</td>
                            <td class="p-4 font-bold font-mono ${val >= p.passScore ? 'text-green-600 dark:text-green-400' : 'text-red-500 dark:text-red-400'}">${val}</td>
                            <td class="p-4 font-mono font-semibold text-gray-700 dark:text-gray-300">${res.S.toFixed(3)}</td>
                            <td class="p-4 font-bold text-blue-700 dark:text-blue-400 text-xl">${res.I.toFixed(3)}å€</td>
                            <td class="p-4 font-bold text-orange-700 dark:text-orange-400 text-xl">${res.I_star.toFixed(4)}å€</td>
                            <td class="p-4 font-bold ${effDisplay.color} text-xl">${effDisplay.text}${res.E !== null ? 'å€' : ''}</td>
                        </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });

                const summaryBox = document.getElementById('summaryBox');
                summaryBox.classList.remove('hidden');
                
                if (sums.count > 0) {
                    const avgS = (sums.S / sums.count).toFixed(2);
                    const avgI = (sums.I / sums.count).toFixed(3);
                    const avgL = (sums.I_star / sums.count).toFixed(4); // CALCULATE AVG L
                    // ä»…è®¡ç®—æœ‰æ•ˆç»éªŒå€¼çš„å¹³å‡
                    const avgE = sums.eCount > 0 ? (sums.E / sums.eCount).toFixed(3) : "0.000";

                    document.getElementById('avgS').innerText = avgS;
                    document.getElementById('avgI').innerText = avgI;
                    document.getElementById('avgL').innerText = avgL; // SET AVG L
                    document.getElementById('avgE').innerText = avgE;
                    document.getElementById('msgBox').innerText = `æˆåŠŸè®¡ç®— ${sums.count} ä¸ªé¡¹ç›® (å…¶ä¸­ ${sums.eCount} ä¸ªäº§ç”Ÿæœ‰æ•ˆç»éªŒå€¼)`;
                } else {
                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç¡®ä¿å ä½è¡Œæ­£ç¡®æ˜¾ç¤º
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400 dark:text-gray-500 italic">æš‚æ— æ•°æ®...</td></tr>';
                    ['avgS', 'avgI', 'avgL', 'avgE'].forEach(id => document.getElementById(id).innerText = '0'); // RESET AVG L
                    document.getElementById('msgBox').innerText = "æœªæ£€æµ‹åˆ°æœ‰æ•ˆè¾“å…¥";
                }
            },

            exportData: () => {
                let blocks = [];
                PROJECT_CONFIG.forEach(p => {
                    // ä½¿ç”¨ getProjectId(p.name) ä»£æ›¿ p.id
                    const projectId = App.getProjectId(p.name);
                    const val = parseFloat(document.getElementById(`in_${projectId}`).value);
                    if (!isNaN(val) && val > 0) {
                        const res = App.algo.calc(val, p.passScore);
                        const effDisplay = App.formatEffort(res.E, res.I);
                        // å¯¼å‡ºæ•°æ®ä¸­ L (éš¾åº¦å€¼) å’Œ E (ç»éªŒå€¼) å‡ä½¿ç”¨é«˜ç²¾åº¦
                        blocks.push(`${p.software}, ${projectId},\nåŠæ ¼åˆ†${p.passScore}, åŸå§‹åˆ†${val},\næ ‡å‡†${res.S.toFixed(3)}åˆ†, å¼ºåº¦${res.I.toFixed(3)}å€, éš¾åº¦å€¼${res.I_star.toFixed(4)}å€, ç»éªŒå€¼${effDisplay.text}å€`);
                    }
                });
                if (blocks.length === 0) return alert("æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®");
                const content = "--- XDH Â· ç„å‡†å¼ºåº¦è®¡ç®—å™¨æ•°æ® ---\n\n# æ ¼å¼: è½¯ä»¶åï¼Œé¡¹ç›®IDã€‚\nåŠæ ¼åˆ†ï¼ŒåŸå§‹åˆ†ã€‚\næ ‡å‡†åˆ†ï¼Œå¼ºåº¦ï¼Œéš¾åº¦å€¼ï¼Œç»éªŒå€¼\n\n" + blocks.join('\n\n');
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `ç„å‡†å¼ºåº¦æ•°æ®_${new Date().toISOString().slice(0, 10)}.txt`;
                a.click();
            },

            importData: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    let count = 0;
                    document.querySelectorAll('input[id^="in_"]').forEach(el => el.value = '');
                    PROJECT_CONFIG.forEach(p => {
                         // ä½¿ç”¨ getProjectId(p.name) ä»£æ›¿ p.id
                        const projectId = App.getProjectId(p.name);
                        // å¯¼å…¥é€»è¾‘ä¿æŒè¯»å– "åŸå§‹åˆ†"
                        // æ³¨æ„: æ­£åˆ™è¡¨è¾¾å¼ç°åœ¨åŸºäºæ–°ç”Ÿæˆçš„ projectId
                        const match = text.match(new RegExp(`${projectId},\\s*[\\s\\S]*?åŸå§‹åˆ†([0-9\\.]+)`));
                        if (match && match[1]) {
                            const input = document.getElementById(`in_${projectId}`);
                            if (input) { input.value = match[1]; count++; }
                        }
                    });
                    if (count > 0) { App.calcBatch(); alert(`æˆåŠŸå¯¼å…¥ ${count} ä¸ªé¡¹ç›®çš„æˆç»©ï¼`); }
                    else alert("æœªæ‰¾åˆ°åŒ¹é…æ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦ä¸ºæœ€æ–°ç‰ˆå¯¼å‡ºæ ¼å¼ã€‚");
                };
                reader.readAsText(file);
                e.target.value = ''; 
            }
        };
        window.onload = App.init;
    </script>
</body>
</html>