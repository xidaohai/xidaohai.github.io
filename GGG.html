<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瞄准训练分数努力度计算器</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义配置 Tailwind */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* 使背景平滑渐变，提升视觉效果 */
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 10vh;
        }
        /* 确保输入框和表格行在视口变化时保持一致性 */
        .input-group input {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10 border border-gray-100">

        <!-- 标题 -->
        <header class="text-center mb-8">
            <h1 class="3xl sm:text-4xl font-extrabold text-blue-800 tracking-tight">
                瞄准训练分数努力度计算器
            </h1>
            <p class="text-gray-500 mt-2 text-lg">基于[强制100分]与[强度/努力度]公式</p>
        </header>

        <!-- 核心计算公式展示区 -->
        <div class="mb-8 p-6 bg-gray-100 rounded-lg border border-gray-300 shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 text-center border-b border-gray-300 pb-2">
                核心计算公式
            </h2>
            <!-- 已改为单列平铺 (grid-cols-1) -->
            <div class="grid grid-cols-1 gap-4 text-center"> 
                <!-- 公式 1: 标准分 -->
                <div class="bg-white p-4 rounded-lg shadow-inner">
                    <p class="text-base text-gray-600 mb-1 font-medium">强制100分公式</p>
                    <p class="text-xl font-mono font-bold text-blue-700">标准分 = (原始分数 ÷ 及格线) × 100</p>
                </div>
                <!-- 公式 2: 强度公式 & 努力公式 -->
                <div class="bg-white p-4 rounded-lg shadow-inner">
                    <p class="text-base font-medium text-gray-600 mb-1">强度公式</p>
                    <p class="text-xl font-mono font-bold text-indigo-700">强度 = 100 + [n × (n + 3)] ÷ 20</p>
                    <p class="text-sm text-gray-500 mt-1">（其中 n = 标准分 - 100）</p>
                    
                    <div class="mt-3">
                        <p class="text-sm text-gray-600 font-semibold border-t border-gray-300 pt-2">强度判定规则 (奖励与惩罚对称):</p>
                        <ul class="text-xs text-gray-500 list-disc list-inside ml-2 text-left space-y-1">
                            <li>n = 标准分 - 100。n为正数时获得奖励，n为负数时施加惩罚。</li>
                            <li>奖励/惩罚幅度 (R) = [|n| × (|n| + 3)] ÷ 20。</li>
                            <li>最终强度 (I) = 100 + n 的符号 × R。</li>
                            <li class="font-bold text-blue-600 mt-1">努力公式: 努力度 = 强度 ÷ 100 × 2</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. 快速计算 - 单个项目手动输入区 -->
        <section class="mb-8 p-6 bg-indigo-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4 border-b border-indigo-200 pb-2">
                1. 单个项目快速计算 (自定义输入)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 input-group">
                <!-- 训练项目名称 (可编辑) -->
                <div>
                    <label for="manualProjectName" class="block text-sm font-medium text-gray-700 mb-1">项目名称</label>
                    <input type="text" id="manualProjectName" placeholder="如：新测试项目" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <!-- 项目及格分数线 (可编辑) -->
                <div>
                    <label for="manualPassScore" class="block text-sm font-medium text-gray-700 mb-1">项目及格线</label>
                    <input type="number" id="manualPassScore" placeholder="如: 1300" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <!-- 原始分数 (可编辑) -->
                <div>
                    <label for="manualRawScore" class="block text-sm font-medium text-gray-700 mb-1">您的得分</label>
                    <input type="number" id="manualRawScore" placeholder="您的实际分数" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            
            <!-- 计算按钮 -->
            <div class="mt-8 text-center">
                <button onclick="calculateManualScore()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                    计算单个得分
                </button>
            </div>
            
            <!-- 单个计算结果显示 -->
            <div id="manualResultDisplay" class="mt-6 bg-white p-4 rounded-lg border-l-4 border-indigo-500 shadow-md hidden">
                <div class="text-sm font-medium text-indigo-700">单项结果</div>
                <div id="manualScoreOutput" class="text-xl font-bold text-indigo-900 mt-1">---</div>
                <div id="manualStatus" class="text-base mt-2"></div>
            </div>
        </section>

        <!-- 2. 批量计算 - 预设项目列表输入区 (及格分) -->
        <section class="mb-8 p-6 bg-yellow-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold text-yellow-700 mb-4 border-b border-yellow-200 pb-2">
                2. 批量项目得分输入 (及格分)
            </h2>
            <div id="predefinedProjectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Project cards will be injected here by JavaScript -->
            </div>

            <!-- 批量计算按钮 -->
            <div class="mt-8 text-center">
                <button onclick="calculateBatchScores()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                    批量计算并更新表格
                </button>
            </div>
        </section>

        <!-- 3. 统一计算结果 -->
        <section>
            <h2 class="text-xl font-semibold text-blue-700 mb-4 border-b border-blue-200 pb-2">
                3. 批量计算结果表格
            </h2>

            <!-- 动态结果表格 -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-md">
                    <thead class="bg-gray-700 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-medium">项目名称</th>
                            <th class="py-3 px-4 text-left text-sm font-medium">及格分</th>
                            <th class="py-3 px-4 text-left text-sm font-medium">您的得分</th>
                            <th class="py-3 px-4 text-left text-sm font-medium">与100分差值 (n)</th> 
                            <th class="py-3 px-4 text-left text-sm font-medium">标准分</th> 
                            <th class="py-3 px-4 text-left text-sm font-medium">最终强度 (I)</th>
                            <th class="py-3 px-4 text-left text-sm font-medium">努力公式结果 (努力度)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="divide-y divide-gray-200">
                        <!-- Calculation results will be displayed here -->
                    </tbody>
                </table>
            </div>

            <!-- 最终结果总结/提示 -->
            <div id="batchSummaryContainer" class="mt-8 bg-gray-200 text-gray-700 p-4 rounded-lg text-center font-semibold text-lg transition-colors duration-300">
                
                <!-- 新增：导出/导入按钮 -->
                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 mb-4">
                    <button onclick="exportScoresToTxt()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        导出成绩 (.txt)
                    </button>
                    <button onclick="document.getElementById('fileInput').click()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        导入成绩 (.txt)
                    </button>
                    <!-- 隐藏的文件输入框，用于触发文件选择和导入逻辑 -->
                    <input type="file" id="fileInput" accept=".txt" onchange="importScoresFromTxt(event)" class="hidden">
                </div>
                <!-- 结束：导出/导入按钮 -->

                <div id="batchResultText">批量计算结果将在此处显示。</div>
                <div id="averageScoreOutput" class="mt-2 hidden"></div>
            </div>
        </section>

    </div>
    
    <!-- JavaScript 用于计算逻辑 -->
    <script>
        // =================================================================
        // 【数据源管理核心】
        // 如需增删训练项目，只需修改此数组即可。
        // ID 必须唯一，用于生成输入框的 ID。
        // =================================================================
        const predefinedProjects = [
            // KovaaK 项目
            { id: "1w6s", name: "KovaaK - 1W6S", passScore: 1300 },
            { id: "air", name: "KovaaK - Air", passScore: 2300 },
            { id: "tilefrenzy", name: "KovaaK - Tile Frenzy", passScore: 950 },
            // AimLab 项目
            { id: "gridshot", name: "AimLab - Gridshot Ultimate", passScore: 90000 },
            { id: "reflexshot", name: "AimLab - Reflexshot", passScore: 400 },
            { id: "audiospatial", name: "AimLab - Audiospatial", passScore: 450 }
        ];
        // =================================================================

        /**
         * 统一显示摘要信息和错误/警告，以替换 alert()。
         * @param {string} text - 要显示的消息文本。
         * @param {boolean} isError - 是否为错误或警告消息 (影响颜色)。
         */
        function showSummaryMessage(text, isError = false) {
            const batchSummaryContainer = document.getElementById('batchSummaryContainer');
            const batchResultText = document.getElementById('batchResultText');
            const averageScoreOutput = document.getElementById('averageScoreOutput');
            
            // 重置样式和可见性
            batchSummaryContainer.className = 'mt-8 p-4 rounded-lg text-center font-semibold text-lg transition-colors duration-300';
            averageScoreOutput.classList.add('hidden');

            if (isError) {
                batchSummaryContainer.classList.add('bg-red-100', 'text-red-800');
            } else {
                // 默认成功/提示色
                batchSummaryContainer.classList.add('bg-gray-200', 'text-gray-700');
            }
            batchResultText.textContent = text;
        }

        /**
         * 渲染预设项目卡片列表，包含得分输入框。
         */
        function renderPredefinedProjects() {
            const container = document.getElementById('predefinedProjectsList');
            container.innerHTML = ''; 

            predefinedProjects.forEach((project) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                
                // 输入框的 ID 始终基于 project.id，保持唯一性和可维护性
                const inputId = `rawScore_${project.id}`;
                
                card.innerHTML = `
                    <div class="text-lg font-bold text-gray-800">${project.name}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        及格分: 
                        <span class="font-mono text-blue-600 font-semibold">${project.passScore}</span>
                    </div>
                    
                    <div class="mt-3">
                        <label for="${inputId}" class="block text-xs font-medium text-gray-700 mb-1">您的得分</label>
                        <input type="number" id="${inputId}" placeholder="请输入得分" min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 transition duration-150 text-base">
                    </div>
                `;
                container.appendChild(card);
            });
        }

        /**
         * 核心计算逻辑：计算单个项目的标准分、强度和努力度得分
         * @param {number} rawScore - 原始得分
         * @param {number} passScore - 及格线
         * @returns {{S: number, n: number, I: number, E_effort: number, status: string}} 结果对象
         */
        function calculateSingleScore(rawScore, passScore) {
            // S (标准分) = (R / Ppass) × 100
            const S = (rawScore / passScore) * 100;
            
            // n (与100分的差值) = S - 100
            const n = S - 100; 
            
            // 奖励/惩罚幅度 R_mag 的核心计算公式 (使用 n 的绝对值)
            const n_abs = Math.abs(n);
            // R_mag = [|n| × (|n| + 3)] ÷ 20
            const R_mag = (n_abs * (n_abs + 3)) / 20;

            // 1. I (最终强度) = 100 + n 的符号 × R_mag
            const I = 100 + Math.sign(n) * R_mag;
            
            // 2. E_effort (努力公式结果/努力度) = 强度 ÷ 100 × 2
            const E_effort = (I / 100) * 2;
            
            let status;
            if (n > 0) {
                status = "达标 (获得强度奖励)";
            } else if (n < 0) {
                status = "未达标 (施加强度惩罚)";
            } else {
                status = "刚好及格 (强度 = 100)";
            }

            // 返回精简结果，只包含表格和手动输出所需的字段
            return {
                S: parseFloat(S.toFixed(2)),
                n: parseFloat(n.toFixed(2)), 
                I: parseFloat(I.toFixed(2)), 
                E_effort: parseFloat(E_effort.toFixed(2)), 
                status: status
            };
        }
        
        /**
         * 计算手动输入区的单个得分
         */
        function calculateManualScore() {
            const passScore = parseFloat(document.getElementById('manualPassScore').value);
            const rawScore = parseFloat(document.getElementById('manualRawScore').value);

            const displayDiv = document.getElementById('manualResultDisplay');
            const outputDiv = document.getElementById('manualScoreOutput');
            const statusDiv = document.getElementById('manualStatus');

            // 验证输入
            if (isNaN(passScore) || passScore <= 0 || isNaN(rawScore) || rawScore < 0) {
                outputDiv.textContent = '输入错误';
                statusDiv.textContent = '请确保及格线大于 0，得分是非负数。';
                displayDiv.classList.remove('hidden');
                return;
            }

            const scores = calculateSingleScore(rawScore, passScore);
            const effortMultiple = (scores.I / 100).toFixed(2);
            const simpleStatus = scores.status.replace(/\s*\(.*\)/g, ''); // 移除括号内容

            // 更新 UI
            outputDiv.textContent = `标准分: ${scores.S} | 强度(I): ${scores.I} | 努力度: ${scores.E_effort}`;
            statusDiv.textContent = `状态: ${simpleStatus} | 努力程度是一般人的 ${effortMultiple} 倍`;
            displayDiv.classList.remove('hidden');
        }

        /**
         * 计算所有有效项目的平均得分
         * @param {Array<number>} effortScores 
         * @param {Array<number>} standardScores 
         * @param {Array<number>} intensityScores 
         * @param {number} count 
         * @returns {{averageE: number, averageS: number, averageI: number}} 平均值对象
         */
        function getAverageScores(effortScores, standardScores, intensityScores, count) {
            if (count === 0) return { averageE: 0, averageS: 0, averageI: 0 };

            const sumE = effortScores.reduce((sum, score) => sum + score, 0);
            const sumS = standardScores.reduce((sum, score) => sum + score, 0);
            const sumI = intensityScores.reduce((sum, score) => sum + score, 0);

            return {
                averageE: sumE / count,
                averageS: sumS / count,
                averageI: sumI / count,
            };
        }


        /**
         * 批量计算所有预设项目的得分
         */
        function calculateBatchScores() {
            const resultsTableBody = document.getElementById('resultsTableBody');
            resultsTableBody.innerHTML = ''; 
            
            let calculatedCount = 0;
            const effortScores = []; 
            const standardScores = []; 
            const intensityScores = []; 

            predefinedProjects.forEach(project => {
                const inputId = `rawScore_${project.id}`;
                // 通过 project.id 拼接 ID 访问输入框，确保增删项目时这里的逻辑不变
                const rawScoreInput = document.getElementById(inputId).value;
                const rawScore = parseFloat(rawScoreInput);

                // 检查输入有效性
                if (isNaN(rawScore) || rawScore <= 0) {
                    return; 
                }

                calculatedCount++;

                const passScore = project.passScore;
                const scores = calculateSingleScore(rawScore, passScore);
                
                // 存储数据以计算平均值
                effortScores.push(scores.E_effort); 
                standardScores.push(scores.S);
                intensityScores.push(scores.I);
                
                // 表格行 '您的得分' 颜色判断
                const scoreColorClass = rawScore >= passScore ? 'text-green-700' : 'text-red-700';

                // 创建表格行
                const row = document.createElement('tr'); 
                row.className = 'hover:bg-gray-50 transition duration-100'; 

                row.innerHTML = `
                    <td class="py-3 px-4 font-semibold text-gray-800">${project.name}</td>
                    <!-- 及格分: 蓝色 -->
                    <td class="py-3 px-4 font-mono text-blue-700">${passScore}</td>
                    <!-- 您的得分: 绿色/红色 -->
                    <td class="py-3 px-4 font-mono font-bold ${scoreColorClass}">${rawScore}</td>
                    
                    <td class="py-3 px-4 font-mono text-gray-800">${scores.n}</td> 
                    <td class="py-3 px-4 font-bold text-gray-800">${scores.S}</td>
                    
                    <!-- 最终强度 (I): 紫色 -->
                    <td class="py-3 px-4 text-lg font-extrabold text-purple-700">${scores.I}</td>
                    <!-- 努力度: 紫色 -->
                    <td class="py-3 px-4 text-lg font-extrabold text-purple-700">${scores.E_effort}</td>
                `;
                resultsTableBody.appendChild(row);
            });

            // 获取总结 UI 元素
            const batchSummaryContainer = document.getElementById('batchSummaryContainer');
            const batchResultText = document.getElementById('batchResultText');
            const averageScoreOutput = document.getElementById('averageScoreOutput');

            // 统一设置初始样式
            batchSummaryContainer.className = 'mt-8 p-4 rounded-lg text-center font-semibold text-lg transition-colors duration-300';
            
            // 确保按钮区域可见，但平均值输出隐藏
            averageScoreOutput.classList.add('hidden');
            
            if (calculatedCount === 0) {
                // 无结果样式
                batchResultText.textContent = "未发现有效得分的项目。请至少填写一个得分，然后点击批量计算。";
                batchSummaryContainer.classList.add('bg-yellow-100', 'text-yellow-800');
                
            } else {
                // 有结果样式和平均值计算
                batchResultText.textContent = `成功计算 ${calculatedCount} 个项目。`;
                batchSummaryContainer.classList.add('bg-gray-700', 'text-white'); 
                
                // 调用封装好的平均值计算函数
                const { averageE, averageS, averageI } = getAverageScores(effortScores, standardScores, intensityScores, calculatedCount);

                // 平均标准分颜色判断 (高于或等于 100 为绿色)
                const averageSColorClass = averageS >= 100 ? 'text-green-700' : 'text-red-700';
                
                // 更新 averageScoreOutput
                averageScoreOutput.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 mt-2">
                        <div class="bg-white p-3 rounded-xl text-center shadow-lg">
                            <div class="text-sm font-semibold text-gray-500">平均标准分</div>
                            <div class="text-2xl font-extrabold ${averageSColorClass}">${averageS.toFixed(2)}</div>
                        </div>
                        <div class="bg-white p-3 rounded-xl text-center shadow-lg">
                            <div class="text-sm font-semibold text-gray-500">平均强度(I)</div>
                            <div class="text-2xl font-extrabold text-purple-700">${averageI.toFixed(2)}</div>
                        </div>
                        <div class="bg-white p-3 rounded-xl text-center shadow-lg">
                            <div class="text-sm font-semibold text-gray-500">平均努力度</div>
                            <div class="text-2xl font-extrabold text-purple-700">${averageE.toFixed(2)}</div>
                        </div>
                    </div>
                `; 
                averageScoreOutput.classList.remove('hidden');
            }
        }

        /**
         * 导出当前输入框中所有项目的 ID 和原始分数到 TXT 文件。
         */
        function exportScoresToTxt() {
            const dataToExport = [];
            predefinedProjects.forEach(project => {
                const inputElement = document.getElementById(`rawScore_${project.id}`);
                if (inputElement && inputElement.value) {
                    const rawScore = parseFloat(inputElement.value);
                    if (!isNaN(rawScore) && rawScore > 0) {
                        // 使用简单且易于解析的格式: ID,Score
                        dataToExport.push(`${project.id},${rawScore}`);
                    }
                }
            });

            if (dataToExport.length === 0) {
                 showSummaryMessage('没有可导出的有效得分数据。请填写至少一个项目得分。', true);
                 return;
            }

            let exportContent = "--- Aim Score Calculator Data ---\n";
            exportContent += "格式: 项目ID, 原始分数\n\n";
            exportContent += dataToExport.join('\n');

            // 创建并触发下载
            const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AimScores_Export_${new Date().toISOString().slice(0, 10)}.txt`;
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSummaryMessage('项目得分已成功导出！文件名为: ' + a.download, false);
        }
        
        /**
         * 从 TXT 文件导入原始分数，并自动填充输入框和计算。
         * @param {Event} event - 文件输入事件
         */
        function importScoresFromTxt(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let importedCount = 0;
                let projectsMap = new Map();
                
                // 建立有效的项目ID映射表
                predefinedProjects.forEach(p => projectsMap.set(p.id, true));

                // 清空现有输入框
                predefinedProjects.forEach(project => {
                    const inputElement = document.getElementById(`rawScore_${project.id}`);
                    if (inputElement) inputElement.value = '';
                });

                // 处理文件内容
                content.split('\n').forEach(line => {
                    // 忽略文件头或注释行
                    if (line.startsWith('---') || line.startsWith('格式:') || line.trim() === '') return;

                    // 预期格式: ID,Score
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length === 2) {
                        const projectId = parts[0];
                        const rawScore = parseFloat(parts[1]);

                        if (projectsMap.has(projectId) && !isNaN(rawScore) && rawScore >= 0) {
                            const inputElement = document.getElementById(`rawScore_${projectId}`);
                            if (inputElement) {
                                inputElement.value = rawScore.toString();
                                importedCount++;
                            }
                        }
                    }
                });

                if (importedCount > 0) {
                    showSummaryMessage(`成功导入 ${importedCount} 个项目得分，并自动进行批量计算。`, false);
                    // 导入成功后自动触发批量计算
                    calculateBatchScores();
                } else {
                    showSummaryMessage('导入失败：文件中没有找到有效的项目得分数据或格式错误。', true);
                }
            };
            reader.onerror = () => {
                showSummaryMessage('读取文件失败。', true);
            };
            reader.readAsText(file);
            
            // 重置文件输入值，以便再次导入相同文件时能触发 onchange 事件
            event.target.value = '';
        }

        // 页面加载完成后，渲染预设项目列表
        window.onload = function() {
            renderPredefinedProjects();
        };
    </script>
</body>
</html>