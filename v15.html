<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西岛海 · 灵敏度校准工具箱 · 臻享版 (v14.1 智能吸引)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ------------------------------------- */
        /* CSS 核心变量定义                     */
        /* ------------------------------------- */
        :root {
            /* --- 暗色模式 (默认 - 赛博深空) --- */
            --bg-primary: #121212;
            --bg-gradient-1: #1a1a1a;
            
            --card-bg: rgba(34, 34, 34, 0.95);
            --card-border: rgba(255, 255, 255, 0.08);
            
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --text-highlight: #FFFFFF;
            
            --accent-blue: #64B5F6;    
            --accent-green: #4CAF50;   
            --accent-red: #FF5252;     
            --accent-gold: #FFD700;    
            --accent-purple: #BB86FC;  
            --accent-orange: #FF9800;  
            
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
            --backdrop: blur(16px);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            --input-bg: rgba(0,0,0,0.3);
            --tab-bg: rgba(0,0,0,0.3);
            
            --chart-line: #FF9800;
            --chart-fill: rgba(255, 152, 0, 0.2);
            --chart-point: #FFD700;
            --chart-grid: rgba(255, 255, 255, 0.1);
        }

        /* --- 亮色模式 (Day Mode - 醇咖 & 墨绿) --- */
        body.light-mode {
            --bg-primary: #e8e4dc; 
            --bg-gradient-1: #ded8ce; 
            --card-bg: #f7f5f0;
            --card-border: rgba(62, 39, 35, 0.08); 
            --text-primary: #3e2723;   
            --text-secondary: #6d4c41; 
            --text-highlight: #000000;
            --input-bg: #d7ccc82f;
            --tab-bg: rgba(85, 59, 55, 0.027);
            --accent-blue: #1b5e20;    
            --accent-green: #33691e;   
            --accent-red: #b71c1c;     
            --accent-gold: #f57f17;    
            --accent-purple: #4a148c;  
            --accent-orange: #bf360c;  
            --shadow: 0 10px 30px rgba(62, 39, 35, 0.1), 0 4px 8px rgba(62, 39, 35, 0.05);
            --chart-line: #bf360c;
            --chart-fill: rgba(191, 54, 12, 0.1);
            --chart-point: #3e2723;
            --chart-grid: rgba(62, 39, 35, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 20px 100px 20px;
            transition: background-color 0.5s ease, color 0.5s ease;
            background-image: 
                linear-gradient(45deg, var(--bg-gradient-1) 25%, transparent 25%, transparent 75%, var(--bg-gradient-1) 75%, var(--bg-gradient-1)),
                linear-gradient(45deg, var(--bg-gradient-1) 25%, transparent 25%, transparent 75%, var(--bg-gradient-1) 75%, var(--bg-gradient-1));
            background-position: 0 0, 20px 20px;
            background-size: 40px 40px;
        }

        /* ------------------------------------- */
        /* 通用组件样式                          */
        /* ------------------------------------- */
        .kff-choices { display: flex; gap: 20px; margin-top: 20px; }
        .kff-option { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--card-border); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: var(--transition); }
        .kff-option:hover { border-color: var(--accent-gold); transform: translateY(-2px); }
        .kff-option-label { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px; }
        .kff-option-val { font-size: 1.8rem; font-weight: bold; color: var(--text-primary); }

        .main-layout { width: 100%; max-width: 1600px; display: flex; gap: 25px; margin: 0 auto; }
        #module-binary, #module-kff, #module-bva { width: 100%; display: block; }
        .container { flex-grow: 1; max-width: 1300px; min-width: 60%; display: flex; flex-direction: row; gap: 20px; align-items: flex-start; margin-left: auto; margin-right: auto; }
        .right-sidebars { display: flex; flex-direction: column; gap: 20px; width: 320px; min-width: 320px; padding-top: 10px; }
        
        .sidebar-card { padding: 20px; background-color: var(--card-bg); backdrop-filter: var(--backdrop); border: 1px solid var(--card-border); border-radius: 16px; box-shadow: var(--shadow); position: relative; transition: var(--transition); }
        .sidebar-title { font-size: 1.1rem; font-weight: 700; color: var(--accent-gold); margin-bottom: 15px; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .light-mode .sidebar-title { color: var(--accent-orange); border-bottom-color: rgba(62,39,35,0.1); }

        .ratio-config-area textarea { width: 100%; height: 60px; background: var(--input-bg); border: 1px solid var(--card-border); border-radius: 8px; color: var(--accent-gold); padding: 10px; font-family: inherit; resize: vertical; margin-top: 5px; margin-bottom: 10px; transition: var(--transition); }
        .ratio-config-area textarea:focus { outline: none; border-color: var(--accent-blue); background: rgba(0,0,0,0.05); }
        .light-mode .ratio-config-area textarea { color: var(--text-primary); border-color: rgba(0,0,0,0.1); }
        
        .header { text-align: center; padding: 10px 0 10px; width: 100%; max-width: 1200px; position: relative;}
        .header h1 { font-size: 2.2rem; font-weight: 300; color: var(--text-primary); letter-spacing: 2px; margin-bottom: 5px; text-transform: uppercase; }
        .header p { color: var(--text-secondary); font-size: 0.9rem; letter-spacing: 1px; }

        .theme-toggle-btn { background: var(--card-bg); border: 1px solid var(--card-border); color: var(--text-primary); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 15px; transition: var(--transition); backdrop-filter: var(--backdrop); box-shadow: var(--shadow); }
        .theme-toggle-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .mode-switcher { display: flex; background: var(--tab-bg); padding: 5px; border-radius: 50px; margin: 0 auto 30px; border: 1px solid var(--card-border); flex-wrap: wrap; justify-content: center; }
        .mode-btn { padding: 12px 30px; border-radius: 40px; border: none; background: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
        .mode-btn.active { background: var(--accent-blue); color: white; box-shadow: 0 4px 15px rgba(100, 181, 246, 0.4); }
        .light-mode .mode-btn.active { background: var(--accent-blue); color: #fff; box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3); }
        .mode-btn.active[data-mode="kff"] { background: var(--accent-purple); color: white; }
        .mode-btn.active[data-mode="bva"] { background: var(--accent-orange); color: white; }

        .card { background-color: var(--card-bg); backdrop-filter: var(--backdrop); border: 1px solid var(--card-border); border-radius: 20px; padding: 35px; box-shadow: var(--shadow); transition: var(--transition); }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--card-border); padding-bottom: 15px; }
        .card-title { font-size: 1.3rem; font-weight: 700; color: var(--accent-blue); }
        .kff-mode .card-title { color: var(--accent-purple); }
        .bva-mode .card-title { color: var(--accent-orange); }
        
        .tab-container { display: flex; background: var(--tab-bg); padding: 5px; border-radius: 12px; margin-bottom: 25px; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 10px; color: var(--text-secondary); font-weight: 600; transition: var(--transition); }
        .tab.active { background-color: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(100, 181, 246, 0.3); }
        
        .input-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }
        .input-group { flex: 1; min-width: 140px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 12px 15px; background-color: var(--input-bg); border: 1px solid var(--card-border); border-radius: 10px; color: var(--accent-gold); font-size: 1.05rem; font-weight: bold; font-family: 'PingFang SC', monospace; transition: var(--transition); }
        .light-mode .input-group input, .light-mode .input-group select { color: var(--text-primary); border-color: rgba(62,39,35,0.1); }
        
        .input-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; color: var(--text-primary); background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23A0A0A0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; padding-right: 30px; }
        .input-group select option { background-color: var(--bg-primary); color: var(--text-primary); }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--accent-blue); background-color: rgba(0,0,0,0.1); box-shadow: 0 0 0 2px rgba(100, 181, 246, 0.2); }
        
        .btn { border: none; border-radius: 10px; padding: 14px 28px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        .btn-outline { background: transparent; border: 1px solid var(--card-border); color: var(--text-secondary); }
        .btn-outline:hover { background: rgba(255,255,255,0.05); border-color: var(--text-primary); color: var(--text-primary); }
        .light-mode .btn-outline:hover { background: rgba(0,0,0,0.05); }
        
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue), #1976D2); color: white; width: 100%; margin-top: 10px; box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4); }
        .light-mode .btn-primary { background: linear-gradient(135deg, var(--accent-blue), #2e7d32); }
        .btn-kff-primary { background: linear-gradient(135deg, var(--accent-purple), #7B1FA2); color: white; width: 100%; margin-top: 10px; box-shadow: 0 4px 15px rgba(123, 31, 162, 0.4); }
        .btn-bva-primary { background: linear-gradient(135deg, var(--accent-orange), #F57C00); color: white; width: 100%; margin-top: 10px; box-shadow: 0 4px 15px rgba(245, 124, 0, 0.4); }
        
        .preset-container { display: flex; gap: 10px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed var(--card-border); flex-wrap: wrap; }
        .preset-btn { flex: 1; min-width: 100px; padding: 15px 10px; border: 1px solid var(--card-border); border-radius: 12px; background: var(--input-bg); color: var(--text-secondary); font-size: 0.9rem; cursor: pointer; transition: var(--transition); display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .light-mode .preset-btn { background: #ffffff; border-color: rgba(62,39,35,0.08); }
        .preset-btn:hover { border-color: var(--accent-orange); color: var(--text-primary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .preset-btn i { font-size: 1.3rem; color: var(--accent-orange); margin-bottom: 3px; }
        .preset-btn span.sub { font-size: 0.75rem; opacity: 0.7; font-weight: normal; }

        .search-interface { text-align: center; }
        .current-value-display { background: var(--input-bg); border-radius: 16px; padding: 30px; margin: 25px 0; border: 1px solid var(--accent-blue); position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        
        /* ---------------------------------------------------- */
        /* BVA Process Layout (Optimized v12.1)                */
        /* ---------------------------------------------------- */
        .process-action-row { 
            display: flex; 
            align-items: stretch; /* 强制等高 */
            justify-content: center; 
            gap: 15px; 
            margin: 20px 0; 
            height: 140px; /* 固定高度 */
        }
        
        /* BVA 左右按钮 */
        .btn-decision-compact { 
            flex: 1; 
            height: auto !important; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            margin: 0 !important;
            padding: 10px !important;
        }
        .btn-decision-compact i { font-size: 1.8rem; margin-bottom: 8px; }
        .btn-decision-compact span { font-size: 0.9rem; }
        .bva-predict-val-compact { font-size: 1.1rem !important; margin-top: 5px !important; }

        .btn { 
            border: none; 
            border-radius: 10px; 
            padding: 14px 28px; /* 默认尺寸 */
            font-size: 1rem; 
        }

        .btn-return-bva {
            padding: 10px 20px !important; 
            font-size: 0.95rem !important; 
        }
        .btn-sm { 
            padding: 8px 16px; 
            font-size: 0.9rem; 
        }

        /* BVA 中间显示区 */
        .process-center-display { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: var(--input-bg); 
            border: 1px solid var(--card-border); 
            border-radius: 16px; 
            padding: 10px; 
            height: auto !important; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); 
        }
        .process-val-number { font-size: 2.2rem; font-weight: 700; color: var(--accent-gold); font-family: 'Segoe UI', monospace; }
        .process-val-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }

        .kff-mode .current-value-display { border-color: var(--accent-purple); }
        .bva-mode .current-value-display { border-color: var(--accent-orange); }
        .light-mode .current-value-display { background: #ffffff; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(62,39,35,0.08); }
        
        .val-number { font-size: 4rem; font-weight: 700; color: var(--accent-gold); text-shadow: 0 0 20px rgba(255, 215, 0, 0.3); font-family: 'Segoe UI', monospace; line-height: 1.2; }
        .light-mode .val-number { color: var(--accent-orange); text-shadow: none; }
        .val-source { font-size: 0.9rem; color: var(--accent-blue); margin-top: 5px; opacity: 0.8; }

        .action-buttons { display: flex; gap: 20px; margin-top: 30px; justify-content: center; }
        .btn-decision { flex: 1; max-width: 300px; padding: 25px 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid transparent; background: var(--input-bg); color: var(--text-primary); cursor: pointer; border-radius: 16px; transition: var(--transition); height: 140px; }
        .light-mode .btn-decision { background: #ffffff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .btn-fast { border-color: rgba(255, 82, 82, 0.3); }
        .btn-fast:hover { background: rgba(255, 82, 82, 0.1); transform: translateY(-3px); border-color: var(--accent-red); box-shadow: 0 10px 25px rgba(211, 47, 47, 0.2); }
        .light-mode .btn-fast:hover { background: #fbe9e7; }
        
        .btn-slow { border-color: rgba(76, 175, 80, 0.3); }
        .btn-slow:hover { background: rgba(76, 175, 80, 0.1); transform: translateY(-3px); border-color: var(--accent-green); box-shadow: 0 10px 25px rgba(56, 142, 60, 0.2); }
        .light-mode .btn-slow:hover { background: #f1f8e9; }
        
        .btn-decision i { font-size: 2rem; margin-bottom: 15px; opacity: 0.8; }
        .btn-decision span { font-size: 1.1rem; font-weight: 600; }
        
        /* --- 优化后的表格样式 --- */
        .table-wrapper { margin-top: 20px; border-radius: 12px; overflow: hidden; border: 1px solid var(--card-border); }
        .history-table table { width: 100%; border-collapse: collapse; font-size: 0.85rem; table-layout: fixed; }
        .history-table th, .history-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.05); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .light-mode .history-table th, .light-mode .history-table td { border-bottom-color: rgba(62,39,35,0.08); }
        .history-table th { color: var(--text-secondary); font-weight: 600; background: rgba(255, 255, 255, 0.02); text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem; }
        .light-mode .history-table th { background: #eceff1; }
        .history-table tr:last-child td { border-bottom: none; }
        
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; background: rgba(255,255,255,0.1); color: var(--text-secondary); }
        .status-badge.inc { background: rgba(76, 175, 80, 0.15); color: var(--accent-green); }
        .status-badge.dec { background: rgba(255, 82, 82, 0.15); color: var(--accent-red); }
        .status-badge.phy { background: rgba(255, 152, 0, 0.15); color: var(--accent-orange); }
        
        .history-table td.selected { font-weight: bold; color: var(--accent-gold); font-family: monospace; font-size: 0.95rem; }
        .light-mode .history-table td.selected { color: var(--accent-orange); }

        .bva-dashboard { display: flex; gap: 15px; margin-bottom: 20px; font-size: 0.85rem; justify-content: space-around; }
        .bva-stat-box { background: var(--input-bg); padding: 12px; border-radius: 10px; text-align: center; flex: 1; border: 1px solid var(--card-border); }
        .light-mode .bva-stat-box { background: #ffffff; }
        .bva-stat-label { color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem; }
        .bva-stat-val { color: var(--accent-orange); font-weight: bold; font-size: 1.1rem; }
        
        /* ---------------------------------------------------- */
        /* BVA Manual Override Enhanced                         */
        /* ---------------------------------------------------- */
        .bva-manual-override { margin-top: 25px; padding-top: 20px; border-top: 1px dashed var(--card-border); }
        
        .manual-input-row { display: flex; gap: 10px; align-items: stretch; max-width: 100%; }
        
        /* 输入框 */
        .manual-input-row input { flex: 0 0 120px; width: 120px; background: var(--input-bg); border: 1px solid var(--accent-orange); color: var(--accent-gold); border-radius: 10px; text-align: center; font-family: monospace; font-weight: bold; font-size: 1.2rem; transition: var(--transition); }
        .light-mode .manual-input-row input { background: #fff; color: var(--accent-orange); }
        
        /* 手动按钮组 */
        .manual-btn { flex: 1; border-radius: 10px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; transition: var(--transition); height: auto; min-height: 60px; }
        
        .manual-btn-a { flex: 0 0 80px; background: rgba(33, 150, 243, 0.1); color: var(--accent-blue); border-color: rgba(33, 150, 243, 0.2); }
        .manual-btn-a:hover { background: var(--accent-blue); color: white; }
        
        .manual-btn-b { background: rgba(255, 152, 0, 0.1); color: var(--accent-orange); border-color: rgba(255, 152, 0, 0.2); position: relative; }
        .manual-btn-b:hover { background: var(--accent-orange); color: white; }
        
        /* 预测文字样式优化 */
        .manual-predict-info { font-size: 0.75rem; margin-top: 4px; display: flex; gap: 5px; opacity: 0.9; align-items: center; justify-content: center; }

        /* 双向撤销/重做按钮组 */
        .undo-redo-container { display: flex; justify-content: space-between; margin-bottom: 5px; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--card-border); }
        .btn-history-nav { background: transparent; border: none; color: var(--text-secondary); font-size: 0.9rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 5px; }
        .btn-history-nav:hover:not(:disabled) { color: var(--accent-blue); transform: scale(1.1); }
        .btn-history-nav:disabled { opacity: 0.3; cursor: not-allowed; }

        /* BVA Result Card 美化 */
        .result-card-content { text-align: center; padding: 20px; animation: fadeIn 0.8s ease; }
        .result-icon-wrapper { width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-orange), var(--accent-red)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 0 30px rgba(255, 152, 0, 0.4); }
        .result-icon-wrapper i { font-size: 2.5rem; color: white; }
        .result-label { font-size: 1rem; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase; }
        .result-main-val { font-size: 4.5rem; font-weight: 800; font-family: 'Segoe UI', monospace; background: linear-gradient(to right, var(--accent-gold), var(--accent-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 10px; line-height: 1; }
        .result-sub-info { font-size: 0.9rem; color: var(--text-secondary); background: var(--input-bg); display: inline-block; padding: 5px 15px; border-radius: 20px; border: 1px solid var(--card-border); }

        @media (max-width: 600px) {
            .manual-input-row { flex-direction: column; }
            .manual-input-row input { width: 100%; height: 50px; }
        }

        .chart-container { width: 100%; height: 180px; background: var(--input-bg); border-radius: 12px; margin: 15px 0; border: 1px solid var(--card-border); position: relative; }
        .light-mode .chart-container { background: #ffffff; }
        canvas { display: block; width: 100%; height: 100%; }

        .bva-layout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px; }
        .bva-panel { background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; }
        .light-mode .bva-panel { background: rgba(255,255,255,0.6); }
        .bva-panel-header { font-size: 1rem; font-weight: 600; color: var(--accent-orange); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; padding-bottom: 10px; border-bottom: 1px dashed var(--card-border); }
        .bva-panel-content { flex-grow: 1; }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* BGM & Floating */
        .floating-container { position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; align-items: flex-end; }
        .floating-link { background-color: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--card-border); color: var(--text-primary); text-decoration: none; font-weight: bold; padding: 12px 25px; border-radius: 50px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; transition: var(--transition); cursor: pointer; font-size: 0.95rem; }
        .floating-link:hover { background-color: var(--accent-blue); color: white; transform: translateY(-3px); }
        .music-controls { display: flex; gap: 5px; background-color: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--card-border); padding: 5px 15px 5px 15px; border-radius: 50px; box-shadow: var(--shadow); align-items: center; }
        .music-info-text { display: flex; flex-direction: column; margin-right: 10px; align-items: flex-end; }
        .song-title { font-size: 0.85rem; font-weight: bold; color: var(--accent-gold); max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-status { font-size: 0.7rem; color: var(--text-secondary); }
        .music-btn-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .light-mode .music-btn-circle { background: rgba(0,0,0,0.05); }
        .music-btn-circle:hover { background: var(--accent-green); color: white; transform: scale(1.1); }
        .music-btn-next:hover { background: var(--accent-blue); }

        .toggle-switch { position: relative; display: inline-block; width: 46px; height: 24px; vertical-align: middle; margin-left: 10px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--card-border); transition: .4s; border-radius: 24px; border: 1px solid var(--card-border); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: var(--text-secondary); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        input:checked + .slider:before { transform: translateX(22px); background-color: white; }
        .light-mode input:checked + .slider { background-color: var(--accent-blue); }
        .toggle-label-text { font-size: 0.85rem; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; }

        @media (max-width: 900px) { 
            .main-layout { flex-direction: column; } 
            .container { margin-left: 0; width: 100%; } 
            .right-sidebars { width: 100%; } 
            .bva-layout-grid { grid-template-columns: 1fr; } 
            .action-buttons { flex-direction: row; gap: 10px; }
            .btn-decision { height: 110px; padding: 15px 10px; }
            .btn-decision i { font-size: 1.5rem; margin-bottom: 8px; }
            .btn-decision span { font-size: 0.9rem; }
        }
        
        .boundary-toolbar { display: flex; gap: 20px; justify-content: flex-end; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.05); padding: 8px 15px; border-radius: 12px; }
        .light-mode .boundary-toolbar { background: rgba(62,39,35,0.03); }
        
        .repulsion-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .repulsion-grid .input-group { min-width: 0; }
        .repulsion-grid .input-group label { font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .repulsion-grid .input-group input { padding: 8px; font-size: 0.95rem; text-align: center; }
        
        .rep-list-header { display: grid; grid-template-columns: 40px 1fr 1fr 40px; text-align: center; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: bold; border-bottom: 1px solid var(--card-border); padding-bottom: 5px; }
        .repulsion-point-list { margin-top: 5px; max-height: 200px; overflow-y: auto; border: 1px solid var(--card-border); border-radius: 8px; background: var(--input-bg); }
        .light-mode .repulsion-point-list { background: #ffffff; }
        .rep-point-row { display: grid; grid-template-columns: 40px 1fr 1fr 40px; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--card-border); }
        .rep-point-row:last-child { border-bottom: none; }
        .rep-point-row:nth-child(even) { background: rgba(0,0,0,0.03); }
        .rep-point-index { text-align: center; font-size: 0.8rem; color: var(--text-secondary); opacity: 0.7; }
        .rep-point-row input { width: 90%; margin: 0 auto; padding: 5px; height: 30px; font-size: 0.9rem; text-align: center; background: transparent; border: 1px solid transparent; border-radius: 4px; color: var(--text-primary); font-family: monospace; }
        .rep-point-row input:focus { border-color: var(--accent-blue); background: rgba(255,255,255,0.1); }
        .light-mode .rep-point-row input:focus { background: rgba(0,0,0,0.05); }
        .rep-del-btn { color: var(--accent-red); cursor: pointer; text-align: center; opacity: 0.7; transition: 0.2s; }
        .rep-del-btn:hover { opacity: 1; transform: scale(1.1); }
        
        .top-right-complex-alert-new { cursor: pointer; }
        .top-right-complex-alert-new.collapsed .complex-content-new { display: none; }
        .top-right-complex-alert-new.collapsed { width: auto; padding: 10px 20px; }
        .top-right-complex-alert-new.collapsed .complex-title-new { margin-bottom: 0; padding-bottom: 0; }
        .top-right-complex-alert-new.collapsed .complex-title-new i::after { content: " (点击展开)"; font-size: 0.8rem; opacity: 0.7; font-weight: normal; margin-left: 5px; font-family: sans-serif; }
    </style>
    
    <style>
    .top-right-complex-alert-new { position: fixed; top: 25px; right: 50px; width: 320px; background-color: var(--card-bg); backdrop-filter: var(--backdrop); border: 1px solid var(--card-border); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; box-sizing: border-box; z-index: 1010; transition: var(--transition); }
    .complex-title-new { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 5px; }
    .complex-title-new .fa-lightbulb { font-size: 1.1rem; color: var(--accent-gold); margin-right: 8px; }
    .complex-title-new span { font-size: 1.2rem; font-weight: 600; color: var(--accent-gold); }
    .complex-content-new { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; }
    .complex-content-new .line-block-new { display: flex; margin-bottom: 10px; padding-left: 0; }
    .complex-content-new .line-block-new span.v-line { width: 3px; margin-right: 10px; flex-shrink: 0; min-height: 1.6em; }
    .complex-content-new .line-yellow { background-color: var(--accent-gold); }
    .complex-content-new .line-blue { background-color: var(--accent-blue); }
    .complex-content-new .line-purple { background-color: var(--accent-purple); }
    .complex-content-new p { margin: 0; padding: 0; }
    @media (max-width: 900px) { .top-right-complex-alert-new { position: static; width: 100%; margin-bottom: 20px; right: auto; top: auto; order: -2; } }
    </style>
</head>
<body id="app-body" class="binary-mode">

<audio id="bg-music" loop><source src="" type="audio/mpeg"></audio>

<div class="floating-container">
    <div class="music-controls">
        <div class="music-info-text">
            <span class="song-title" id="bgm-song-title">I Feel Love</span>
            <span class="song-status" id="bgm-status">Click Play</span>
        </div>
        <div class="music-btn-circle" onclick="prevSong()" title="上一首"><i class="fas fa-step-backward"></i></div>
        <div class="music-btn-circle" onclick="toggleMusic()"><i class="fas fa-play" id="music-icon"></i></div>
        <div class="music-btn-circle music-btn-next" onclick="nextSong()" title="下一首"><i class="fas fa-step-forward"></i></div>
    </div>
    <a href="https://space.bilibili.com/1534330" target="_blank" class="floating-link"><i class="fab fa-bilibili" style="color: #ff69b49f;"></i><span>作者 西岛海_XLM</span></a>
</div>

<div class="top-right-complex-alert-new collapsed" id="complex-alert-box" onclick="this.classList.toggle('collapsed')">
    <div class="complex-title-new"><i class="fas fa-lightbulb"></i><span>四种算法说明</span></div>
    <div class="complex-content-new">
        <div class="line-block-new"><span class="v-line line-yellow"></span><p>快分法：我的作品，简单易用，有弹性（允许出错）且直接。</p></div>
        <div class="line-block-new"><span class="v-line line-blue"></span><p><b>弹性倍率表：</b>不是我的作品，就是PSA，其原作者不确定，（或许是ioStux？）。简单有效的算法之一。【但我根据自己的经验，用心休整倍率，让其对灵敏度更加具有适配性】，如果不喜欢我的设定，各位可以修改回来。直接复制，两边都填入（原PSA为）：50，50，40，30，20，10，5</p></div>
        <div class="line-block-new"><span class="v-line line-blue"></span><p>范围二分法：经典的数学算法，快速收敛但不允许选择出错。</p></div>
        <div class="line-block-new" style="margin-top: 15px;"><span class="v-line line-purple"></span><p><b>【记忆收敛法】：</b>我的作品，内核算法力求工整实用。是我的大成作品之一，其他还有基底拟合v4、表达法等。【有限记忆下，超出设定步数的记忆会被舍弃。】</p></div>
    </div>
</div>

<div class="header">
    <h1 id="app-title">灵敏度校准工具箱</h1>
    <p id="app-desc">四种校准方法（含PSA）</p>
    <div style="margin-top: 15px;"><button class="theme-toggle-btn" onclick="toggleTheme()"><i class="fas fa-adjust"></i> <span>日间/夜间模式</span></button></div>
</div>

<div class="mode-switcher">
    <button class="mode-btn active" data-mode="binary" onclick="setAppMode('binary')"><i class="fas fa-arrows-alt-h"></i> 二分校准法</button>
    <button class="mode-btn" data-mode="kff" onclick="setAppMode('kff')"><i class="fas fa-bolt"></i> KFF 快分法</button>
    <button class="mode-btn" data-mode="bva" onclick="setAppMode('bva')"><i class="fas fa-magnet"></i> 记忆收敛法</button>
</div>

<div class="main-layout">
    <div class="container">
        
        <!-- ======================= -->
        <!-- BINARY MODULE           -->
        <!-- ======================= -->
        <div id="module-binary">
            <div class="card" id="bin-setupCard">
                <div class="card-header"><i class="fas fa-sliders-h" style="color: var(--accent-blue);"></i><span class="card-title">参数配置</span></div>
                <div class="tab-container"><div class="tab active" onclick="switchBinTab('direct')" id="tab-direct">方案一：范围二分法</div><div class="tab" onclick="switchBinTab('percent')" id="tab-percent">方案二：弹性倍率表</div></div>
                <div id="bin-option-direct">
                    <div class="input-row"><div class="input-group"><label>下限 (Min)</label><input type="number" id="bin-inp-min" value="1" step="0.0001"></div><div class="input-group"><label>上限 (Max)</label><input type="number" id="bin-inp-max" value="5" step="0.0001"></div></div>
                    <div class="input-row"><div class="input-group"><label>起始基准值 (Base)</label><input type="number" id="bin-inp-base-direct" value="2" step="0.0001"></div><div class="input-group"><label>迭代次数</label><input type="number" id="bin-inp-iter" value="5" min="4" max="99"></div></div>
                </div>
                <div id="bin-option-percent" class="hidden">
                    <div class="input-row"><div class="input-group"><label>起始基准值 (Base)</label><input type="number" id="bin-inp-base" value="50" step="0.0001"></div></div>
                    <p style="color:var(--text-secondary);font-size:0.9rem;">此模式将使用经典的二分法，配合百分比序列，进行逐级递进校准。</p>
                </div>
                <button class="btn btn-primary" onclick="binStart()"><i class="fas fa-play"></i> 开始校准程序</button>
            </div>
            <div class="card hidden" id="bin-processCard">
                <div class="card-header"><i class="fas fa-search-location" style="color: var(--accent-blue);"></i><span class="card-title">校准进行中</span><span style="margin-left: auto; color: var(--text-secondary); font-size: 0.9rem;" id="bin-step-indicator">Step 1 / 10</span></div>
                <div class="search-interface">
                    <div class="current-value-display" onclick="binManualEditBase()"><div class="val-label">当前测试值 (点击可修改)</div><div class="val-number" id="bin-current-val">--</div><div id="bin-range-hint" style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;"></div></div>
                    <div class="bin-range-display hidden" id="bin-direct-range-display"><div class="range-item" onclick="binManualEditLimit('l')"><span class="range-label">下限 L (点击修改)</span><span class="range-val" id="bin-current-l">--</span></div><div class="range-item" onclick="binManualEditLimit('r')"><span class="range-label">上限 R (点击修改)</span><span class="range-val" id="bin-current-r">--</span></div></div>
                    <div class="action-buttons"><button class="btn btn-decision btn-fast" onclick="binProcessDecision('fast')"><i class="fas fa-forward"></i><span>想让数更小</span></button><button class="btn btn-decision btn-slow" onclick="binProcessDecision('slow')"><i class="fas fa-backward"></i><span>想让数更大</span></button></div>
                </div>
                <div class="table-wrapper"><table><thead><tr><th>次</th><th>下限 (L)</th><th>基准 (B)</th><th>上限 (R)</th></tr></thead><tbody id="bin-history-body"></tbody></table></div>
                <button class="btn" style="background: rgba(255,255,255,0.1); color: var(--text-secondary); margin-top: 20px; width: 100%;" onclick="binReset()"><i class="fas fa-redo"></i> 重新开始</button>
            </div>
            <div class="card result-area hidden" id="bin-resultCard">
                <div class="result-title"><i class="fas fa-check-circle"></i> 校准完成</div><div>您的完美数值约为</div><div class="result-val" id="bin-final-result">--</div><button class="btn btn-primary" style="margin-top: 30px; width: auto;" onclick="binReset()">完成并重置</button>
            </div>
        </div>

        <!-- ======================= -->
        <!-- KFF MODULE              -->
        <!-- ======================= -->
        <div id="module-kff" class="hidden kff-mode">
            <div class="card" id="kff-setupCard">
                <div class="card-header"><i class="fas fa-bolt" style="color: var(--accent-purple);"></i><span class="card-title">KFF 参数配置</span></div>
                <div class="input-row"><div class="input-group"><label>起始基准值</label><input type="number" id="kff-inp-base" placeholder="如 cm/360 或 游戏内数值" step="0.0001"></div></div>
                <div class="ratio-config-area">
                    <label style="font-size: 0.8rem; color: var(--accent-red);">【左边数小】倍率序列（%）:</label><textarea id="kff-ratio-input-area-right" spellcheck="false" placeholder="如 40, 30, 20, 10, 5"></textarea>
                    <label style="font-size: 0.8rem; color: var(--accent-green);">【右边数大】倍率序列（%）:</label><textarea id="kff-ratio-input-area-left" spellcheck="false" placeholder="如 50, 40, 30, 20, 10"></textarea>
                </div>
                <button class="btn btn-kff-primary" onclick="kffStart()"><i class="fas fa-bolt"></i> 开始快分校准</button>
            </div>
            <div class="card hidden" id="kff-processCard">
                <div class="card-header"><i class="fas fa-wave-square" style="color: var(--accent-purple);"></i><span class="card-title">快分校准中</span><span style="margin-left: auto; color: var(--text-secondary); font-size: 0.9rem;" id="kff-step-indicator">Phase 1 / 9</span></div>
                <div class="search-interface">
                    <div class="current-value-display" onclick="kffManualEditBase()"><div class="val-label">当前基准值 (点击可修改)</div><div class="val-number" id="kff-current-base">--</div><div class="val-source" id="kff-ratio-display">当前调整幅度: --</div></div>
                    <div class="kff-choices"><div class="kff-option" onclick="kffProcessDecision('low')"><div class="kff-option-label">数小 (Low)</div><div class="kff-option-val" id="kff-val-low">--</div></div><div class="kff-option" onclick="kffProcessDecision('high')"><div class="kff-option-label">数大 (High)</div><div class="kff-option-val" id="kff-val-high">--</div></div></div>
                </div>
                <div class="table-wrapper"><table><thead><tr><th>轮次</th><th>低值选项</th><th>当前基准</th><th>高值选项</th></tr></thead><tbody id="kff-history-body"></tbody></table></div>
                <button class="btn" style="background: rgba(255,255,255,0.1); color: var(--text-secondary); margin-top: 20px; width: 100%;" onclick="kffReset()"><i class="fas fa-redo"></i> 重新开始</button>
            </div>
            <div class="card result-area hidden" id="kff-resultCard">
                <div class="result-title"><i class="fas fa-check-circle"></i> 校准完成</div><div class="result-val" id="kff-final-result">--</div><button class="btn btn-kff-primary" style="margin-top: 30px; width: auto;" onclick="kffReset()">完成并重置</button>
            </div>
        </div>

        <!-- ======================= -->
        <!-- BVA MODULE              -->
        <!-- ======================= -->
        <div id="module-bva" class="hidden bva-mode">
            <div class="card" id="bva-setupCard">
                <div class="card-header"><i class="fas fa-magnet" style="color: var(--accent-orange);"></i><span class="card-title">黑白引斥场 (v14.1)</span>
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button class="btn btn-sm btn-outline" onclick="exportBVASettings()"><i class="fas fa-file-export"></i> 导出设置</button>
                        <button class="btn btn-sm btn-outline" onclick="document.getElementById('bva-file-input').click()"><i class="fas fa-file-import"></i> 导入设置</button>
                        <input type="file" id="bva-file-input" style="display: none;" accept=".json" onchange="importBVASettings(this)">
                    </div>
                </div>
                
                <div class="preset-container">
                    <div class="preset-btn" onclick="applyBvaPreset(1)"><i class="fas fa-balance-scale"></i><span>预设1：CM/360°常规寻敏</span><span class="sub">速寻</span></div>
                    <div class="preset-btn" onclick="applyBvaPreset(2)"><i class="fas fa-rocket"></i><span>预设2：灵敏为1至3时可用</span><span class="sub">游戏</span></div>
                    <div class="preset-btn" onclick="applyBvaPreset(3)"><i class="fas fa-microscope"></i><span>预设3：CM/360°探索新敏</span><span class="sub">慢寻</span></div>
                </div>

                <div class="input-row"><div class="input-group"><label>起始基准值 (Base)</label><input type="number" id="bva-inp-base" value="50" step="0.01"></div></div>

                <div class="bva-layout-grid">
                    
                    <div class="bva-panel">
                        <div class="bva-panel-header"><i class="fas fa-sliders-h"></i> 步长与排斥场</div>
                        <div class="bva-panel-content">
                            <div class="ratio-config-area">
                                <label style="font-size: 0.8rem; color: var(--accent-red);">【数变小】递减序列（%，空格分隔）:</label><textarea id="bva-inp-ratios-dec" spellcheck="false" placeholder="如 50 40 30 20 10"></textarea>
                                <label style="font-size: 0.8rem; color: var(--accent-green); margin-top: 5px; display:block;">【数变大】递增序列（%，空格分隔）:</label><textarea id="bva-inp-ratios-inc" spellcheck="false" placeholder="如 40 30 20 10 5"></textarea>
                            </div>

                            <div style="border-top: 1px dashed var(--card-border); margin: 15px 0 10px; padding-top: 15px;">
                                <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom:12px;">
                                    <span style="font-size:0.9rem; font-weight:bold; color:var(--accent-purple);"><i class="fas fa-draw-polygon"></i> 边界与排斥力</span>
                                </div>
                                
                                <div class="boundary-toolbar">
                                    <label class="toggle-label-text">
                                        静态自定义 (多段)
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="bva-inp-custom-rep-toggle" onchange="toggleBvaRepulsionMode()">
                                            <span class="slider round"></span>
                                        </label>
                                    </label>
                                    <label class="toggle-label-text">
                                        静态内边界 (简单)
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="bva-inp-soft-toggle" checked onchange="toggleBvaSoftFields()">
                                            <span class="slider round"></span>
                                        </label>
                                    </label>
                                </div>
                                
                                <div id="bva-rep-standard-ui">
                                    <div class="repulsion-grid">
                                        <div class="input-group"><label>Min硬 (Hard)</label><input type="number" id="bva-inp-min-hard" value="10" step="1"></div>
                                        <div class="input-group soft-field"><label>Min软 (Soft)</label><input type="number" id="bva-inp-min-soft" value="20" step="1"></div>
                                        <div class="input-group"><label>Min 斥力%</label><input type="number" id="bva-inp-min-rep" value="60" placeholder="0-100"></div>
                                        
                                        <div class="input-group"><label>Max硬 (Hard)</label><input type="number" id="bva-inp-max-hard" value="100" step="1"></div>
                                        <div class="input-group soft-field"><label>Max软 (Soft)</label><input type="number" id="bva-inp-max-soft" value="90" step="1"></div>
                                        <div class="input-group"><label>Max 斥力%</label><input type="number" id="bva-inp-max-rep" value="80" placeholder="0-100"></div>
                                    </div>
                                </div>

                                <div id="bva-rep-custom-ui" class="hidden">
                                    <button class="btn btn-sm btn-outline" onclick="addCustomRepPointsPrompt()" style="width:100%; margin-bottom:10px;"><i class="fas fa-plus-circle"></i> 批量添加控制点</button>
                                    <div class="rep-list-header">
                                        <span>Idx</span><span><i class="fas fa-arrows-alt-h"></i> 基准值 (X)</span><span><i class="fas fa-compress-arrows-alt"></i> 排斥力 (Y%)</span><span>Del</span>
                                    </div>
                                    <div class="repulsion-point-list" id="bva-custom-rep-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bva-panel">
                        <div class="bva-panel-header">
                            <i class="fas fa-clock"></i>吸引力与记忆点
                            <!-- 新增：智能吸引开关 -->
                            <label class="toggle-label-text" style="margin-left:auto; font-size:0.8rem; font-weight:normal;">
                                智能吸引
                                <label class="toggle-switch" style="width:40px; height:20px; margin-left:8px;">
                                    <input type="checkbox" id="bva-inp-smart-attr-toggle">
                                    <span class="slider round" style="border-radius:20px;"></span>
                                </label>
                            </label>
                        </div>
                        <div class="bva-panel-content">
                            <div class="input-row">
                                <div class="input-group"><label>最大吸引力限制</label><input type="number" id="bva-inp-attr-limit" value="5" step="0.1"></div>
                                <div class="input-group" style="border: 1px solid var(--accent-blue); border-radius:8px; padding:2px 8px; background:rgba(5, 21, 56, 0.125);">
                                    <label style="color:var(--accent-gold);">【吸引点】</label>
                                    <select id="bva-inp-attr-mode" onchange="toggleBvaAttrUI()">
                                        <option value="manual">手动吸引点位</option>
                                        <option value="auto" selected>自动记忆判断</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group"><label>吸引力强度 (I吸 %)</label><input type="number" id="bva-inp-attr-str" value="30"></div>
                                <div class="input-group"><label>基准值与吸引点的作用</label>
                                    <select id="bva-inp-pull-toggle">
                                        <option value="away">远离拉回，靠近不管</option>
                                        <option value="close">靠近吸引，远离不管</option>
                                        <option value="always" selected>靠近远离都作用</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="bva-ui-manual" class="input-row hidden"><div class="input-group"><label>手动吸引值 (目标)</label><input type="number" id="bva-inp-attr-val" value="50"></div></div>
                            
                            <div id="bva-ui-auto">
                                <div class="input-row">
                                    <div class="input-group"><label>记忆时间</label><select id="bva-inp-mem-type" onchange="toggleBvaMemUI()"><option value="short">有限</option><option value="long">无限</option></select></div>
                                    <div class="input-group" style="border: 1px solid rgba(117, 30, 113, 0.3); border-radius:8px; padding:2px 8px; background:rgba(121, 14, 98, 0.062);">
                                        <label style="color:var(--accent-black);"><i class="fas fa-play-circle"></i> 权重模式</label>
                                        <select id="bva-inp-startup-mode" style="border-color:transparent; background:transparent; color:var(--accent-black);">
                                            <option value="rigorous" selected>先用最后权重</option>
                                            <option value="conservative">缓至最后权重</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="bva-sub-short" class="input-row">
                                    <div class="input-group"><label>设定几步 (N)</label><input type="number" id="bva-inp-win-size" value="3" onchange="toggleBvaMemUI()"></div>
                                    <div class="input-group"><label>衰减权重逻辑</label><select id="bva-inp-short-algo" onchange="toggleBvaMemUI()"><option value="uniform">均匀权重</option><option value="linear" selected>线性衰减</option><option value="manual">手动设定</option></select></div>
                                </div>

                                <div id="bva-sub-short-manual" class="hidden" style="margin-bottom:15px; border: 1px dashed rgba(255,152,0,0.3); padding: 10px; border-radius: 8px;"><div id="bva-sub-short-manual-fields" class="bva-short-input-grid"></div><div id="bva-weight-total-display" class="weight-total-display">当前总和: <span id="bva-weight-total">0</span>%</div><button class="btn" style="font-size: 0.8rem; padding: 6px; margin-top:5px; background: rgba(255,152,0,0.2); color: var(--accent-orange);" onclick="normalizeWeights('short')"><i class="fas fa-balance-scale"></i> 自动归一化</button></div>
                                
                                <div id="bva-sub-long" class="input-row hidden"><div class="input-group"><label>长久记忆曲线</label><select id="bva-inp-long-algo" onchange="toggleBvaMemUI()"><option value="uniform">均匀权重</option><option value="recent">近期聚焦</option><option value="nostalgia">远期怀旧</option><option value="custom">自定曲线</option></select></div></div>
                                
                                <div id="bva-sub-long-custom" class="hidden" style="margin-bottom:15px; border: 1px dashed rgba(255,152,0,0.3); padding: 10px; border-radius: 8px;"><div id="bva-long-custom-fields" class="bva-short-input-grid"></div><div style="text-align: center; margin-top: 10px;"><button class="btn" style="font-size:0.8rem; padding: 5px 10px; background: rgba(255,152,0,0.2); color: var(--accent-orange);" onclick="addLongMemoryPoint()"><i class="fas fa-plus"></i> 加点</button><button class="btn" style="font-size:0.8rem; padding: 5px 10px; background: rgba(255,82,82,0.2); color: var(--accent-red);" onclick="removeLongMemoryPoint()"><i class="fas fa-minus"></i> 减点</button></div><div id="bva-long-weight-total-display" class="weight-total-display">当前总和: <span id="bva-long-weight-total">0</span>%</div><button class="btn" style="font-size: 0.8rem; padding: 6px; margin-top:5px; background: rgba(255,152,0,0.2); color: var(--accent-orange); width: 100%;" onclick="normalizeWeights('long')"><i class="fas fa-balance-scale"></i> 自动归一化</button></div>
                                
                                <div class="chart-container"><canvas id="weightChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; border: 1px solid var(--card-border); border-radius: 12px; padding: 10px; background: rgba(0,0,0,0.15);">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 5px; text-align: center;"><i class="fas fa-chart-area"></i> 排斥力场分布图 (Repulsion Field)</div>
                    <div class="chart-container" style="height: 150px; background: transparent; border: none; margin: 0;"><canvas id="repulsionChart"></canvas></div>
                </div>
                <button class="btn btn-bva-primary" style="padding: 18px; font-size: 1.1rem;" onclick="bvaStart()"><i class="fas fa-play"></i> 启动调整场</button>
            </div>

            <!-- BVA PROCESS CARD (Enhanced v12.1) -->
            <div class="card hidden" id="bva-processCard">
                <div class="card-header">
                    <i class="fas fa-atom" style="color: var(--accent-orange);"></i>
                    <span class="card-title">场域调整中</span>
                    <span style="margin-left: auto; color: var(--text-secondary); font-size: 0.9rem;" id="bva-step-indicator">Step 0</span>
                </div>

                <!-- 双向撤销/重做按钮区 -->
                <div class="undo-redo-container">
                    <button class="btn-history-nav" id="bva-btn-undo" onclick="bvaUndo()" disabled>
                        <i class="fas fa-undo"></i> 撤销 (Undo)
                    </button>
                    <div style="font-size:0.8rem; color:var(--text-secondary); line-height:24px;">历史节点控制</div>
                    <button class="btn-history-nav" id="bva-btn-redo" onclick="bvaRedo()" disabled>
                        重做 (Redo) <i class="fas fa-redo"></i>
                    </button>
                </div>

                <div class="search-interface">
                    <!-- 仪表盘 -->
                    <div class="bva-dashboard">
                        <div class="bva-stat-box" style="display:flex; padding:0; overflow:hidden;">
                            <div style="flex:1; padding:12px; border-right:1px solid var(--card-border);">
                                <div class="bva-stat-label">将应用的拉扯量</div>
                                <div class="bva-stat-val" id="bva-disp-attr">--</div>
                            </div>
                            <div style="flex:1; padding:12px; background:rgba(0,0,0,0.05);">
                                <div class="bva-stat-label">当前吸引点（记忆点）</div>
                                <div class="bva-stat-val" style="color:var(--accent-blue);" id="bva-target-display">--</div>
                            </div>
                        </div>
                        <div class="bva-stat-box" style="display:flex; padding:0; overflow:hidden;">
                            <div style="flex:1; padding:12px; border-right:1px solid var(--card-border);">
                                <div class="bva-stat-label" style="color:var(--accent-red);">左·预测排斥</div>
                                <div class="bva-stat-val" style="color:var(--accent-red);" id="bva-disp-rep-l">--</div>
                            </div>
                            <div style="flex:1; padding:12px;">
                                <div class="bva-stat-label" style="color:var(--accent-green);">右·预测排斥</div>
                                <div class="bva-stat-val" style="color:var(--accent-green);" id="bva-disp-rep-r">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 核心操作区 -->
                    <div class="process-action-row">
                        <button class="btn btn-decision btn-decision-compact btn-fast" id="btn-bva-low" onclick="bvaProcessDecision('low')">
                            <i class="fas fa-chevron-down"></i>
                            <span>数变小</span>
                            <span class="bva-predict-val bva-predict-val-compact" style="color: var(--accent-red);">--</span>
                        </button>

                        <div class="process-center-display">
                            <div class="process-val-label">当前基准值</div>
                            <div class="process-val-number" id="bva-current-base">--</div>
                            <div class="val-source" id="bva-info-display" style="font-size:0.8rem;">Waiting...</div>
                        </div>

                        <button class="btn btn-decision btn-decision-compact btn-slow" id="btn-bva-high" onclick="bvaProcessDecision('high')">
                            <i class="fas fa-chevron-up"></i>
                            <span>数变大</span>
                            <span class="bva-predict-val bva-predict-val-compact" style="color: var(--accent-green);">--</span>
                        </button>
                    </div>

                    <div class="chart-container" style="height: 120px; background: rgba(0,0,0,0.1); margin-top: 15px;">
                        <canvas id="repulsionChartProcess"></canvas>
                    </div>

                    <!-- 手动输入区 -->
                    <div class="bva-manual-override">
                        <label style="font-size:0.85rem; color:var(--text-secondary); display:block; margin-bottom:10px;">手动输入新基准值 (预测仅针对该输入值)</label>
                        <div class="manual-input-row">
                            <input type="number" id="bva-manual-next-val" placeholder="数值" oninput="bvaUpdateManualPrediction()">
                            
                            <button class="manual-btn manual-btn-a" onclick="bvaManualStep('A')">
                                <b>A. 强制覆写</b>
                                <span style="font-size:0.7rem; opacity:0.7;">无视力场</span>
                            </button>
                            
                            <button class="manual-btn manual-btn-b" onclick="bvaManualStep('B')">
                                <b>B. 尝试运算</b>
                                <div id="bva-manual-predict-container" class="manual-predict-info">
                                    等待输入...
                                </div>
                            </button>
                        </div>
                    </div>

                    <button class="btn" style="background: rgba(255,255,255,0.05); color: var(--accent-orange); margin-top: 30px; font-size: 1rem; padding: 15px 40px; border: 1px solid var(--accent-orange); width: 100%;" onclick="bvaShowResult()">
                        <i class="fas fa-flag-checkered"></i> 结束并查看结果
                    </button>
                </div>
                
                <div class="table-wrapper">
                    <table class="history-table">
                        <colgroup>
                            <col style="width: 12%">
                            <col style="width: 18%">
                            <col style="width: 25%">
                            <col style="width: 45%">
                        </colgroup>
                        <thead><tr><th>步</th><th>方向</th><th>新基准</th><th>详情</th></tr></thead>
                        <tbody id="bva-history-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- BVA Result Card (Enhanced v12.1) -->
            <div class="card result-area hidden" id="bva-resultCard">
                <div class="result-card-content">
                    <div class="result-icon-wrapper"><i class="fas fa-flag-checkered"></i></div>
                    <div class="result-label">最终稳定基准值</div>
                    <div class="result-main-val" id="bva-final-result">--</div>
                    <div class="result-sub-info">
                        <i class="fas fa-magnet"></i> 最终记忆点为: <span id="bva-final-attr" style="color:var(--accent-blue);">--</span>
                    </div>
                    <div style="margin-top: 30px; display:flex; gap:15px; justify-content:center;">
                        <button class="btn btn-outline btn-return-bva" onclick="bvaUndo(); document.getElementById('bva-resultCard').classList.add('hidden'); document.getElementById('bva-processCard').classList.remove('hidden');">
                            <i class="fas fa-undo"></i> 返回微调
                        </button>
                        <button class="btn btn-bva-primary" style="width: auto; padding-left:30px; padding-right:30px;" onclick="bvaReset()">
                            <i class="fas fa-check"></i> 完成并重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    
    <div class="right-sidebars">
        <div class="sidebar-card hidden" id="config-sidebar-card">
            <div class="sidebar-title"><i class="fas fa-cog"></i> 递进倍率配置</div>
            <div class="ratio-config-area">
                <label style="font-size: 0.8rem; color: var(--accent-green);">【右边数大】倍率序列（%）:</label><textarea id="ratio-input-area-left" spellcheck="false"></textarea>
                <label style="font-size: 0.8rem; color: var(--accent-red); margin-top: 15px;">【左边数小】倍率序列（%）:</label><textarea id="ratio-input-area-right" spellcheck="false"></textarea>
            </div>
        </div>
        <div class="sidebar-card"> 
            <div class="sidebar-title"><i class="fas fa-history"></i> 上次校准记录</div>
            <div id="history-content"><p style="color: var(--text-secondary); font-size: 0.9rem; text-align: center;">无记录</p></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 全局工具函数
    // ==========================================
    const PRECISION = 4;
    function preciseRound(num, precision) {
        if (typeof num !== 'number') return num;
        const factor = Math.pow(10, precision);
        return Math.round(num * factor) / factor;
    }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        renderWeightChart();
        renderRepulsionChart();
    }

    const musicPlaylist = [
        { title: "Aaron Hi.. - i feel lost", src: "http://xidaohai.github.io/ifl.mp3" },
        { title: "光田康典 - 时の回廊", src: "http://xidaohai.github.io/szhl.mp3" },
        { title: "Jannik - 红砖壁炉", src: "http://xidaohai.github.io/hzbl.mp3" }
    ];
    let currentSongIndex = 0;

    function updateMusicUI(isPlaying) {
        const song = musicPlaylist[currentSongIndex];
        document.getElementById('bgm-song-title').innerText = song.title;
        document.getElementById('bgm-status').innerText = isPlaying ? "Playing..." : "Paused";
        document.getElementById('music-icon').className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
    }

    function toggleMusic() {
        const audio = document.getElementById('bg-music');
        if (!audio.src || audio.src !== musicPlaylist[currentSongIndex].src) {
            audio.src = musicPlaylist[currentSongIndex].src;
        }
        if (audio.paused) {
            audio.play().catch(e => alert("播放失败"));
            updateMusicUI(true);
        } else {
            audio.pause();
            updateMusicUI(false);
        }
    }

    function nextSong() {
        const audio = document.getElementById('bg-music');
        currentSongIndex = (currentSongIndex + 1) % musicPlaylist.length;
        audio.src = musicPlaylist[currentSongIndex].src;
        audio.play().catch(e => console.log("Auto play prevented"));
        updateMusicUI(true);
    }
    
    function prevSong() {
        const audio = document.getElementById('bg-music');
        currentSongIndex = (currentSongIndex - 1 + musicPlaylist.length) % musicPlaylist.length;
        audio.src = musicPlaylist[currentSongIndex].src;
        audio.play().catch(e => console.log("Auto play prevented"));
        updateMusicUI(true);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
        }
        
        setAppMode('bva'); 
        document.getElementById('ratio-input-area-left').value = "95, 40, 30, 20, 10, 5, 5";
        document.getElementById('ratio-input-area-right').value = "55, 40, 30, 20, 10, 5, 5";
        document.getElementById('kff-ratio-input-area-left').value = "43.75, 37.5, 31.25, 18.75, 12.5, 12.5, 12.5, 6.25, 3.125";
        document.getElementById('kff-ratio-input-area-right').value = "43.75, 37.5, 31.25, 18.75, 12.5, 12.5, 12.5, 6.25, 3.125";
        applyBvaPreset(1);
        toggleBvaAttrUI();
        initLongMemoryFields();
        toggleBvaMemUI();
        toggleBvaSoftFields();
        updateMusicUI(false);
        
        // Listeners for Repulsion Chart updates
        ['bva-inp-min-hard', 'bva-inp-min-soft', 'bva-inp-max-soft', 'bva-inp-max-hard', 
         'bva-inp-min-rep', 'bva-inp-max-rep', 'bva-inp-soft-toggle', 'bva-inp-base', 'bva-inp-custom-rep-toggle'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('input', renderRepulsionChart);
                el.addEventListener('change', renderRepulsionChart);
            }
        });
        window.addEventListener('resize', () => { renderWeightChart(); renderRepulsionChart(); });
    });

    let currentAppMode = 'binary';
    let binMode = 'direct'; 

    function setAppMode(mode) {
        currentAppMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');
        
        document.getElementById('module-binary').classList.toggle('hidden', mode !== 'binary');
        document.getElementById('module-kff').classList.toggle('hidden', mode !== 'kff');
        document.getElementById('module-bva').classList.toggle('hidden', mode !== 'bva');
        
        document.getElementById('app-body').className = ''; 
        if(document.body.classList.contains('light-mode')) document.getElementById('app-body').classList.add('light-mode');
        document.getElementById('app-body').classList.add(mode + '-mode');
        document.getElementById('config-sidebar-card').classList.toggle('hidden', !(mode === 'binary' && binMode === 'percent'));
        
        renderHistorySidebar(); 
        if(mode === 'bva') setTimeout(renderRepulsionChart, 100);
    }

    // ==========================================
    // BVA 预设与逻辑 (v14.1 Updated)
    // ==========================================
    const BVA_PRESETS = {
        1:{
            base: "50",
            minHard: "35", minSoft: "40", 
            maxSoft: "70", maxHard: "75", 
            useSoft: false,
            dec: "25 22.5 20 17.5 15 12.5 10 7.5 5", 
            inc: "30 22.5 20 17.5 15 12.5 10 7.5 5", 
            minRep: "75",
            maxRep: "75",
            attrLimit: "10",
            attrStr: "100",
            attrVal: "50",
            attrMode: "auto",
            smartAttr: false, // 预设1默认关闭智能吸引
            pull: "always", 
            memType: "short",
            memWin: "3", 
            memShortAlgo: "linear",
            memLongAlgo: "uniform",
            startupMode: "rigorous",
            customRep: false
        },
        2: { 
            base: "2",
            dec: "27.5  31.25 25 20 14.5 13 11 8 6", 
            inc: "43.75 31.25 25 20 14.5 13 11 8 6", 
            minHard: "1", minSoft: "1.3", 
            maxSoft: "2.5", maxHard: "3", 
            useSoft: false,
            minRep: "75", 
            maxRep: "75", 
            attrLimit: "0.3", 
            attrStr: "25", 
            attrMode: "manual", 
            attrVal: "2", 
            smartAttr: false,
            pull: "always",
            memType: 'short', 
            memWin: "5", 
            memShortAlgo: 'linear', 
            memLongAlgo: 'recent', 
            startupMode: 'rigorous',
            customRep: false
        },
        3: { 
            base: "50",
            minHard: "20", minSoft: "42", 
            maxSoft: "70", maxHard: "90", 
            useSoft: true,
            dec: "25   22.5 20 17.5 15 12.5 12.5 10 7.5 5 5 2.5", 
            inc: "27.5 22.5 20 17.5 15 12.5 12.5 10 7.5 5 5 2.5", 
            minRep: "50", 
            maxRep: "50", 
            attrLimit: "20",
            attrStr: "70",
            attrVal: "50",
            attrMode: "auto",
            smartAttr: true, // 预设3默认开启智能吸引
            pull: "away", 
            memType: "short",
            memWin: "9", 
            memShortAlgo: 'linear', 
            memLongAlgo: 'recent', 
            startupMode: 'conservative',
            customRep: false
        }
    };
    
    function applyBvaPreset(id) {
        const p = BVA_PRESETS[id]; 
        if(!p) return;

        if(p.base) document.getElementById('bva-inp-base').value = p.base;
        if(p.minHard) document.getElementById('bva-inp-min-hard').value = p.minHard;
        if(p.minSoft) document.getElementById('bva-inp-min-soft').value = p.minSoft;
        if(p.maxSoft) document.getElementById('bva-inp-max-soft').value = p.maxSoft;
        if(p.maxHard) document.getElementById('bva-inp-max-hard').value = p.maxHard;
        
        document.getElementById('bva-inp-soft-toggle').checked = p.useSoft !== false; 
        
        document.getElementById('bva-inp-custom-rep-toggle').checked = p.customRep === true;
        toggleBvaRepulsionMode();
        
        toggleBvaSoftFields();

        document.getElementById('bva-inp-min-rep').value = p.minRep;
        document.getElementById('bva-inp-max-rep').value = p.maxRep;
        document.getElementById('bva-inp-ratios-dec').value = p.dec;
        document.getElementById('bva-inp-ratios-inc').value = p.inc;

        if(p.attrLimit) document.getElementById('bva-inp-attr-limit').value = p.attrLimit;
        if(p.attrMode) document.getElementById('bva-inp-attr-mode').value = p.attrMode;
        
        // 智能吸引开关
        document.getElementById('bva-inp-smart-attr-toggle').checked = p.smartAttr === true;

        document.getElementById('bva-inp-attr-str').value = p.attrStr;
        document.getElementById('bva-inp-pull-toggle').value = p.pull || "always";
        document.getElementById('bva-inp-mem-type').value = p.memType;
        document.getElementById('bva-inp-win-size').value = p.memWin || 5;
        document.getElementById('bva-inp-short-algo').value = p.memShortAlgo || 'linear';
        if(p.memLongAlgo) document.getElementById('bva-inp-long-algo').value = p.memLongAlgo;
        if(p.attrVal) document.getElementById('bva-inp-attr-val').value = p.attrVal;

        if(p.startupMode) document.getElementById('bva-inp-startup-mode').value = p.startupMode;
        
        toggleBvaMemUI();
        toggleBvaAttrUI();
        renderRepulsionChart();
    }

    // ==========================================
    // Binary & KFF Logic (Standard)
    // ==========================================
    let binState = { l: 0, r: 0, base: 0, currentIter: 0, maxIter: 10, history: [], ratiosLeft: [], ratiosRight: [], tempL:0, tempR:0 };
    function switchBinTab(mode) {
        binMode = mode;
        document.querySelectorAll('#module-binary .tab').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        document.getElementById('bin-option-direct').classList.toggle('hidden', mode !== 'direct');
        document.getElementById('bin-option-percent').classList.toggle('hidden', mode !== 'percent');
        document.getElementById('config-sidebar-card').classList.toggle('hidden', mode !== 'percent');
        document.getElementById('bin-direct-range-display').classList.toggle('hidden', mode !== 'direct');
    }
    function binStart() {
        binState.history = []; binState.currentIter = 0;
        if (binMode === 'direct') {
            binState.l = parseFloat(document.getElementById('bin-inp-min').value);
            binState.r = parseFloat(document.getElementById('bin-inp-max').value);
            binState.base = parseFloat(document.getElementById('bin-inp-base-direct').value);
            binState.maxIter = parseInt(document.getElementById('bin-inp-iter').value) || 10;
            if (binState.base < binState.l || binState.base > binState.r) { alert("基准值必须在范围内"); return; }
        } else {
            binState.base = parseFloat(document.getElementById('bin-inp-base').value);
            binState.ratiosLeft = document.getElementById('ratio-input-area-left').value.split(/[\s,，]+/).map(x=>parseFloat(x)/100);
            binState.ratiosRight = document.getElementById('ratio-input-area-right').value.split(/[\s,，]+/).map(x=>parseFloat(x)/100);
            binState.maxIter = binState.ratiosLeft.length;
            binState.l = binState.base * (1 - binState.ratiosRight[0]);
            binState.r = binState.base * (1 + binState.ratiosLeft[0]);
        }
        document.getElementById('bin-setupCard').classList.add('hidden');
        document.getElementById('bin-processCard').classList.remove('hidden');
        document.getElementById('bin-resultCard').classList.add('hidden');
        document.getElementById('bin-history-body').innerHTML = '';
        binNextStep();
    }
    function binNextStep() {
        if (binState.currentIter >= binState.maxIter) { binShowResult(); return; }
        binState.currentIter++;
        if (binMode === 'direct') {
            if (binState.history.length > 0) binState.base = preciseRound((binState.l + binState.r)/2, PRECISION);
            binState.tempL = binState.l; binState.tempR = binState.r;
            document.getElementById('bin-current-l').innerText = binState.l.toFixed(PRECISION);
            document.getElementById('bin-current-r').innerText = binState.r.toFixed(PRECISION);
            document.getElementById('bin-range-hint').innerText = "";
        } else {
            const rL = binState.ratiosLeft[binState.currentIter-1] || 0.05;
            const rR = binState.ratiosRight[binState.currentIter-1] || 0.05;
            binState.tempL = preciseRound(binState.base * (1 - rR), PRECISION);
            binState.tempR = preciseRound(binState.base * (1 + rL), PRECISION);
            document.getElementById('bin-range-hint').innerText = `调整: -${(rR*100).toFixed(1)}% / +${(rL*100).toFixed(1)}%`;
        }
        document.getElementById('bin-step-indicator').innerText = `Step ${binState.currentIter} / ${binState.maxIter}`;
        document.getElementById('bin-current-val').innerText = binState.base.toFixed(PRECISION);
    }
    function binProcessDecision(d) {
        binState.history.push({ iter: binState.currentIter, l: binState.tempL, mid: binState.base, r: binState.tempR, selection: d });
        const row = `<tr><td>${binState.currentIter}</td><td class="${d==='slow'?'selected':''}">${binState.tempL.toFixed(PRECISION)}</td><td class="td-highlight">${binState.base.toFixed(PRECISION)}</td><td class="${d==='fast'?'selected':''}">${binState.tempR.toFixed(PRECISION)}</td></tr>`;
        document.getElementById('bin-history-body').insertAdjacentHTML('afterbegin', row);
        if (binMode === 'direct') { if (d === 'fast') binState.r = binState.base; else binState.l = binState.base; } else { binState.base = d === 'fast' ? preciseRound((binState.base + binState.tempL)/2, PRECISION) : preciseRound((binState.base + binState.tempR)/2, PRECISION); }
        binNextStep();
    }
    function binManualEditBase() { const val = prompt("修改当前值:", binState.base); if (val && !isNaN(val)) { binState.base = parseFloat(val); binState.currentIter--; binNextStep(); } }
    function binManualEditLimit(type) { const val = prompt(`修改${type==='l'?'下限':'上限'}:`, type==='l'?binState.l:binState.r); if (val && !isNaN(val)) { if (type==='l') binState.l = parseFloat(val); else binState.r = parseFloat(val); binState.currentIter--; binNextStep(); } }
    function binShowResult() { document.getElementById('bin-processCard').classList.add('hidden'); document.getElementById('bin-resultCard').classList.remove('hidden'); document.getElementById('bin-final-result').innerText = binState.base.toFixed(PRECISION); renderHistorySidebar(binState.history, binState.base, 'binary'); }
    function binReset() { document.getElementById('bin-setupCard').classList.remove('hidden'); document.getElementById('bin-processCard').classList.add('hidden'); document.getElementById('bin-resultCard').classList.add('hidden'); }

    let kffState = { base:0, low:0, high:0, step:0, max:0, history:[], ratiosL:[], ratiosR:[] };
    function kffStart() {
        kffState.base = parseFloat(document.getElementById('kff-inp-base').value);
        if (isNaN(kffState.base)) { alert("请输入基准值"); return; }
        kffState.ratiosL = document.getElementById('kff-ratio-input-area-left').value.split(/[\s,，]+/).map(x=>parseFloat(x)/100);
        kffState.ratiosR = document.getElementById('kff-ratio-input-area-right').value.split(/[\s,，]+/).map(x=>parseFloat(x)/100);
        kffState.max = kffState.ratiosL.length;
        kffState.step = 0; kffState.history = [];
        document.getElementById('kff-setupCard').classList.add('hidden'); document.getElementById('kff-processCard').classList.remove('hidden'); document.getElementById('kff-resultCard').classList.add('hidden'); document.getElementById('kff-history-body').innerHTML = ''; kffNext();
    }
    function kffNext() {
        if (kffState.step >= kffState.max) { kffFinish(); return; }
        const rL = kffState.ratiosL[kffState.step]; const rR = kffState.ratiosR[kffState.step];
        kffState.low = preciseRound(kffState.base * (1 - rR), PRECISION); kffState.high = preciseRound(kffState.base * (1 + rL), PRECISION);
        document.getElementById('kff-step-indicator').innerText = `Phase ${kffState.step+1} / ${kffState.max}`;
        document.getElementById('kff-current-base').innerText = kffState.base.toFixed(PRECISION);
        document.getElementById('kff-ratio-display').innerText = `幅度: -${(rR*100).toFixed(2)}% / +${(rL*100).toFixed(2)}%`;
        document.getElementById('kff-val-low').innerText = kffState.low.toFixed(PRECISION);
        document.getElementById('kff-val-high').innerText = kffState.high.toFixed(PRECISION);
    }
    function kffProcessDecision(choice) {
        kffState.history.push({ iter: kffState.step+1, l: kffState.low, mid: kffState.base, r: kffState.high, selection: choice });
        const row = `<tr><td>${kffState.step+1}</td><td>${kffState.low}</td><td class="td-highlight">${kffState.base}</td><td>${kffState.high}</td></tr>`;
        document.getElementById('kff-history-body').insertAdjacentHTML('afterbegin', row);
        kffState.base = choice === 'low' ? kffState.low : kffState.high; kffState.step++; kffNext();
    }
    function kffManualEditBase() { const val = prompt("手动修改基准:", kffState.base); if (val && !isNaN(val)) { kffState.base = parseFloat(val); kffNext(); } }
    function kffFinish() { document.getElementById('kff-processCard').classList.add('hidden'); document.getElementById('kff-resultCard').classList.remove('hidden'); document.getElementById('kff-final-result').innerText = kffState.base.toFixed(PRECISION); renderHistorySidebar(kffState.history, kffState.base, 'kff'); }
    function kffReset() { document.getElementById('kff-setupCard').classList.remove('hidden'); document.getElementById('kff-processCard').classList.add('hidden'); document.getElementById('kff-resultCard').classList.add('hidden'); }

    // ==========================================
    // BVA Logic (Enhanced v14.1)
    // ==========================================
    let bvaState = {
        base: 0, ratiosDec: [], ratiosInc: [], 
        minHard: 0, minSoft: 0, maxSoft: 0, maxHard: 0,
        useSoft: true,
        minRep: 0, maxRep: 0,
        customRepMode: false,
        repulsionPoints: [],
        attrMode: 'auto', attrVal: 0, attrStr: 0, attrLimit: 5, pullMode: 'always', 
        smartAttr: false, // NEW State
        memType: 'short', memShortWin: 3, memShortAlgo: 'linear', memLongAlgo: 'recent', 
        startupMode: 'rigorous', 
        history: [], step: 0, maxSteps: 0
    };

    function toggleBvaRepulsionMode() {
        const customMode = document.getElementById('bva-inp-custom-rep-toggle').checked;
        document.getElementById('bva-rep-standard-ui').classList.toggle('hidden', customMode);
        document.getElementById('bva-rep-custom-ui').classList.toggle('hidden', !customMode);
        renderRepulsionChart();
    }

    function toggleBvaSoftFields() {
        const enabled = document.getElementById('bva-inp-soft-toggle').checked;
        const fields = document.querySelectorAll('.soft-field');
        fields.forEach(f => f.style.opacity = enabled ? '1' : '0.4');
        fields.forEach(f => f.style.pointerEvents = enabled ? 'auto' : 'none');
        renderRepulsionChart();
    }

    function addCustomRepPointsPrompt() {
        const countStr = prompt("请输入要生成的控制点数量 (例如 5):", "3");
        const count = parseInt(countStr);
        if (isNaN(count) || count < 1) return;
        
        const list = document.getElementById('bva-custom-rep-list');
        list.innerHTML = ""; 
        
        for(let i=0; i<count; i++) {
            addCustomRepPointRow(i+1, 0, 0);
        }
        renderRepulsionChart();
    }
    
    function addCustomRepPointRow(idx, valX, valY) {
        const list = document.getElementById('bva-custom-rep-list');
        const div = document.createElement('div');
        div.className = 'rep-point-row';
        div.innerHTML = `
            <span class="rep-point-index">${idx}</span>
            <input type="number" class="rep-x" value="${valX}" onchange="renderRepulsionChart()">
            <input type="number" class="rep-y" value="${valY}" onchange="renderRepulsionChart()">
            <i class="fas fa-trash rep-del-btn" onclick="this.parentElement.remove(); renderRepulsionChart();"></i>
        `;
        list.appendChild(div);
    }

    // New Helper: Generate points, accepting a center override for dynamic moving
    function generateRepulsionPoints(overrideCenterVal = null) {
        const customMode = document.getElementById('bva-inp-custom-rep-toggle').checked;
        let points = [];
        
        if (customMode) {
            const rows = document.querySelectorAll('.rep-point-row');
            rows.forEach(row => {
                const x = parseFloat(row.querySelector('.rep-x').value);
                const y = parseFloat(row.querySelector('.rep-y').value);
                if (!isNaN(x) && !isNaN(y)) {
                    points.push({x: x, y: y});
                }
            });
            points.sort((a,b) => a.x - b.x);
        } else {
            // Standard Mode
            const minH = parseFloat(document.getElementById('bva-inp-min-hard').value) || 0;
            const maxH = parseFloat(document.getElementById('bva-inp-max-hard').value) || 100;
            const minS = parseFloat(document.getElementById('bva-inp-min-soft').value) || minH;
            const maxS = parseFloat(document.getElementById('bva-inp-max-soft').value) || maxH;
            const minRep = parseFloat(document.getElementById('bva-inp-min-rep').value) || 0;
            const maxRep = parseFloat(document.getElementById('bva-inp-max-rep').value) || 0;
            const useSoft = document.getElementById('bva-inp-soft-toggle').checked;
            
            points.push({x: minH, y: minRep}); 
            
            if(useSoft) {
                points.push({x: minS, y: 0}); 
                points.push({x: maxS, y: 0}); 
            } else {
                let center = overrideCenterVal !== null ? overrideCenterVal : (parseFloat(document.getElementById('bva-inp-base').value) || (minH+maxH)/2);
                points.push({x: center, y: 0}); 
            }
            points.push({x: maxH, y: maxRep}); 
            points.sort((a,b) => a.x - b.x);
        }
        return points;
    }

    function toggleBvaAttrUI() {
        const mode = document.getElementById('bva-inp-attr-mode').value;
        document.getElementById('bva-ui-manual').classList.toggle('hidden', mode !== 'manual');
        document.getElementById('bva-ui-auto').classList.toggle('hidden', mode !== 'auto');
        renderWeightChart(); 
    }
    function toggleBvaMemUI() {
        const memType = document.getElementById('bva-inp-mem-type').value;
        const shortAlgo = document.getElementById('bva-inp-short-algo').value;
        const longAlgo = document.getElementById('bva-inp-long-algo').value;
        const winSize = Math.max(1, parseInt(document.getElementById('bva-inp-win-size').value) || 3);
        document.getElementById('bva-inp-win-size').value = winSize;
        document.getElementById('bva-sub-short').classList.toggle('hidden', memType !== 'short');
        document.getElementById('bva-sub-long').classList.toggle('hidden', memType !== 'long');
        const isShortMan = (memType === 'short' && shortAlgo === 'manual');
        document.getElementById('bva-sub-short-manual').classList.toggle('hidden', !isShortMan);
        if (isShortMan) rebuildShortManualInputs(winSize);
        const isLongCustom = (memType === 'long' && longAlgo === 'custom');
        document.getElementById('bva-sub-long-custom').classList.toggle('hidden', !isLongCustom);
        if (isLongCustom && document.getElementById('bva-long-custom-fields').children.length === 0) initLongMemoryFields();
        renderWeightChart(); 
    }
    function rebuildShortManualInputs(count) {
        const container = document.getElementById('bva-sub-short-manual-fields');
        if (container.children.length === count) return;
        container.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const label = i === count-1 ? '最近(Step N)' : (i === 0 ? '最远(Step 1)' : `Step ${i+1}`);
            const div = document.createElement('div'); div.className = 'input-group';
            div.innerHTML = `<label style="font-size:0.75rem;">${label} (%)</label><input type="number" class="bva-short-weight-input" value="${Math.floor(100/count)}" oninput="updateWeightTotal('short')">`;
            container.appendChild(div);
        }
        updateWeightTotal('short');
    }
    function initLongMemoryFields() {
        const container = document.getElementById('bva-long-custom-fields'); container.innerHTML = '';
        addLongInput(0, '起点 (最远)', 20); addLongInput(1, '终点 (最近)', 80);
        updateWeightTotal('long');
    }
    function addLongInput(idx, label, val) {
        const div = document.createElement('div'); div.className = 'input-group';
        div.innerHTML = `<label style="font-size:0.75rem;">${label || '中间点'} (%)</label><input type="number" class="bva-long-weight-input" value="${val}" oninput="updateWeightTotal('long')">`;
        document.getElementById('bva-long-custom-fields').appendChild(div);
    }
    function addLongMemoryPoint() {
        const container = document.getElementById('bva-long-custom-fields');
        const inputs = Array.from(container.querySelectorAll('input'));
        const vals = inputs.map(i => parseFloat(i.value) || 0);
        const newCount = vals.length + 1;
        container.innerHTML = '';
        for (let i = 0; i < newCount; i++) {
            let label = i === 0 ? '起点 (最远)' : (i === newCount-1 ? '终点 (最近)' : `中间点 ${i}`);
            let progress = i / (newCount - 1);
            let oldProgressIndex = progress * (vals.length - 1);
            let idxLow = Math.floor(oldProgressIndex); let idxHigh = Math.ceil(oldProgressIndex);
            let val = vals[idxLow] + (vals[idxHigh] - vals[idxLow]) * (oldProgressIndex - idxLow);
            addLongInput(i, label, Math.round(val));
        }
        normalizeWeights('long');
    }
    function removeLongMemoryPoint() {
        const container = document.getElementById('bva-long-custom-fields');
        if (container.children.length <= 2) return alert("至少需要两个点");
        container.removeChild(container.lastElementChild);
        container.lastElementChild.querySelector('label').innerText = '终点 (最近) (%)';
        normalizeWeights('long');
    }
    function updateWeightTotal(type) {
        const selector = type === 'short' ? '.bva-short-weight-input' : '.bva-long-weight-input';
        const display = document.getElementById(type === 'short' ? 'bva-weight-total' : 'bva-long-weight-total');
        const container = document.getElementById(type === 'short' ? 'bva-weight-total-display' : 'bva-long-weight-total-display');
        let sum = 0; document.querySelectorAll(selector).forEach(i => sum += (parseFloat(i.value) || 0));
        display.innerText = sum.toFixed(1);
        container.className = Math.abs(sum - 100) < 0.1 ? 'weight-total-display weight-total-valid' : 'weight-total-display weight-total-invalid';
        renderWeightChart(); 
    }
    function normalizeWeights(type) {
        const selector = type === 'short' ? '.bva-short-weight-input' : '.bva-long-weight-input';
        const inputs = document.querySelectorAll(selector);
        let sum = 0; inputs.forEach(i => sum += (parseFloat(i.value) || 0)); if (sum === 0) sum = 1; 
        inputs.forEach(i => { let val = parseFloat(i.value) || 0; i.value = (val / sum * 100).toFixed(1); });
        updateWeightTotal(type);
    }
    
    // ----------------------------------------------------
    // Repulsion Chart (v14.1)
    // ----------------------------------------------------
    function renderRepulsionChart() {
        // Determine which canvas to draw to based on visibility
        let canvasId = 'repulsionChart';
        let currentBase = parseFloat(document.getElementById('bva-inp-base').value);
        
        // If process card is visible, use the process chart and the process state base
        if (!document.getElementById('bva-processCard').classList.contains('hidden')) {
            canvasId = 'repulsionChartProcess';
            currentBase = bvaState.base;
        }

        const canvas = document.getElementById(canvasId); 
        if(!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth; 
        const height = canvas.height = canvas.offsetHeight;
        const styles = getComputedStyle(document.body);
        const colorLine = styles.getPropertyValue('--accent-purple').trim();
        const colorGrid = styles.getPropertyValue('--chart-grid').trim();
        const colorText = styles.getPropertyValue('--text-secondary').trim();
        
        ctx.clearRect(0, 0, width, height);

        // Generate points using currentBase as the center override (if applicable)
        const points = generateRepulsionPoints(currentBase);
        if(points.length < 2) return;

        // Calc Range for Axis
        const minX = points[0].x;
        const maxX = points[points.length-1].x;
        const rangeX = maxX - minX;
        
        const paddingLeft = 35;
        const paddingRight = 15;
        const paddingBottom = 20;
        const paddingTop = 10;
        
        const drawW = width - paddingLeft - paddingRight;
        const drawH = height - paddingBottom - paddingTop;
        
        if (rangeX <= 0) return;

        const xToPx = (val) => paddingLeft + ((val - minX) / rangeX) * drawW;
        const yToPx = (pct) => height - paddingBottom - (pct / 100) * drawH;

        // Draw Y Axis Grid & Labels (Real %)
        ctx.fillStyle = colorText;
        ctx.font = '9px Arial';
        ctx.textAlign = 'right';
        for(let i=0; i<=4; i++) {
            let pct = i * 25;
            let y = yToPx(pct);
            ctx.fillText(pct + "%", paddingLeft - 5, y + 3);
            ctx.beginPath(); ctx.moveTo(paddingLeft, y); ctx.lineTo(width - paddingRight, y);
            ctx.strokeStyle = colorGrid; ctx.stroke();
        }
        
        // Draw X Axis Labels (Real Values)
        ctx.textAlign = 'center';
        ctx.fillText(minX.toFixed(1), paddingLeft, height - 5);
        ctx.fillText(maxX.toFixed(1), width - paddingRight, height - 5);
        ctx.fillText(((minX+maxX)/2).toFixed(1), paddingLeft + drawW/2, height - 5);

        // Draw Field Shape
        ctx.beginPath();
        points.forEach((p, i) => {
            if(i===0) ctx.moveTo(xToPx(p.x), yToPx(p.y));
            else ctx.lineTo(xToPx(p.x), yToPx(p.y));
        });
        
        // Fill
        ctx.lineTo(xToPx(maxX), yToPx(0));
        ctx.lineTo(xToPx(minX), yToPx(0));
        ctx.fillStyle = 'rgba(187, 134, 252, 0.15)';
        if(document.body.classList.contains('light-mode')) ctx.fillStyle = 'rgba(74, 20, 140, 0.08)';
        ctx.fill();
        
        // Stroke
        ctx.beginPath();
        points.forEach((p, i) => {
            if(i===0) ctx.moveTo(xToPx(p.x), yToPx(p.y));
            else ctx.lineTo(xToPx(p.x), yToPx(p.y));
        });
        ctx.strokeStyle = colorLine;
        ctx.lineWidth = 2;
        ctx.stroke();

        // Draw Current Base Position
        let bx = xToPx(currentBase);
        if (bx >= paddingLeft && bx <= width-paddingRight) {
            ctx.beginPath();
            ctx.moveTo(bx, height-paddingBottom);
            ctx.lineTo(bx, paddingTop);
            ctx.strokeStyle = styles.getPropertyValue('--accent-orange').trim();
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    // Unified Physics Calculation Function
    function calculateRepulsionFromPoints(val, points) {
        if(points.length < 2) return 0;
        
        if(val <= points[0].x) return points[0].y / 100;
        if(val >= points[points.length-1].x) return points[points.length-1].y / 100;
        
        for(let i=0; i<points.length-1; i++) {
            if(val >= points[i].x && val <= points[i+1].x) {
                let range = points[i+1].x - points[i].x;
                if(range === 0) return points[i].y / 100;
                let dist = val - points[i].x;
                let ratio = dist / range;
                let yDiff = points[i+1].y - points[i].y;
                return (points[i].y + ratio * yDiff) / 100;
            }
        }
        return 0;
    }

    function renderWeightChart() {
        const canvas = document.getElementById('weightChart'); if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth; const height = canvas.height = canvas.offsetHeight;
        const styles = getComputedStyle(document.body);
        const colorLine = styles.getPropertyValue('--chart-line').trim();
        const colorFill = styles.getPropertyValue('--chart-fill').trim();
        const colorPoint = styles.getPropertyValue('--chart-point').trim();
        const colorGrid = styles.getPropertyValue('--chart-grid').trim();
        const colorText = styles.getPropertyValue('--text-secondary').trim();
        
        ctx.clearRect(0, 0, width, height);
        
        const memType = document.getElementById('bva-inp-mem-type').value;
        let weights = [];
        if (memType === 'short') {
            const winSize = parseInt(document.getElementById('bva-inp-win-size').value);
            const algo = document.getElementById('bva-inp-short-algo').value;
            if (algo === 'uniform') weights = new Array(winSize).fill(1);
            else if (algo === 'linear') weights = Array.from({length: winSize}, (_, i) => i + 1);
            else { document.querySelectorAll('.bva-short-weight-input').forEach(i => weights.push(parseFloat(i.value)||0)); }
        } else {
            const simSteps = 20; const algo = document.getElementById('bva-inp-long-algo').value;
            if (algo === 'uniform') weights = new Array(simSteps).fill(1);
            else if (algo === 'recent') weights = Array.from({length: simSteps}, (_, i) => Math.pow(1.5, i));
            else if (algo === 'nostalgia') weights = Array.from({length: simSteps}, (_, i) => (i===0 ? 5 : (i===simSteps-1 ? 3 : 1)));
            else { const inputs = Array.from(document.querySelectorAll('.bva-long-weight-input')).map(i => parseFloat(i.value)||0); weights = interpolateWeights(inputs, simSteps); }
        }
        if(weights.length === 0) return;
        
        const sumW = weights.reduce((a,b)=>a+b, 0) || 1;
        const pctWeights = weights.map(w => (w/sumW)*100);
        
        const maxPct = Math.max(...pctWeights);
        const yMaxAxis = Math.ceil(maxPct / 10) * 10 || 100;
        
        const paddingLeft = 35; 
        const paddingRight = 15;
        const paddingBottom = 20;
        const paddingTop = 20;
        
        const chartW = width - paddingLeft - paddingRight; 
        const chartH = height - paddingBottom - paddingTop; 
        const stepX = chartW / (weights.length - 1 || 1);

        ctx.fillStyle = colorText;
        ctx.font = '9px Arial';
        ctx.textAlign = 'right';
        for(let i=0; i<=4; i++) {
            let val = (yMaxAxis * i) / 4;
            let y = height - paddingBottom - (i/4) * chartH;
            ctx.fillText(val.toFixed(1) + "%", paddingLeft - 5, y + 3);
            ctx.beginPath(); ctx.moveTo(paddingLeft, y); ctx.lineTo(width - paddingRight, y);
            ctx.strokeStyle = colorGrid; ctx.stroke();
        }

        ctx.beginPath(); 
        pctWeights.forEach((w, i) => { 
            const x = paddingLeft + i * stepX; 
            const y = height - paddingBottom - (w / yMaxAxis) * chartH; 
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); 
        });
        ctx.lineTo(width - paddingRight, height - paddingBottom); 
        ctx.lineTo(paddingLeft, height - paddingBottom); 
        ctx.closePath(); 
        ctx.fillStyle = colorFill; 
        ctx.fill();
        
        ctx.beginPath(); 
        pctWeights.forEach((w, i) => { 
            const x = paddingLeft + i * stepX; 
            const y = height - paddingBottom - (w / yMaxAxis) * chartH; 
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); 
        }); 
        ctx.strokeStyle = colorLine; 
        ctx.lineWidth = 2; 
        ctx.stroke();
        
        ctx.textAlign = 'center';
        pctWeights.forEach((w, i) => { 
            const x = paddingLeft + i * stepX; 
            const y = height - paddingBottom - (w / yMaxAxis) * chartH; 
            
            ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); 
            ctx.fillStyle = colorPoint; ctx.fill(); 

            if (weights.length <= 15 || i % 2 === 0 || i === weights.length - 1) {
                ctx.fillStyle = styles.getPropertyValue('--text-primary').trim();
                ctx.fillText(w.toFixed(1) + "%", x, y - 8);
            }
        });
        
        ctx.fillStyle = colorText; 
        ctx.textAlign = 'left'; ctx.fillText('Oldest', paddingLeft, height - 5); 
        ctx.textAlign = 'right'; ctx.fillText('Newest', width - paddingRight, height - 5);
    }
    
    function interpolateWeights(keyframes, targetLength) {
        if (keyframes.length < 2) return new Array(targetLength).fill(1);
        const result = [];
        for (let i = 0; i < targetLength; i++) {
            let progress = i / (targetLength - 1); let kfPos = progress * (keyframes.length - 1);
            let idx = Math.floor(kfPos); let nextIdx = Math.ceil(kfPos); let t = kfPos - idx;
            let val = keyframes[idx] * (1-t) + keyframes[nextIdx] * t; result.push(val);
        }
        return result;
    }

    function exportBVASettings() {
        const settings = {
            base: document.getElementById('bva-inp-base').value,
            ratiosDec: document.getElementById('bva-inp-ratios-dec').value,
            ratiosInc: document.getElementById('bva-inp-ratios-inc').value,
            minHard: document.getElementById('bva-inp-min-hard').value,
            minSoft: document.getElementById('bva-inp-min-soft').value,
            maxSoft: document.getElementById('bva-inp-max-soft').value,
            maxHard: document.getElementById('bva-inp-max-hard').value,
            useSoft: document.getElementById('bva-inp-soft-toggle').checked,
            minRep: document.getElementById('bva-inp-min-rep').value,
            maxRep: document.getElementById('bva-inp-max-rep').value,
            customRepMode: document.getElementById('bva-inp-custom-rep-toggle').checked,
            
            attrMode: document.getElementById('bva-inp-attr-mode').value,
            attrLimit: document.getElementById('bva-inp-attr-limit').value,
            attrStr: document.getElementById('bva-inp-attr-str').value,
            attrVal: document.getElementById('bva-inp-attr-val').value,
            smartAttr: document.getElementById('bva-inp-smart-attr-toggle').checked, // Export Smart Attr
            pullMode: document.getElementById('bva-inp-pull-toggle').value,
            
            memType: document.getElementById('bva-inp-mem-type').value,
            memShortWin: document.getElementById('bva-inp-win-size').value,
            memShortAlgo: document.getElementById('bva-inp-short-algo').value,
            memLongAlgo: document.getElementById('bva-inp-long-algo').value,
            startupMode: document.getElementById('bva-inp-startup-mode').value,
            
            timestamp: new Date().toISOString()
        };

        if (settings.customRepMode) {
            const repPoints = [];
            document.querySelectorAll('.rep-point-row').forEach(row => {
                const x = row.querySelector('.rep-x').value;
                const y = row.querySelector('.rep-y').value;
                repPoints.push({ x, y });
            });
            settings.customRepPoints = repPoints;
        }

        if (settings.memType === 'short' && settings.memShortAlgo === 'manual') {
            const shortWeights = [];
            document.querySelectorAll('.bva-short-weight-input').forEach(inp => {
                shortWeights.push(inp.value);
            });
            settings.customShortWeights = shortWeights;
        }

        if (settings.memType === 'long' && settings.memLongAlgo === 'custom') {
            const longWeights = [];
            document.querySelectorAll('.bva-long-weight-input').forEach(inp => {
                longWeights.push(inp.value);
            });
            settings.customLongWeights = longWeights;
        }

        const blob = new Blob([JSON.stringify(settings, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bva_settings_full_${new Date().getTime()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function importBVASettings(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const s = JSON.parse(e.target.result);
                
                const setVal = (id, val) => { if(val !== undefined && document.getElementById(id)) document.getElementById(id).value = val; };
                const setCheck = (id, val) => { if(val !== undefined && document.getElementById(id)) document.getElementById(id).checked = val; };

                setVal('bva-inp-base', s.base);
                setVal('bva-inp-ratios-dec', s.ratiosDec);
                setVal('bva-inp-ratios-inc', s.ratiosInc);
                setVal('bva-inp-min-hard', s.minHard);
                setVal('bva-inp-min-soft', s.minSoft);
                setVal('bva-inp-max-soft', s.maxSoft);
                setVal('bva-inp-max-hard', s.maxHard);
                setCheck('bva-inp-soft-toggle', s.useSoft);
                setVal('bva-inp-min-rep', s.minRep);
                setVal('bva-inp-max-rep', s.maxRep);
                setCheck('bva-inp-custom-rep-toggle', s.customRepMode);

                setVal('bva-inp-attr-mode', s.attrMode);
                setVal('bva-inp-attr-limit', s.attrLimit);
                setVal('bva-inp-attr-str', s.attrStr);
                setVal('bva-inp-attr-val', s.attrVal);
                setCheck('bva-inp-smart-attr-toggle', s.smartAttr); // Import Smart Attr
                setVal('bva-inp-pull-toggle', s.pullMode);

                setVal('bva-inp-mem-type', s.memType);
                setVal('bva-inp-win-size', s.memShortWin);
                setVal('bva-inp-short-algo', s.memShortAlgo);
                setVal('bva-inp-long-algo', s.memLongAlgo);
                setVal('bva-inp-startup-mode', s.startupMode);

                toggleBvaSoftFields();
                toggleBvaRepulsionMode();
                toggleBvaAttrUI();
                toggleBvaMemUI();

                if (s.customRepMode && s.customRepPoints && s.customRepPoints.length > 0) {
                    const list = document.getElementById('bva-custom-rep-list');
                    list.innerHTML = "";
                    s.customRepPoints.forEach((p, idx) => {
                        addCustomRepPointRow(idx + 1, p.x, p.y);
                    });
                }

                if (s.memType === 'short' && s.memShortAlgo === 'manual' && s.customShortWeights) {
                    rebuildShortManualInputs(s.customShortWeights.length);
                    const inputs = document.querySelectorAll('.bva-short-weight-input');
                    s.customShortWeights.forEach((val, i) => {
                        if (inputs[i]) inputs[i].value = val;
                    });
                    updateWeightTotal('short');
                }

                if (s.memType === 'long' && s.memLongAlgo === 'custom' && s.customLongWeights) {
                    const container = document.getElementById('bva-long-custom-fields');
                    container.innerHTML = '';
                    s.customLongWeights.forEach((val, i) => {
                        let label = i === 0 ? '起点 (最远)' : (i === s.customLongWeights.length-1 ? '终点 (最近)' : `中间点 ${i}`);
                        addLongInput(i, label, val);
                    });
                    updateWeightTotal('long');
                }

                renderRepulsionChart();
                renderWeightChart();
                alert("完整设置导入成功");
            } catch(err) {
                console.error(err);
                alert("导入失败: 文件格式错误");
            }
        };
        reader.readAsText(file);
    }

    function bvaStart() {
        bvaState.base = parseFloat(document.getElementById('bva-inp-base').value);
        bvaState.ratiosDec = document.getElementById('bva-inp-ratios-dec').value.split(/[\s,，]+/).map(x=>parseFloat(x)/100);
        bvaState.ratiosInc = document.getElementById('bva-inp-ratios-inc').value.split(/[\s,，]+/).map(x=>parseFloat(x)/100);
        bvaState.maxSteps = Math.max(bvaState.ratiosDec.length, bvaState.ratiosInc.length);
        
        bvaState.customRepMode = document.getElementById('bva-inp-custom-rep-toggle').checked;
        
        bvaState.attrMode = document.getElementById('bva-inp-attr-mode').value;
        bvaState.attrLimit = parseFloat(document.getElementById('bva-inp-attr-limit').value);
        bvaState.attrStr = parseFloat(document.getElementById('bva-inp-attr-str').value) / 100;
        bvaState.attrVal = parseFloat(document.getElementById('bva-inp-attr-val').value);
        bvaState.smartAttr = document.getElementById('bva-inp-smart-attr-toggle').checked; // Read Smart Toggle
        bvaState.pullMode = document.getElementById('bva-inp-pull-toggle').value;
        bvaState.memType = document.getElementById('bva-inp-mem-type').value;
        bvaState.memShortWin = parseInt(document.getElementById('bva-inp-win-size').value);
        bvaState.memShortAlgo = document.getElementById('bva-inp-short-algo').value;
        bvaState.memLongAlgo = document.getElementById('bva-inp-long-algo').value;
        bvaState.startupMode = document.getElementById('bva-inp-startup-mode').value; 
        bvaState.history = []; bvaState.step = 0;
        
        document.getElementById('bva-setupCard').classList.add('hidden');
        document.getElementById('bva-processCard').classList.remove('hidden');
        document.getElementById('bva-resultCard').classList.add('hidden');
        document.getElementById('bva-history-body').innerHTML = '';
        
        bvaUpdateUI();
        renderHistoryTable();
        updateUndoRedoButtons();
    }

    /* ==========================================
       权重计算 稳健性 (Point 3)
       ========================================== */
    function bvaCalcAutoAttraction() {
        const effectiveHistory = bvaState.history.slice(0, bvaState.step);
        if (effectiveHistory.length === 0) return bvaState.base;
        
        let validHist = bvaState.memType === 'short' ? effectiveHistory.slice(-bvaState.memShortWin) : effectiveHistory;
        let histLen = validHist.length;
        let fullWeights = [];

        if (bvaState.memType === 'short') {
            const winSize = bvaState.memShortWin;
            if (bvaState.memShortAlgo === 'uniform') fullWeights = new Array(winSize).fill(1);
            else if (bvaState.memShortAlgo === 'linear') fullWeights = Array.from({length: winSize}, (_, i) => i + 1);
            else { 
                const inputs = document.querySelectorAll('.bva-short-weight-input');
                if(inputs.length > 0) {
                    fullWeights = Array.from(inputs).map(i => parseFloat(i.value) || 0);
                } else {
                    fullWeights = new Array(winSize).fill(1); 
                }
            }
        } else {
            let len = Math.max(20, histLen);
            if (bvaState.memLongAlgo === 'custom') {
                const inputs = document.querySelectorAll('.bva-long-weight-input');
                if (inputs.length > 0) {
                    let keyframes = Array.from(inputs).map(i => parseFloat(i.value) || 0);
                    fullWeights = interpolateWeights(keyframes, len);
                } else {
                    fullWeights = new Array(len).fill(1);
                }
            } else if (bvaState.memLongAlgo === 'uniform') fullWeights = new Array(len).fill(1);
            else if (bvaState.memLongAlgo === 'recent') fullWeights = Array.from({length:len}, (_,i)=>Math.pow(1.5, i));
            else if (bvaState.memLongAlgo === 'nostalgia') fullWeights = Array.from({length:len}, (_,i)=>(i===0?5:(i===len-1?3:1)));
        }

        let activeWeights = [];
        const defLen = fullWeights.length;
        if (histLen < defLen) {
            if (bvaState.startupMode === 'conservative') {
                activeWeights = fullWeights.slice(0, histLen);
            } else {
                activeWeights = fullWeights.slice(defLen - histLen);
            }
        } else {
             activeWeights = fullWeights.slice(0, histLen); 
        }

        let sumW = 0, sumVal = 0;
        validHist.forEach((h, i) => {
            let w = activeWeights[i] || 1; 
            sumVal += h.memoryAnchor * w; 
            sumW += w;
        });
        return sumW === 0 ? bvaState.base : sumVal / sumW;
    }

    // --- BVA Core Calculation (Rewritten v14.1 for Smart Attraction) ---
    function calculateBvaNextStep(dir, manualValue = null) {
        let currentBase = bvaState.base;
        let target = bvaState.attrMode === 'manual' ? bvaState.attrVal : bvaCalcAutoAttraction();
        
        // Manual A: Override completely
        if (dir === 'manual_A') {
            return {
                newBase: manualValue,
                attValue: 0,
                repFactor: 1.0,
                status: "强制覆写 (Option A)",
                isMovingAway: false
            };
        }

        // 1. Calculate Base Movement Delta (No Attraction, No Repulsion yet)
        let baseDelta = 0;
        if (dir === 'manual_B') {
            baseDelta = manualValue - currentBase;
        } else {
            let rate = dir === 'high' ? 
                bvaState.ratiosInc[Math.min(bvaState.step, bvaState.ratiosInc.length-1)] : 
                bvaState.ratiosDec[Math.min(bvaState.step, bvaState.ratiosDec.length-1)];
            let direction = dir === 'high' ? 1 : -1;
            baseDelta = currentBase * rate * direction;
        }

        // 2. Calculate Potential Attraction Vector (Raw)
        let rawAttr = (target - currentBase) * bvaState.attrStr;
        let limit = bvaState.attrLimit;
        if (Math.abs(rawAttr) > limit) { rawAttr = (rawAttr > 0 ? 1 : -1) * limit; }

        // 3. Determine Permission (Can we use attraction?)
        let prelimWithoutAttr = currentBase + baseDelta;
        let distNow = Math.abs(currentBase - target);
        let distNext = Math.abs(prelimWithoutAttr - target);
        let isMovingAway = distNext > distNow; // Moving away from target without attraction

        let permissionToAttract = false;
        if (bvaState.pullMode === 'always') permissionToAttract = true;
        else if (bvaState.pullMode === 'away' && isMovingAway) permissionToAttract = true;
        else if (bvaState.pullMode === 'close' && !isMovingAway) permissionToAttract = true;

        // 4. Decide on Attraction Application (Smart vs Classic)
        let attrForce = 0;

        if (permissionToAttract) {
            if (bvaState.smartAttr) {
                // SMART MODE: Simulation
                // Scenario 1: Apply Attraction
                let posWithAttr = currentBase + baseDelta + rawAttr;
                let distWithAttr = Math.abs(posWithAttr - target);
                
                // Scenario 2: Don't Apply Attraction
                let posWithoutAttr = currentBase + baseDelta;
                let distWithoutAttr = Math.abs(posWithoutAttr - target);
                
                // Choose the one that lands closer to target
                if (distWithAttr < distWithoutAttr) {
                    attrForce = rawAttr; // Attracting helps
                } else {
                    attrForce = 0; // Attracting causes overshoot/error, better skip
                }
            } else {
                // CLASSIC MODE: Blindly apply if permission granted
                attrForce = rawAttr;
            }
        } else {
            // Permission denied -> No attraction
            attrForce = 0;
        }

        // 5. Finalize Delta
        let prelimDelta = baseDelta + attrForce;
        let nextPos = currentBase + prelimDelta;
        
        // 6. Apply Repulsion Field (Physics)
        let dynamicPoints = generateRepulsionPoints(currentBase);
        let repFactor = calculateRepulsionFromPoints(nextPos, dynamicPoints);
        if (repFactor < 0) repFactor = 0;
        if (repFactor > 0.99) repFactor = 0.99; 

        let finalDelta = prelimDelta * (1 - repFactor);
        let newBase = currentBase + finalDelta;
        
        // Hard Limits
        if(dynamicPoints.length >= 2) {
             const limitMin = dynamicPoints[0].x;
             const limitMax = dynamicPoints[dynamicPoints.length-1].x;
             if (newBase > limitMax) newBase = limitMax;
             if (newBase < limitMin) newBase = limitMin;
        }
        
        let statusText = "";
        if (dir === 'manual_B') statusText = "物理前往";
        else statusText = (baseDelta > 0 ? "增幅" : "减幅");

        return {
            newBase: newBase,
            attValue: attrForce,
            repFactor: repFactor,
            status: statusText,
            isMovingAway: isMovingAway
        };
    }

    function bvaUpdateUI() {
        document.getElementById('bva-step-indicator').innerText = `Step ${bvaState.step} / ${bvaState.maxSteps}`;
        document.getElementById('bva-current-base').innerText = bvaState.base.toFixed(PRECISION);
        
        // Fixed: Show Step Ratios in Waiting Area
        if (bvaState.ratiosDec.length > 0 && bvaState.ratiosInc.length > 0) {
            let rDec = bvaState.ratiosDec[Math.min(bvaState.step, bvaState.ratiosDec.length-1)] * 100;
            let rInc = bvaState.ratiosInc[Math.min(bvaState.step, bvaState.ratiosInc.length-1)] * 100;
            document.getElementById('bva-info-display').innerText = `步长: -${rDec.toFixed(2)}% | +${rInc.toFixed(2)}%`;
        } else {
             document.getElementById('bva-info-display').innerText = `Waiting...`;
        }

        let attrTarget = bvaState.attrMode === 'manual' ? bvaState.attrVal : bvaCalcAutoAttraction();
        document.getElementById('bva-target-display').innerText = `${attrTarget.toFixed(2)}`;

        let rawAttr = (attrTarget - bvaState.base) * bvaState.attrStr;
        let limit = bvaState.attrLimit;
        if (Math.abs(rawAttr) > limit) rawAttr = (rawAttr > 0 ? 1 : -1) * limit;
        document.getElementById('bva-disp-attr').innerText = `${rawAttr.toFixed(2)}`;
        
        if (bvaState.step < bvaState.maxSteps) {
            let predLow = calculateBvaNextStep('low');
            let predHigh = calculateBvaNextStep('high');
            document.querySelector('#btn-bva-low .bva-predict-val').innerText = `${predLow.newBase.toFixed(PRECISION)}`;
            document.querySelector('#btn-bva-high .bva-predict-val').innerText = `${predHigh.newBase.toFixed(PRECISION)}`;
            document.getElementById('bva-disp-rep-l').innerText = (predLow.repFactor*100).toFixed(0) + "%";
            document.getElementById('bva-disp-rep-r').innerText = (predHigh.repFactor*100).toFixed(0) + "%";
        } else {
            document.querySelector('#btn-bva-low .bva-predict-val').innerText = `--`;
            document.querySelector('#btn-bva-high .bva-predict-val').innerText = `--`;
            document.getElementById('bva-disp-rep-l').innerText = "--";
            document.getElementById('bva-disp-rep-r').innerText = "--";
        }
        renderRepulsionChart();
    }

    function bvaManualStep(mode) {
        let inputVal = parseFloat(document.getElementById('bva-manual-next-val').value);
        if (isNaN(inputVal)) return alert("请输入有效数值");
        bvaProcessDecision(`manual_${mode}`, inputVal);
        document.getElementById('bva-manual-next-val').value = '';
        document.getElementById('bva-manual-predict-container').innerText = '等待输入...'; 
    }

    /* ==========================================
       双向撤销/重做 逻辑
       ========================================== */
    function bvaUndo() {
        if (bvaState.step <= 0) return;
        bvaState.step--;
        if (bvaState.step === 0) {
            bvaState.base = parseFloat(document.getElementById('bva-inp-base').value);
        } else {
            bvaState.base = bvaState.history[bvaState.step - 1].newBase;
        }
        renderHistoryTable();
        bvaUpdateUI();
        updateUndoRedoButtons();
    }

    function bvaRedo() {
        if (bvaState.step >= bvaState.history.length) return;
        bvaState.base = bvaState.history[bvaState.step].newBase;
        bvaState.step++;
        renderHistoryTable();
        bvaUpdateUI();
        updateUndoRedoButtons();
    }

    function updateUndoRedoButtons() {
        const btnUndo = document.getElementById('bva-btn-undo');
        const btnRedo = document.getElementById('bva-btn-redo');
        if(btnUndo) btnUndo.disabled = (bvaState.step <= 0);
        if(btnRedo) btnRedo.disabled = (bvaState.step >= bvaState.history.length);
    }

    function bvaUpdateManualPrediction() {
        let val = parseFloat(document.getElementById('bva-manual-next-val').value);
        let container = document.getElementById('bva-manual-predict-container');
        if (isNaN(val)) { container.innerHTML = "等待输入..."; return; }
        
        let res = calculateBvaNextStep('manual_B', val);
        let repPercent = (res.repFactor * 100).toFixed(0);
        let repSource = "";
        if (res.repFactor > 0) {
            if (val < bvaState.base) repSource = `<span style="color:var(--accent-red); margin-right:5px;">[左·斥]</span>`;
            else repSource = `<span style="color:var(--accent-green); margin-right:5px;">[右·斥]</span>`;
        } else {
            repSource = `<span style="opacity:0.5; margin-right:5px;">[无排斥]</span>`;
        }
        container.innerHTML = `${repSource}<span style="font-weight:bold;">-${repPercent}%</span><span style="margin-left:5px; opacity:0.7;">→ ${res.newBase.toFixed(PRECISION)}</span>`;
    }

    function bvaProcessDecision(dir, manualValue = null) {
        if (bvaState.step >= bvaState.maxSteps) { alert("已达最大步数"); bvaShowResult(); return; }
        if (bvaState.step < bvaState.history.length) bvaState.history = bvaState.history.slice(0, bvaState.step);

        let currentBaseBefore = bvaState.base;
        let result = calculateBvaNextStep(dir, manualValue);
        bvaState.step++;
        
        let memoryAnchor = (dir === 'manual_A') ? manualValue : result.newBase;
        
        bvaState.history.push({ 
            step: bvaState.step, 
            dir: dir, 
            oldBase: currentBaseBefore,
            newBase: result.newBase,
            attValue: result.attValue,
            repFactor: result.repFactor, 
            memoryAnchor: memoryAnchor 
        });
        
        bvaState.base = result.newBase;
        
        updateUndoRedoButtons();
        renderHistoryTable();
        
        if (bvaState.step >= bvaState.maxSteps) { bvaUpdateUI(); setTimeout(bvaShowResult, 500); return; }
        bvaUpdateUI(); 

        if(dir.startsWith('manual')) {
            document.getElementById('bva-manual-next-val').value = '';
            document.getElementById('bva-manual-predict-container').innerHTML = '等待输入...';
        }
    }

    function renderHistoryTable() {
        const tbody = document.getElementById('bva-history-body');
        tbody.innerHTML = '';
        const visibleHistory = bvaState.history.slice(0, bvaState.step);
        
        [...visibleHistory].reverse().forEach(h => {
            let dirColor = h.dir.startsWith('manual') ? 'var(--accent-blue)' : (h.dir==='high'?'var(--accent-red)':'var(--accent-green)');
            let dirLabel = h.dir.startsWith('manual') ? (h.dir==='manual_A' ? 'Man(A)' : 'Man(B)') : (h.dir === 'high' ? 'High' : 'Low');
            
            let statusText = "";
            if (h.dir === 'manual_B') statusText = "物理前往";
            else if (h.dir === 'manual_A') statusText = "强制覆写";
            else statusText = (h.newBase > h.oldBase ? "增幅" : "减幅");

            let detailInfo = `<span class="status-badge ${h.dir === 'high' ? 'inc' : (h.dir === 'low' ? 'dec' : 'phy')}">${statusText}</span>`;
            if (h.dir !== 'manual_A') {
                let attSign = h.attValue >= 0 ? "+" : "";
                detailInfo += ` <span style="font-size:0.75rem; opacity:0.7; margin-left:2px;">(吸${attSign}${h.attValue.toFixed(2)} | 斥-${(h.repFactor*100).toFixed(0)}%)</span>`;
            }

            const row = `<tr>
                <td style="color:${dirColor}; font-weight:bold;">${h.step}</td>
                <td style="color:${dirColor}">${dirLabel}</td>
                <td class="selected">${h.newBase.toFixed(PRECISION)}</td>
                <td style="text-align:left; padding-left:10px;">${detailInfo}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    function bvaShowResult() {
        document.getElementById('bva-processCard').classList.add('hidden');
        document.getElementById('bva-resultCard').classList.remove('hidden');
        document.getElementById('bva-final-result').innerText = bvaState.base.toFixed(PRECISION);
        
        let finalAttr = bvaState.attrMode === 'manual' ? bvaState.attrVal : bvaCalcAutoAttraction();
        document.getElementById('bva-final-attr').innerText = finalAttr.toFixed(PRECISION);

        const effectiveHistory = bvaState.history.slice(0, bvaState.step);
        let mapHist = effectiveHistory.map(h => ({ step: h.step, dir: h.dir, newBase: h.newBase, attValue: h.attValue, repFactor: h.repFactor }));
        renderHistorySidebar(mapHist, bvaState.base, 'bva', finalAttr);
    }

    function bvaReset() {
        document.getElementById('bva-setupCard').classList.remove('hidden');
        document.getElementById('bva-processCard').classList.add('hidden');
        document.getElementById('bva-resultCard').classList.add('hidden');
    }

    function renderHistorySidebar(history, finalVal, mode, finalAttr = 0) {
        const div = document.getElementById('history-content');
        if (!history || history.length === 0) { div.innerHTML = '<p style="color:var(--text-secondary);text-align:center;">无记录</p>'; return; }
        
        let html = `<div class="history-table ${mode+'-mode'}"><table><thead><tr>`;
        if (mode === 'bva') html += `<th>步</th><th>选择/结果</th><th>详情</th></tr></thead><tbody>`;
        else html += `<th>次</th><th>L</th><th>Base</th><th>R</th></tr></thead><tbody>`;
        
        history.slice(0, 50).reverse().forEach(h => {
            if (mode === 'bva') {
                let dirText = "";
                let rowColor = "";
                if (h.dir === 'low') { dirText = "选小 (Low)"; rowColor = "var(--accent-green)"; }
                else if (h.dir === 'high') { dirText = "选大 (High)"; rowColor = "var(--accent-red)"; }
                else if (h.dir === 'manual_A') { dirText = "覆写 (ManA)"; rowColor = "var(--accent-blue)"; }
                else { dirText = "前往 (ManB)"; rowColor = "var(--accent-orange)"; }

                let attDisplay = h.attValue !== undefined ? (h.attValue > 0 ? '吸+'+h.attValue.toFixed(1) : '吸'+h.attValue.toFixed(1)) : '';
                
                html += `<tr>
                    <td style="color:${rowColor}; font-weight:bold;">${h.step}</td>
                    <td>
                        <div style="font-size:0.75rem; color:var(--text-secondary);">${dirText}</div>
                        <div style="font-weight:bold; color:var(--text-primary);">${h.newBase.toFixed(PRECISION)}</div>
                    </td>
                    <td style="font-size:0.75rem; color:var(--text-secondary);">${attDisplay}</td>
                </tr>`;
            } else {
                let clsL = (mode==='kff' && h.selection==='low') || (mode==='binary' && h.selection==='fast') ? 'selected' : '';
                let clsR = (mode==='kff' && h.selection==='high') || (mode==='binary' && h.selection==='slow') ? 'selected' : '';
                html += `<tr><td>${h.iter}</td><td class="${clsL}">${h.l.toFixed(PRECISION)}</td><td>${h.mid.toFixed(PRECISION)}</td><td class="${clsR}">${h.r.toFixed(PRECISION)}</td></tr>`;
            }
        });
        
        html += `</tbody></table><div class="final-result-row">最终结果: ${finalVal.toFixed(PRECISION)}`;
        if (mode === 'bva') {
            html += `<br><span style="font-size:0.8rem; color:var(--accent-blue);">记忆收敛点: ${finalAttr.toFixed(PRECISION)}</span>`;
        }
        html += `</div></div>`;
        div.innerHTML = html;
    }
</script>
</body>
</html>