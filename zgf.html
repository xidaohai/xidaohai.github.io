<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>西岛海 · CM360正改法</title>
    <style>
        :root {
            --primary-color: #2c5282;
            --accent-color: #3182ce;
            --text-dark: #2d3748;
            --text-light: #f7fafc;
            --background-main: #f0f4f8;
            --background-panel: #ffffff;
            --border-color: #cbd5e0;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05);
        }

        .dark-theme {
            --primary-color: #4299e1;
            --accent-color: #63b3ed;
            --text-dark: #e2e8f0;
            --text-light: #1a202c;
            --background-main: #1a202c;
            --background-panel: #2d3748;
            --border-color: #4a5568;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Inter', system-ui;
            padding: 1rem;
            background: var(--background-main);
            color: var(--text-dark);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s, color 0.3s;
        }

        .calculator-container {
            max-width: 500px;
            margin: 1rem auto;
            padding: 2rem;
            background: var(--background-panel);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .input-group {
            margin: 1.2rem 0;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #718096;
            font-size: 0.95rem;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--background-panel);
            color: var(--text-dark);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.6rem;
            margin: 1rem 0;
        }

        button {
            padding: 0.7rem;
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        button:hover {
            background: var(--accent-color);
            transform: translateY(-1px);
        }

        .result-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--background-main);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        /* 新增历史记录样式 */
        .history-item {
            padding: 0.5rem;
            margin: 0.2rem 0;
            background: var(--background-main);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: var(--accent-color);
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 1.8rem;">
            西岛海 · CM360正改法
        </h2>

        <div class="formula-display" style="margin: 1.5rem 0; padding: 1rem; background: var(--background-main); border-radius: 8px; font-family: monospace; color: var(--accent-color); font-size: 1.1em; text-align: center; border: 1px solid var(--border-color);"id="formulaDisplay">
            新值 = ( 旧值 × 360°) ÷ ( 360°+ Δ值 ) or 比例 × 旧值
        </div>

        <!-- 标准算法 -->
        <div class="input-group">
            <label>旧值（cm/360°）【一般在20-80之间】</label>
            <input type="number" id="oldValue" step="0.1" value="40" oninput="calculate()">
        </div>

        <div class="input-group">
            <label>Δ调整量（360°± Δ°）</label>
            <div class="preset-buttons">
                <button onclick="adjustDelta(0.25)">+0.25°</button>
                <button onclick="adjustDelta(1)">+1°</button>
                <button onclick="adjustDelta(10)">+10°</button>
                <button onclick="adjustDelta(-0.25)">-0.25°</button>
                <button onclick="adjustDelta(-1)">-1°</button>
                <button onclick="adjustDelta(-10)">-10°</button>
            </div>
            <input type="number" id="deltaValue" step="0.25" value="0" 
                   oninput="validateDelta()" placeholder="输入调整度数">
        </div>

        <div class="result-box">
            <div style="color: #718096;">新灵敏度值</div>
            <div style="font-size: 2rem; color: var(--primary-color); margin: 1rem 0;">
                <span id="newValue">40.00</span> cm/360°
            </div>
        </div>

        <!-- 手腕参数 -->
        <div class="input-group">
            <label>鼠标距离&对应角度（一般手腕摆动一次5cm）</label>
            <div class="preset-buttons">
                <button onclick="adjustWrist(5, 45)">45°</button>
                <button onclick="adjustWrist(5, 90)">90°</button>
                <button onclick="adjustWrist(5, 180)">180°</button>
            </div>
            <div style="display: flex; gap: 1rem;">
                <input type="number" id="wristDistance" step="0.1" value="5" oninput="calculateFromWrist()" placeholder="移动距离">
                <input type="number" id="wristAngle" step="1" value="180" oninput="calculateFromWrist()" placeholder="对应角度">
            </div>
        </div>

        <!-- 目标参数 -->
        <div class="input-group">
            <label>目标角度&鼠标距离（一般近目标身体大小3.6°、中远1°。）</label>
            <div style="display: flex; gap: 1rem;">
                <input type="number" id="targetAngle" step="0.1" value="3.6" oninput="calculateFromTarget()" placeholder="目标角度">
                <input type="number" id="targetDistance" step="0.01" value="0.4" oninput="calculateFromTarget()" placeholder="对应距离">
            </div>
        </div>

                <!-- 新增历史记录区域 -->
                <div class="input-group">
                    <label>历史记录（点击恢复）</label>
                    <div id="historyList" class="result-box" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
    </div>

    <script>
        let historyRecords = [];
    
        // 历史记录显示更新
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = historyRecords.map((record, index) => `
                <div class="history-item" onclick="loadHistory(${index})">
                    [${record.time}] ${record.oldValue.toFixed(2)}cm → ${record.newValue.toFixed(2)}cm (Δ${record.delta}°)
                </div>
            `).join('');
        }
    
        // 加载历史记录
        function loadHistory(index) {
            const record = historyRecords[index];
            if (!record) return;
    
            // 恢复所有参数
            document.getElementById('oldValue').value = record.oldValue;
            document.getElementById('deltaValue').value = record.delta;
            document.getElementById('wristDistance').value = record.wristDistance;
            document.getElementById('wristAngle').value = record.wristAngle;
            document.getElementById('targetAngle').value = record.targetAngle;
            document.getElementById('targetDistance').value = record.targetDistance;
            
            calculate(); // 触发重新计算
        }
    
        // 输入验证
        function validateDelta() {
            const deltaInput = document.getElementById('deltaValue');
            let value = parseFloat(deltaInput.value) || 0;
            
            if (value <= -360) {
                value = -359.9;
                alert("调整量不能小于-359.9°");
            }
            if (value >= 360) {
                value = 359.9;
                alert("调整量不能超过359.9°");
            }
            
            deltaInput.value = value.toFixed(2);
            calculate();
        }
    
        // 调整量快捷操作
        function adjustDelta(value) {
            const deltaInput = document.getElementById('deltaValue');
            deltaInput.value = (parseFloat(deltaInput.value) || 0) + value;
            validateDelta();
        }
    
        // 手腕参数快捷预设
        function adjustWrist(distance, angle) {
            document.getElementById('wristDistance').value = distance;
            document.getElementById('wristAngle').value = angle;
            calculateFromWrist();
        }
    
        // 根据手腕参数计算（修改点1/3）
        function calculateFromWrist() {
            const distance = parseFloat(document.getElementById('wristDistance').value);
            const angle = parseFloat(document.getElementById('wristAngle').value);
            
            if(distance > 0 && angle > 0) {
                const newCM = (distance * 360) / angle;
                document.getElementById('oldValue').value = newCM.toFixed(2);
                calculate(); // 触发完整计算链
            }
        }
    
        // 根据目标参数计算（修改点2/3）
        function calculateFromTarget() {
            const angle = parseFloat(document.getElementById('targetAngle').value);
            const distance = parseFloat(document.getElementById('targetDistance').value);
            
            if(angle > 0 && distance > 0) {
                const newCM = (distance * 360) / angle;
                document.getElementById('oldValue').value = newCM.toFixed(2);
                calculate(); // 触发完整计算链
            }
        }
    
        // 主计算函数（修改点3/3）
        function calculate() {
            // 获取输入值
            const oldValue = parseFloat(document.getElementById('oldValue').value);
            const delta = parseFloat(document.getElementById('deltaValue').value);
            
            if(isNaN(oldValue) || isNaN(delta)) return;
            
            // 计算新灵敏度值
            const newValue = (oldValue * 360) / (360 + delta);
            document.getElementById('newValue').textContent = newValue.toFixed(2);
    
            /* 同步更新其他参数 */
            // 同步手腕参数（使用新值计算）
            const wristDistance = parseFloat(document.getElementById('wristDistance').value);
            if (!isNaN(wristDistance) && wristDistance > 0) {
                const calculatedAngle = (wristDistance * 360) / newValue; // 关键修改
                document.getElementById('wristAngle').value = calculatedAngle.toFixed(1);
            }
    
            // 同步目标参数
            const targetAngle = parseFloat(document.getElementById('targetAngle').value);
            document.getElementById('targetDistance').value = (newValue * targetAngle / 360).toFixed(2);
    
            // 记录历史
            const historyItem = {
                time: new Date().toLocaleTimeString(),
                oldValue: oldValue,
                delta: delta.toFixed(2),
                newValue: newValue,
                wristDistance: wristDistance || parseFloat(document.getElementById('wristDistance').value),
                wristAngle: parseFloat(document.getElementById('wristAngle').value) || 0,
                targetAngle: targetAngle || 0,
                targetDistance: parseFloat(document.getElementById('targetDistance').value) || 0
            };
            
            // 保存最新10条记录
            historyRecords.unshift(historyItem);
            if (historyRecords.length > 10) historyRecords.pop();
            updateHistoryDisplay();
        }
    
        // 初始化计算
        calculate();
    </script>
</body>
</html>