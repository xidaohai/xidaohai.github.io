<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLM·蛋白质与B12需求计算器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f4f7f6 0%, #e0e7ff 100%);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            gap: 20px;
            padding: 20px;
            flex-wrap: wrap; /* 允许在小屏幕上换行 */
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
            transition: transform 0.3s ease;
        }
        .container:hover {
            transform: translateY(-5px);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #3498db, #2c3e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            text-align: center;
            color: #3498db;
            font-size: 20px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 15px;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #3498db;
            outline: none;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, #3498db, #2980b9);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(to right, #e8f5e9, #c8e6c9);
            color: #2e7d32;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            display: none;
            border-left: 5px solid #2e7d32;
        }
        .note {
            margin-top: 20px;
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
            line-height: 1.6;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        .info-panel {
            background: linear-gradient(to bottom, #ecf0f1, #dfe6e9);
            padding: 25px;
            border-radius: 12px;
            max-width: 350px;
            box-sizing: border-box;
            margin-top: 20px;
            border: 1px solid #dde1e4;
        }
        .info-panel h3 {
            font-size: 18px;
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        .info-panel p {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .divider {
            border-top: 2px dashed #ccc;
            margin: 30px 0;
        }
        .b12-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 10px;
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: #555;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #3498db;
            color: #fff;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
                align-items: center;
            }
            .container {
                max-width: 100%;
                padding: 20px;
            }
            .container:first-of-type {
                margin-bottom: 0;
            }
        }
        .editable {
            background-color: #fff !important;
            border: 2px solid #3498db !important;
        }
        .bmi-table th {
            background-color: #2c3e50;
        }
        .energy-table th {
            background-color: #9b59b6;
        }
        .calorie-table th {
            background-color: #fbc02d;
        }
        .b12-table th {
            background-color: #6174a7;
        }
        
        /* 浮动按钮和弹窗样式 */
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1.2;
            text-align: center;
            white-space: normal;
        }
        .floating-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding-top: 60px;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            border-radius: 15px;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideIn 0.4s ease-out;
            line-height: 1.8;
            font-size: 16px;
            white-space: pre-wrap; /* Preserve line breaks and spaces */
            word-wrap: break-word; /* Wrap long words */
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-content h3, .modal-content p {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .modal-content h3 {
            font-size: 22px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h3>七大基本营养素</h3>
    <hr>
    <table>
        <thead>
            <tr>
                <th>存活阶段</th>
                <th>营养素，存活重要性左右为高低</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>短期存活【基本不缺】</td>
                <td>水、碳水化合物</td>
            </tr>
            <tr>
                <td>中期存活【有可能缺】</td>
                <td>蛋白质</td>
            </tr>
            <tr>
                <td>长期存活【很可能缺】</td>
                <td>脂肪、矿物质、维生素、膳食纤维</td>
            </tr>
        </tbody>
    </table>

    <div class="info-panel">
        <h3>重量参考</h3>
        <p>• 一碗米饭: 200g</p>
        <p>• 一个苹果或西红柿或香蕉: 150g</p>
        <p>• 一个泡面面饼或馒头或一把叶菜: 100g</p>
        <p>• 一个鸡蛋: 50g</p>
        <p>• 一小把坚果: 20g</p>
        <h3>快餐平均营养数据</h3>
        <table class="fast-food-table">
            <thead>
                <tr>
                    <th>食物类型</th>
                    <th>平均重量</th>
                    <th>千卡</th>
                    <th>蛋白质（克）</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>汉堡</td>
                    <td>180克</td>
                    <td>475</td>
                    <td>21.5</td>
                </tr>
                <tr>
                    <td>大份薯条</td>
                    <td>140克</td>
                    <td>475</td>
                    <td>6</td>
                </tr>
                <tr>
                    <td>6块麦乐鸡块</td>
                    <td>100克</td>
                    <td>300</td>
                    <td>17.5</td>
                </tr>
                <tr>
                    <td>派或蛋挞</td>
                    <td>80克</td>
                    <td>225</td>
                    <td>5</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="divider"></div>
    <h3>BMI计算器</h3>
    <hr>
    <div class="input-group">
        <label for="heightCm">身高（厘米）</label>
        <input type="number" id="heightCm" placeholder="例如：175" min="0">
    </div>
    <div class="input-group">
        <label for="weightKg">体重（斤）</label>
        <input type="number" id="weightKg" placeholder="例如：130" min="0">
    </div>
    <button id="calculateBmiBtn">计算BMI</button>
    <div class="result" id="bmiResultDiv"></div>
    <div class="info-panel">
        <h3>BMI标准表（中国）</h3>
        <table class="bmi-table">
            <thead>
                <tr>
                    <th>BMI值</th>
                    <th>档位</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>小于 18.5</td>
                    <td>偏瘦</td>
                </tr>
                <tr>
                    <td>18.5 - 23.9</td>
                    <td>正常</td>
                </tr>
                <tr>
                    <td>24 - 27.9</td>
                    <td>超重</td>
                </tr>
                <tr>
                    <td>大于等于 28</td>
                    <td>肥胖</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="container">
    <h1>每日能量需求计算器</h1>
    <hr>
    <div class="input-group">
        <label for="gender">性别</label>
        <select id="gender">
            <option value="male" selected>男</option>
            <option value="female">女</option>
        </select>
    </div>
    <div class="input-group">
        <label for="age">年龄（岁）</label>
        <input type="number" id="age" placeholder="例如：30" min="0">
    </div>
    <div class="input-group">
        <label for="energyHeightCm">身高（厘米）</label>
        <input type="number" id="energyHeightCm" placeholder="例如：175" min="0">
    </div>
    <div class="input-group">
        <label for="energyWeightKg">体重（斤）</label>
        <input type="number" id="energyWeightKg" placeholder="例如：130" min="0">
    </div>
    <div class="input-group">
        <label for="activityLevel">运动频率</label>
        <select id="activityLevel">
            <option value="1.2" selected>久坐不动（办公室工作）</option>
            <option value="1.375">少量运动（每周1-3天）</option>
            <option value="1.55">中等强度运动（每周3-5天）</option>
            <option value="1.725">高强度运动（每周6-7天）</option>
            <option value="1.9">非常高强度运动（每天训练）</option>
        </select>
    </div>
    <button id="calculateEnergyBtn">计算</button>
    <div class="result" id="energyResultDiv"></div>
    <div class="info-panel">
        <h3>活动量乘数表</h3>
        <table class="energy-table">
            <thead>
                <tr>
                    <th>活动量</th>
                    <th>乘数</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>久坐不动</td><td>1.2</td></tr>
                <tr><td>少量运动</td><td>1.375</td></tr>
                <tr><td>中等强度</td><td>1.55</td></tr>
                <tr><td>高强度</td><td>1.725</td></tr>
                <tr><td>非常高强度</td><td>1.9</td></tr>
            </tbody>
        </table>
        <p style="margin-top: 15px;">** 基础代谢率 (BMR) 是维持生命所需的基本能量，即静止状态下消耗的卡路里。总能量消耗 (TDEE) 是BMR加上日常活动所需的总能量。</p>
    </div>
</div>

<div class="container">
    <h1>豆粉需求计算器</h1>
    <h2>主计算器</h2>
    <div class="input-group">
        <label for="weight">体重（斤）</label>
        <input type="number" id="weight" placeholder="例如：120" min="0">
    </div>
    <div class="input-group">
        <label for="proteinStandard">每日蛋白质标准</label>
        <select id="proteinStandard">
            <option value="0.6">0.6 克/公斤（最低需求）</option>
            <option value="0.66" selected>0.66 克/公斤（平均需求EAR）</option>
            <option value="0.8">0.8 克/公斤（推荐摄入RDA）</option>
            <option value="1.0">1.0 克/公斤（健身人群）</option>
            <option value="1.2">1.2 克/公斤（运动员）</option>
        </select>
    </div>
    <div class="input-group">
        <label for="totalFood">总食物量（克）</label>
        <input type="number" id="totalFood" value="625" min="0">
    </div>
    <div class="input-group">
        <label for="foodProteinRatio">食物蛋白质比例（%）</label>
        <input type="number" id="foodProteinRatio" value="4.625" placeholder="例如：4.625" min="0" max="100" step="0.01" class="editable">
    </div>
    <button id="calculateProteinBtn">计算</button>
    <div class="result" id="proteinResultDiv"></div>
    
    <div class="divider"></div>
    <h2>摄入估算</h2>
    <div class="input-group">
        <label for="mealsPerDay">每日吃多少顿</label>
        <input type="number" id="mealsPerDay" value="2.5" min="1" max="10" step="0.5">
    </div>
    <div class="input-group">
        <label for="mealSize">每顿食量（克）</label>
        <input type="number" id="mealSize" value="250" min="0" step="10">
    </div>
    <div class="input-group">
        <label for="mainFood">主食类型</label>
        <select id="mainFood">
            <option value="no_main_food">没有主食 (0%蛋白质)</option>
            <option value="rice" selected>米饭 (2.5%蛋白质)</option>
            <option value="pasta">面食 (8%蛋白质)</option>
            <option value="oats">燕麦 (13%蛋白质)</option>
        </select>
    </div>
    <div class="input-group">
        <label for="sideDish">配菜类型</label>
        <select id="sideDish">
            <option value="no_side_dish">没有配菜 (0%蛋白质)</option>
            <option value="vegetarian_no_soy" selected>不含豆制品的素菜 (2%蛋白质)</option>
            <option value="vegetarian_soy">含一半豆制品的素菜 (6%蛋白质)</option>
            <option value="meat">肉菜 (15%蛋白质)</option>
            <option value="high_protein">高蛋白食物 (25%蛋白质)</option>
        </select>
    </div>
    <div class="input-group">
        <label for="foodRatio">主食/配菜比例</label>
        <select id="foodRatio">
            <option value="100/0">100%主食 / 0%配菜</option>
            <option value="0/100">0%主食 / 100%配菜</option>
            <option value="90/10">90%主食 / 10%配菜</option>
            <option value="75/25">75%主食 / 25%配菜</option>
            <option value="50/50" selected>50%主食 / 50%配菜</option>
            <option value="25/75">25%主食 / 75%配菜</option>
            <option value="10/90">10%主食 / 90%配菜</option>
        </select>
    </div>
    <button id="applyEstimatesBtn">应用估算值并计算出千卡值</button>
    <div class="result" id="calorieResultDiv"></div>
    <div class="info-panel">
        <h3>各类型食物卡路里（千卡/100克）</h3>
        <table class="calorie-table">
            <thead>
                <tr>
                    <th>食物类型</th>
                    <th>卡路里值</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>米饭类主食</td><td>~130</td></tr>
                <tr><td>面食类主食</td><td>~158</td></tr>
                <tr><td>燕麦类主食</td><td>~68</td></tr>
                <tr><td>不含豆制品的素菜</td><td>~30</td></tr>
                <tr><td>含一半豆制品的素菜</td><td>~120</td></tr>
                <tr><td>肉菜</td><td>~250</td></tr>
                <tr><td>高蛋白食物</td><td>~200</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="container">
    <h1>B12需求计算（慎）</h1>
    <hr>
    <div class="input-group">
        <label for="b12Standard">每日B12标准（微克）</label>
        <select id="b12Standard">
            <option value="0.4">0.4 微克（婴幼儿 0-6个月）</option>
            <option value="0.5">0.5 微克（婴幼儿 7-12个月）</option>
            <option value="0.9">0.9 微克（儿童 1-3岁）</option>
            <option value="1.2">1.2 微克（儿童 4-8岁）</option>
            <option value="1.8">1.8 微克（青少年 9-13岁）</option>
            <option value="2.4" selected>2.4 微克（青少年 14-18岁及成年人）</option>
            <option value="2.6">2.6 微克（孕妇）</option>
            <option value="2.8">2.8 微克（哺乳期）</option>
        </select>
    </div>
    <div class="input-group">
        <label for="b12Intake">每日B12食物摄入量（微克）</label>
        <input type="number" id="b12Intake" value="0" readonly>
    </div>
    <button id="calculateB12Btn">计算B12需求</button>
    <div class="result" id="b12ResultDiv"></div>
    <div class="b12-details" id="b12DetailsDiv">
        <p>若通过以下食物补充，则每日需额外摄入：</p>
        <ul style="list-style-type: none; padding: 0;">
            <li id="b12FermentedBeanCurdResult"></li>
            <li id="b12MilkResult"></li>
            <li id="b12SupplementResult"></li>
        </ul>
    </div>
    <div class="note">
        <p><strong>注意：</strong>此计算基于豆粉蛋白质含量40%，且B12含量几乎为零。</p>
        <p>青腐乳（某致和臭豆腐）的B12含量因发酵工艺差异大，这里以约<strong>15微克/100克</strong>估算，仅供参考。</p>
        <p>牛奶含量以约<strong>0.45微克/100克</strong>估算。</p>
    </div>
    <div class="divider"></div>
    <h2>卡路里摄入反推</h2>
    <div class="input-group">
        <label for="totalCalories">每日总摄入卡路里（千卡）</label>
        <input type="number" id="totalCalories" placeholder="例如：2000" min="0">
    </div>
    <div class="input-group">
        <label for="reverseMealsPerDay">每日吃多少顿</label>
        <input type="number" id="reverseMealsPerDay" value="2.5" min="1" max="10" step="0.5">
    </div>
    <div class="input-group">
        <label for="reverseMainFood">主食类型</label>
        <select id="reverseMainFood">
            <option value="no_main_food">没有主食 (0%蛋白质)</option>
            <option value="rice" selected>米饭 (2.5%蛋白质)</option>
            <option value="pasta">面食 (8%蛋白质)</option>
            <option value="oats">燕麦 (13%蛋白质)</option>
        </select>
    </div>
    <div class="input-group">
        <label for="reverseSideDish">配菜类型</label>
        <select id="reverseSideDish">
            <option value="no_side_dish">没有配菜 (0%蛋白质)</option>
            <option value="vegetarian_no_soy" selected>不含豆制品的素菜 (2%蛋白质)</option>
            <option value="vegetarian_soy">含一半豆制品的素菜 (6%蛋白质)</option>
            <option value="meat">肉菜 (15%蛋白质)</option>
            <option value="high_protein">高蛋白食物 (25%蛋白质)</option>
        </select>
    </div>
    <div class="input-group">
        <label for="reverseFoodRatio">主食/配菜比例</label>
        <select id="reverseFoodRatio">
            <option value="100/0">100%主食 / 0%配菜</option>
            <option value="0/100">0%主食 / 100%配菜</option>
            <option value="90/10">90%主食 / 10%配菜</option>
            <option value="75/25">75%主食 / 25%配菜</option>
            <option value="50/50" selected>50%主食 / 50%配菜</option>
            <option value="25/75">25%主食 / 75%配菜</option>
            <option value="10/90">10%主食 / 90%配菜</option>
        </select>
    </div>
    <button id="calculateReverseBtn">反推每顿食量</button>
    <div class="result" id="reverseCalorieResultDiv"></div>
</div>

<button id="floating-btn" class="floating-btn">笔记</button>

<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <pre id="modal-text"></pre>
    </div>
</div>

<script>
    // 使用 IIFE (立即调用函数表达式) 创建一个独立的、安全的作用域
    // 这可以防止变量污染全局空间，是构建健壮模块的基石
    (function() {
        // 1. CONFIGURATION: 存放所有固定不变的配置和“魔数”
        const CONFIG = {
            proteinRatios: {
                no_main_food: 0, rice: 0.025, pasta: 0.08, oats: 0.13,
                no_side_dish: 0, vegetarian_no_soy: 0.02, vegetarian_soy: 0.06,
                meat: 0.15, high_protein: 0.25, soyPowder: 0.4,
            },
            caloriesPerGram: {
                no_main_food: 0, rice: 1.3, pasta: 1.58, oats: 0.68,
                no_side_dish: 0, vegetarian_no_soy: 0.3, vegetarian_soy: 1.2,
                meat: 2.5, high_protein: 2.0,
            },
            b12Contents: {
                meatPerGram: 0.015, fermentedBeanCurdPer100g: 15,
                milkPer100g: 0.45, supplementPerPill: 10,
            },
            assumptions: {
                fermentedBeanCurdPieceWeight: 15, milkCupWeight: 250,
            }
        };

        // 2. DOM ELEMENTS: 集中管理所有 DOM 元素的引用
        const DOM = {
            // 主计算器
            weight: document.getElementById('weight'),
            proteinStandard: document.getElementById('proteinStandard'),
            totalFood: document.getElementById('totalFood'),
            foodProteinRatio: document.getElementById('foodProteinRatio'),
            calculateProteinBtn: document.getElementById('calculateProteinBtn'),
            proteinResultDiv: document.getElementById('proteinResultDiv'),
            // B12 计算器
            b12Standard: document.getElementById('b12Standard'),
            b12Intake: document.getElementById('b12Intake'),
            calculateB12Btn: document.getElementById('calculateB12Btn'),
            b12ResultDiv: document.getElementById('b12ResultDiv'),
            b12DetailsDiv: document.getElementById('b12DetailsDiv'),
            b12FermentedBeanCurdResult: document.getElementById('b12FermentedBeanCurdResult'),
            b12MilkResult: document.getElementById('b12MilkResult'),
            b12SupplementResult: document.getElementById('b12SupplementResult'),
            // 估算器
            mealsPerDay: document.getElementById('mealsPerDay'),
            mealSize: document.getElementById('mealSize'),
            mainFood: document.getElementById('mainFood'),
            sideDish: document.getElementById('sideDish'),
            foodRatio: document.getElementById('foodRatio'),
            applyEstimatesBtn: document.getElementById('applyEstimatesBtn'),
            // 新增的卡路里结果
            calorieResultDiv: document.getElementById('calorieResultDiv'),
            // BMI 计算器
            heightCm: document.getElementById('heightCm'),
            weightKg: document.getElementById('weightKg'),
            calculateBmiBtn: document.getElementById('calculateBmiBtn'),
            bmiResultDiv: document.getElementById('bmiResultDiv'),
            // 能量计算器
            gender: document.getElementById('gender'),
            age: document.getElementById('age'),
            energyHeightCm: document.getElementById('energyHeightCm'),
            energyWeightKg: document.getElementById('energyWeightKg'),
            activityLevel: document.getElementById('activityLevel'),
            calculateEnergyBtn: document.getElementById('calculateEnergyBtn'),
            energyResultDiv: document.getElementById('energyResultDiv'),
            // 新增：反向估算器
            totalCalories: document.getElementById('totalCalories'),
            reverseMealsPerDay: document.getElementById('reverseMealsPerDay'),
            reverseMainFood: document.getElementById('reverseMainFood'),
            reverseSideDish: document.getElementById('reverseSideDish'),
            reverseFoodRatio: document.getElementById('reverseFoodRatio'),
            calculateReverseBtn: document.getElementById('calculateReverseBtn'),
            reverseCalorieResultDiv: document.getElementById('reverseCalorieResultDiv'),
            // 弹窗相关
            floatingBtn: document.getElementById('floating-btn'),
            modal: document.getElementById('myModal'),
            closeBtn: document.getElementsByClassName("close-btn")[0],
            modalText: document.getElementById("modal-text")
        };

        // 3. STATE: 应用程序的唯一数据源 (Single Source of Truth)
        // 界面上的一切都应是这个 state 对象的反映
        const state = {
            // 输入值
            weight: 0, proteinStandard: 0, totalFood: 0, foodProteinRatio: 4.625, b12Standard: 0, sideDish: '', mealsPerDay: 0, mealSize: 0, mainFood: '', foodRatio: '', heightCm: 0, weightKg: 0, gender: '', age: 0, energyHeightCm: 0, energyWeightKg: 0, activityLevel: 0,
            // 新增：反向估算输入
            totalCalories: 0, reverseMealsPerDay: 0, reverseMainFood: '', reverseSideDish: '', reverseFoodRatio: '',
            // 计算结果
            protein: { required: 0, fromFood: 0, deficit: 0, soyPowderNeeded: 0, showResult: false },
            b12: { intake: 0, deficit: 0, showResult: false, curdNeeded: 0, milkNeeded: 0, pillsNeeded: 0 },
            bmi: { value: 0, category: '', showResult: false },
            energy: { bmr: 0, tdee: 0, showResult: false },
            calories: { value: 0, showResult: false },
            // 新增：反向估算结果
            reverse: { totalFood: 0, mealSize: 0, showResult: false }
        };

        // 4. LOGIC: 纯粹的计算函数，不直接操作 DOM
        const Logic = {
            // 从估算器计算平均蛋白质比例
            calculateAverageProteinRatio: () => {
                const mainFoodRatio = CONFIG.proteinRatios[state.mainFood] || 0;
                const sideDishRatio = CONFIG.proteinRatios[state.sideDish] || 0;
                const [mainFoodPercent, sideDishPercent] = state.foodRatio.split('/').map(p => parseFloat(p) / 100);
                const totalFoodInGrams = state.mealsPerDay * state.mealSize;
                const totalProtein = (totalFoodInGrams * mainFoodPercent * mainFoodRatio) + (totalFoodInGrams * sideDishPercent * sideDishRatio);
                state.totalFood = totalFoodInGrams;
                state.foodProteinRatio = totalFoodInGrams > 0 ? (totalProtein / totalFoodInGrams) * 100 : 0;
            },
            // 从估算器计算总卡路里
            calculateTotalCalories: () => {
                const mainFoodCalories = CONFIG.caloriesPerGram[state.mainFood] || 0;
                const sideDishCalories = CONFIG.caloriesPerGram[state.sideDish] || 0;
                const [mainFoodPercent, sideDishPercent] = state.foodRatio.split('/').map(p => parseFloat(p) / 100);
                const totalFoodInGrams = state.mealsPerDay * state.mealSize;
                const totalCalories = (totalFoodInGrams * mainFoodPercent * mainFoodCalories) + (totalFoodInGrams * sideDishPercent * sideDishCalories);
                state.calories.value = totalCalories;
            },
            // 计算B12摄入
            calculateB12Intake: () => {
                const [mainFoodPercent, sideDishPercent] = state.foodRatio.split('/').map(p => parseFloat(p) / 100);
                const totalFoodInGrams = state.mealsPerDay * state.mealSize;
                if (state.sideDish === 'meat' && totalFoodInGrams > 0) {
                    state.b12.intake = (totalFoodInGrams * sideDishPercent) * CONFIG.b12Contents.meatPerGram;
                } else {
                    state.b12.intake = 0;
                }
            },
            // 执行蛋白质需求的核心计算
            runProteinCalculation: () => {
                const weightKg = state.weight / 2;
                state.protein.required = weightKg * state.proteinStandard;
                state.protein.fromFood = state.totalFood * (state.foodProteinRatio / 100);
                state.protein.deficit = state.protein.required - state.protein.fromFood;
                state.protein.soyPowderNeeded = state.protein.deficit > 0 ? state.protein.deficit / CONFIG.proteinRatios.soyPowder : 0;
            },
            // 执行B12需求的核心计算
            runB12Calculation: () => {
                state.b12.deficit = state.b12Standard - state.b12.intake;
                if (state.b12.deficit > 0) {
                    const deficit = state.b12.deficit;
                    state.b12.curdNeeded = (deficit / CONFIG.b12Contents.fermentedBeanCurdPer100g) * 100;
                    state.b12.milkNeeded = (deficit / CONFIG.b12Contents.milkPer100g) * 100;
                    state.b12.pillsNeeded = deficit / CONFIG.b12Contents.supplementPerPill;
                }
            },
            // 执行BMI的核心计算
            runBmiCalculation: () => {
                const heightM = state.heightCm / 100;
                const weightKg = state.weightKg / 2;
                if (heightM === 0 || weightKg === 0) {
                    state.bmi.value = 0;
                } else {
                    state.bmi.value = weightKg / (heightM * heightM);
                }
                if (state.bmi.value < 18.5) {
                    state.bmi.category = '偏瘦';
                } else if (state.bmi.value >= 18.5 && state.bmi.value < 24) {
                    state.bmi.category = '正常';
                } else if (state.bmi.value >= 24 && state.bmi.value < 28) {
                    state.bmi.category = '超重';
                } else {
                    state.bmi.category = '肥胖';
                }
            },
            // 执行能量需求的核心计算 (Mifflin-St Jeor equation)
            runEnergyCalculation: () => {
                let bmr = 0;
                const energyWeightKg = state.energyWeightKg / 2; // 体重转公斤
                if (state.gender === 'male') {
                    bmr = (10 * energyWeightKg) + (6.25 * state.energyHeightCm) - (5 * state.age) + 5;
                } else {
                    bmr = (10 * energyWeightKg) + (6.25 * state.energyHeightCm) - (5 * state.age) - 161;
                }
                state.energy.bmr = bmr;
                state.energy.tdee = bmr * state.activityLevel;
            },
            // 新增：反向推导总食物量和每顿食量
            reverseCalculate: () => {
                const mainFoodCalories = CONFIG.caloriesPerGram[state.reverseMainFood] || 0;
                const sideDishCalories = CONFIG.caloriesPerGram[state.reverseSideDish] || 0;
                const [mainFoodPercent, sideDishPercent] = state.reverseFoodRatio.split('/').map(p => parseFloat(p) / 100);
                
                // 计算每克食物的平均卡路里
                const averageCaloriesPerGram = (mainFoodPercent * mainFoodCalories) + (sideDishPercent * sideDishCalories);
                
                if (averageCaloriesPerGram > 0) {
                    state.reverse.totalFood = state.totalCalories / averageCaloriesPerGram;
                } else {
                    state.reverse.totalFood = 0;
                }
                
                // 计算每顿食量
                if (state.reverseMealsPerDay > 0) {
                    state.reverse.mealSize = state.reverse.totalFood / state.reverseMealsPerDay;
                } else {
                    state.reverse.mealSize = 0;
                }
            }
        };

        // 5. RENDER: 渲染函数，根据 state 更新界面
        const Render = {
            // 更新所有输入框的值，确保与 state 同步
            inputs: () => {
                DOM.totalFood.value = state.totalFood;
                DOM.foodProteinRatio.value = state.foodProteinRatio.toFixed(3);
                DOM.foodProteinRatio.readOnly = false;
                DOM.foodProteinRatio.classList.add('editable');
                DOM.b12Intake.value = state.b12.intake.toFixed(2);
            },
            // 渲染蛋白质计算结果
            proteinResult: () => {
                if (!state.protein.showResult) {
                    DOM.proteinResultDiv.style.display = 'none';
                    return;
                }
                const div = DOM.proteinResultDiv;
                div.style.display = 'block';
                if (state.protein.deficit <= 0) {
                    div.textContent = `您每日多摄入约 ${(-state.protein.deficit).toFixed(2)} 克蛋白质。`;
                    div.style.background = "linear-gradient(to right, #e8f5e9, #c8e6c9)";
                    div.style.color = "#2e7d32";
                } else {
                    const powderNeeded = state.protein.soyPowderNeeded.toFixed(2);
                    div.innerHTML = `每日蛋白质缺口：<strong>${state.protein.deficit.toFixed(2)} 克</strong>。<br>需要额外摄入约 <strong>${powderNeeded} 克</strong> 豆粉。`;
                    div.style.background = "linear-gradient(to right, #ffebee, #ffcdd2)";
                    div.style.color = "#c62828";
                }
            },
            // 渲染B12计算结果
            b12Result: () => {
                if (!state.b12.showResult) {
                    DOM.b12ResultDiv.style.display = 'none';
                    DOM.b12DetailsDiv.style.display = 'none';
                    return;
                }
                DOM.b12ResultDiv.style.display = 'block';
                DOM.b12DetailsDiv.style.display = 'block';
                
                if (state.b12.deficit <= 0) {
                    DOM.b12ResultDiv.textContent = `您每日B12摄入量已达标，多摄入约 ${(-state.b12.deficit).toFixed(2)} 微克。`;
                    DOM.b12ResultDiv.style.background = "linear-gradient(to right, #e8f5e9, #c8e6c9)";
                    div.style.color = "#2e7d32";
                    DOM.b12DetailsDiv.style.display = 'none';
                } else {
                    DOM.b12ResultDiv.innerHTML = `每日B12缺口：<strong>${state.b12.deficit.toFixed(2)} 微克</strong>。`;
                    DOM.b12ResultDiv.style.background = "linear-gradient(to right, #ffebee, #ffcdd2)";
                    DOM.b12ResultDiv.style.color = "#c62828";
                    
                    DOM.b12FermentedBeanCurdResult.textContent = `• 约 ${(state.b12.curdNeeded / CONFIG.assumptions.fermentedBeanCurdPieceWeight).toFixed(1)} 块青腐乳`;
                    DOM.b12MilkResult.textContent = `• 约 ${(state.b12.milkNeeded / CONFIG.assumptions.milkCupWeight).toFixed(1)} 杯牛奶`;
                    DOM.b12SupplementResult.textContent = `• 约 ${state.b12.pillsNeeded.toFixed(1)} 粒B12补充剂胶囊`;
                }
            },
            // 渲染BMI计算结果
            bmiResult: () => {
                if (!state.bmi.showResult) {
                    DOM.bmiResultDiv.style.display = 'none';
                    return;
                }
                const div = DOM.bmiResultDiv;
                div.style.display = 'block';
                div.innerHTML = `您的BMI值为：<strong>${state.bmi.value.toFixed(2)}</strong>。<br>属于：<strong>${state.bmi.category}</strong>。`;
            },
            // 渲染能量计算结果
            energyResult: () => {
                if (!state.energy.showResult) {
                    DOM.energyResultDiv.style.display = 'none';
                    return;
                }
                const div = DOM.energyResultDiv;
                div.style.display = 'block';
                div.innerHTML = `您的基础代谢率 (BMR) 为：<strong>${state.energy.bmr.toFixed(0)} 千卡/天</strong>。<br>您的每日总能量消耗 (TDEE) 为：<strong>${state.energy.tdee.toFixed(0)} 千卡/天</strong>。`;
            },
            // 渲染摄入估算结果 (新增)
            calorieResult: () => {
                if (!state.calories.showResult) {
                    DOM.calorieResultDiv.style.display = 'none';
                    return;
                }
                const div = DOM.calorieResultDiv;
                div.style.display = 'block';
                div.innerHTML = `按此估算，每日摄入总卡路里约为 <strong>${state.calories.value.toFixed(0)} 千卡</strong>。`;
            },
            // 渲染反向估算结果 (新增)
            reverseResult: () => {
                if (!state.reverse.showResult) {
                    DOM.reverseCalorieResultDiv.style.display = 'none';
                    return;
                }
                const div = DOM.reverseCalorieResultDiv;
                div.style.display = 'block';
                div.innerHTML = `为了达到 <strong>${state.totalCalories} 千卡</strong>的每日总摄入量，<br>每顿需摄入约 <strong>${state.reverse.mealSize.toFixed(0)} 克</strong> 食物。<br>(每日总食物量约 ${state.reverse.totalFood.toFixed(0)} 克)`;
            },
            // 总渲染函数
            all: () => {
                Render.inputs();
                Render.proteinResult();
                Render.b12Result();
                Render.bmiResult();
                Render.energyResult();
                Render.calorieResult();
                Render.reverseResult();
            }
        };

        // 6. EVENT BINDING: 监听用户交互
        const bindEvents = () => {
            // 从 DOM 更新 State
            const updateStateFromDOM = () => {
                state.weight = parseFloat(DOM.weight.value) || 0;
                state.proteinStandard = parseFloat(DOM.proteinStandard.value) || 0;
                state.totalFood = parseFloat(DOM.totalFood.value) || 0;
                state.foodProteinRatio = parseFloat(DOM.foodProteinRatio.value) || 0;
                state.b12Standard = parseFloat(DOM.b12Standard.value) || 0;
                state.b12Intake = parseFloat(DOM.b12Intake.value) || 0;
                state.sideDish = DOM.sideDish.value;
                state.mealsPerDay = parseFloat(DOM.mealsPerDay.value) || 0;
                state.mealSize = parseFloat(DOM.mealSize.value) || 0;
                state.mainFood = DOM.mainFood.value;
                state.foodRatio = DOM.foodRatio.value;
                state.heightCm = parseFloat(DOM.heightCm.value) || 0;
                state.weightKg = parseFloat(DOM.weightKg.value) || 0;
                state.gender = DOM.gender.value;
                state.age = parseFloat(DOM.age.value) || 0;
                state.energyHeightCm = parseFloat(DOM.energyHeightCm.value) || 0;
                state.energyWeightKg = parseFloat(DOM.energyWeightKg.value) || 0;
                state.activityLevel = parseFloat(DOM.activityLevel.value) || 0;
                state.totalCalories = parseFloat(DOM.totalCalories.value) || 0;
                state.reverseMealsPerDay = parseFloat(DOM.reverseMealsPerDay.value) || 0;
                state.reverseMainFood = DOM.reverseMainFood.value;
                state.reverseSideDish = DOM.reverseSideDish.value;
                state.reverseFoodRatio = DOM.reverseFoodRatio.value;
            };

            // 绑定摄入估算按钮点击事件
            DOM.applyEstimatesBtn.addEventListener('click', () => {
                updateStateFromDOM();
                if (state.mealsPerDay <= 0 || state.mealSize <= 0) {
                    alert("请输入有效的餐数和每顿食量！");
                    return;
                }
                Logic.calculateAverageProteinRatio();
                Logic.calculateTotalCalories();
                Logic.calculateB12Intake();
                Logic.runProteinCalculation();
                Logic.runB12Calculation();
                state.protein.showResult = true;
                state.calories.showResult = true;
                state.b12.showResult = true;
                Render.all();
            });

            // 绑定主计算器按钮点击事件
            DOM.calculateProteinBtn.addEventListener('click', () => {
                updateStateFromDOM();
                if (state.weight <= 0) {
                    alert("请输入有效的体重！");
                    return;
                }
                Logic.runProteinCalculation();
                state.protein.showResult = true;
                Render.all();
            });

            // 绑定B12计算器按钮点击事件
            DOM.calculateB12Btn.addEventListener('click', () => {
                updateStateFromDOM();
                Logic.runB12Calculation();
                state.b12.showResult = true;
                Render.all();
            });

            // 绑定BMI计算器按钮点击事件
            DOM.calculateBmiBtn.addEventListener('click', () => {
                updateStateFromDOM();
                if (state.heightCm <= 0 || state.weightKg <= 0) {
                    alert("请输入有效的身高和体重！");
                    return;
                }
                Logic.runBmiCalculation();
                state.bmi.showResult = true;
                Render.all();
            });

            // 绑定能量计算器按钮点击事件
            DOM.calculateEnergyBtn.addEventListener('click', () => {
                updateStateFromDOM();
                if (state.age <= 0 || state.energyHeightCm <= 0 || state.energyWeightKg <= 0) {
                    alert("请输入所有有效参数（年龄、身高、体重）！");
                    return;
                }
                Logic.runEnergyCalculation();
                state.energy.showResult = true;
                Render.all();
            });

            // 新增：绑定反推按钮点击事件
            DOM.calculateReverseBtn.addEventListener('click', () => {
                updateStateFromDOM();
                if (state.totalCalories <= 0 || state.reverseMealsPerDay <= 0) {
                    alert("请输入有效的总卡路里和餐数！");
                    return;
                }
                Logic.reverseCalculate();
                state.reverse.showResult = true;
                Render.all();
            });

            // 弹窗功能绑定
            DOM.floatingBtn.addEventListener('click', () => {
                // 设置弹窗内容，注意保持换行
                DOM.modalText.textContent = `xlm：

我曾经一年吃纯素（也不吃鸡蛋），看着配料表：甚至酱油的配料表我都看。
当时平常一天两顿到两顿半，只吃土豆、米饭、酱油，有时候会少量加点配菜。

三个月后我开始头疼，过一段时间不再头疼了，一年后我开始出现以下问题：
1. 呼吸困难，具体来说，是吸气困难而不是吐气。甚至睡觉都要举着手睡，否则喘不上气。
2. 左胸附近不适，用了各种艾灸方式，烫的皮肤都是疤痕，后背全是疤痕，并没有效果。

两年后我出现以下问题：
1.经常内心恐慌不安
2.纠结细节难以自拔

然后我在某一天，喝了一些蛋白质，因为我比较敏感，直接改善了一些喜欢纠结的问题，但是恐慌还有。
又过了一年，恐慌严重了，经常晚上、甚至刚睡醒就难安，思维变得极端。

有一天我的母亲让我喝牛奶，说对身体好，我感觉到了什么，
便去网上搜索营养学相关知识。这才知道吃素最需要注意：
1.蛋白质
2.B12

于是我买了一罐臭豆腐，因为我还想保持吃素的习惯，我吃了大概不到半罐，情况好转一些。
加上当时几个月经常喝牛奶，已经基本好转了。

在这个过程中，以及我小时候的经验，我总结了以下几点：（现代人不缺水和碳水）

1. 首先最重要的就是蛋白质，防止纠结、防止思维陷入沉密（过于细密）的状态。
2. 然后就是B12、B9、B6等调节情绪的维生素。
3. 益生菌，益生菌有专门调节情绪的菌类，需要单独购买，有些帮助，我有感受。

4. 晒太阳帮助不大，我并非反对晒太阳，而是对情绪帮助不大，
   我推测可能是应该从小时候注意维生素D，而非成人后注意。

5. 其他科学理论建议（我暂时没有体验）：补充Omega-3、镁、钾、铁

这并不是说吃肉：蛋白质就不缺，
比如：一个人120斤，一天1个鸡蛋、300ml牛奶、一碟肉菜。够不够蛋白质？
不够，你仅仅摄入了30g蛋白质，就算我按0.66克/公斤的平均需求量，而不是0.8的推荐量来算：
你还差10g蛋白质，所以需要每日摄入蛋白质的计算，并做出调整，你才能改善自己。

这里我建议：多喝豆粉、维生素B族不要有缺口。

我崇敬的人曾经说过：
欲靠食物滋养，食素人宜多吃麦。
食麦之力，大于米力，不止数倍。光吃了面食，则精神健旺，气力充足，音声高大。
米则只可饱腹，无此效力。麦比参力，尚高数倍。
大磨麻油，亦补人。小磨麻油，以炒焦枯了，力道退半。人但知香，实则是焦味耳。
（黄豆豆油补料最多。宜常服之。见续编复鲍衡士书。）
莲子、桂圆、红枣、芡实、薏米，皆可滋补。岂必须血肉，方能滋补乎。总之皆不如麦之力大。

最后，希望这篇文章能够帮助到更多的人。
`;
                DOM.modal.style.display = "block";
            });

            DOM.closeBtn.addEventListener('click', () => {
                DOM.modal.style.display = "none";
            });

            window.addEventListener('click', (event) => {
                if (event.target == DOM.modal) {
                    DOM.modal.style.display = "none";
                }
            });
        };

        // 初始化函数
        function init() {
            console.log("Calculator Initialized.");
            bindEvents();
            // 页面加载时执行一次渲染，确保初始状态正确
            Render.all();
        }

        // 启动应用
        init();
    })();
</script>

</body>
</html>